<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peril Zone Calculator (Playground)</title>
  <style>
    :root { font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; background:#0f172a; color:#e2e8f0; }
    .wrap { max-width: 820px; margin: 40px auto; padding: 24px; background:#111827; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35);}
    h1,h2 { margin: 0 0 12px; }
    p { line-height: 1.5; }
    button { background:#22c55e; color:#0b1220; border:0; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    button.secondary { background:#334155; color:#e2e8f0; }
    input[type="number"]{ padding:8px; border-radius:8px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; width:200px;}
    label { display:block; margin:10px 0; }
    .row { margin: 12px 0; }
    .actions { display:flex; gap:10px; margin-top:16px;}
    .small { font-size: .9rem; color:#94a3b8; }
    pre { background:#0b1220; padding:12px; border-radius:12px; overflow:auto; }
    .note { background:#0b1220; border-left:4px solid #22c55e; padding:10px 12px; border-radius:8px; }
    .danger { background:#7f1d1d; color:#fee2e2; border:0; }
    /* Back button area inside the cute card */
    #nav { display:flex; gap:10px; margin: -4px 0 16px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="nav"></div>
    <div id="app"></div>
  </div>

  <script>
    // --- helpers (safe to keep) --------------------------------------------
    function num(id) {
      const v = Number(document.getElementById(id).value);
      return isNaN(v) || v < 0 ? 0 : v;
    }
    function nextOnce(el, handler) {
      el.addEventListener("click", handler, { once: true });
    }
    function resetApp() {
      showDisclaimer();
    }

    // === Frugal-but-Fun config + calculator ======================================
    const FUN = {
      meal: { sitAdult: 18, sitKid: 9, takeAdult: 10, takeKid: 6, takeoutsPerMonth: 4, taxTipFactor: 1.10 },
      outing: { adult: 12, kid: 10, perMonth: 1 },
      lessons: { perKid: 35, participatingShare: 0.5 },
      gym: { household: 20 },
      subsDefault: 25,               // used only if you don't provide an override
      allowancePerKidPerWeek: 2.5,   // ≈ $10/mo per kid
      visitsPerPersonPerMonth: 15,
      replace: { householdPerMonth: 10, perPersonPerMonth: 2 },
      gifts: { baseAnnual: 300, perKidAnnual: 50 },
      joyPerPersonPerMonth: 5,
      capAsPercentOfBareBones: 0.15, // cap extras to 15% of bare-bones
      floorHousehold: 40             // never less than $40 if any people > 0
    };
    
    // Optional: set these from your UI later if you like:
    // budget.frugalSubsOverride = 150;           // your real subs/memberships
    // budget.frugalAllowanceOverride = 45;       // kids' allowance total
    
    function computeFrugalFun(userInfo, budget, bareBonesMonthly){
      const members = Array.isArray(userInfo.members) ? userInfo.members : [];
      let A = 0, K = 0;
      for (const m of members){
        const age = Number(m.age) || 0;
        if (age >= 19) A++; else K++;
      }
      if (!A && !K) { // fallback if no member detail captured
        const size = Number(userInfo.familySize) || 1;
        // assume 1 adult + rest kids as a gentle default
        A = Math.min(1, size);
        K = Math.max(0, size - A);
      }
    
      // Eating out: 1 sit-down + ~4 takeouts / month (frugal pricing)
      const sit = FUN.meal.taxTipFactor * (A * FUN.meal.sitAdult + K * FUN.meal.sitKid);
      const take = FUN.meal.takeoutsPerMonth * (A * FUN.meal.takeAdult + K * FUN.meal.takeKid);
      const eatingOut = sit + take;
    
      // One paid outing per month
      const outing = FUN.outing.perMonth * (A * FUN.outing.adult + K * FUN.outing.kid);
    
      // Lessons + gym (half the kids on average)
      const kidsParticipating = Math.round(K * FUN.lessons.participatingShare);
      const lessons = kidsParticipating * FUN.lessons.perKid;
      const gym = FUN.gym.household;
    
      // Subscriptions / memberships
      const subs = Number.isFinite(budget.frugalSubsOverride) ? Number(budget.frugalSubsOverride) : FUN.subsDefault;
    
      // Allowance (use override if provided)
      const allowance = Number.isFinite(budget.frugalAllowanceOverride)
        ? Number(budget.frugalAllowanceOverride)
        : (K * FUN.allowancePerKidPerWeek * 52 / 12);
    
      // Visiting relatives / local trips
      const visits = (A + K) * FUN.visitsPerPersonPerMonth;
    
      // Replacement / refresh fund
      const replace = FUN.replace.householdPerMonth + (A + K) * FUN.replace.perPersonPerMonth;
    
      // Gifts / holidays sinking fund
      const gifts = (FUN.gifts.baseAnnual + K * FUN.gifts.perKidAnnual) / 12;
    
      // Joy buffer
      const joy = (A + K) * FUN.joyPerPersonPerMonth;
    
      const raw = eatingOut + outing + lessons + gym + subs + allowance + visits + replace + gifts + joy;
    
      // Safety rails
      const cap = Math.max(FUN.floorHousehold, FUN.capAsPercentOfBareBones * Math.max(0, bareBonesMonthly || 0));
      const frugalFun = Math.min(raw, cap);
    
      return {
        adults: A, kids: K,
        components: { eatingOut, outing, lessons, gym, subs, allowance, visits, replace, gifts, joy },
        raw, cap, frugalFun, usedCap: raw > cap
      };
    }

    // --- lightweight back stack (optional, used by wizard screens) ---------
    const stepStack = [];
    function pushStep(rerenderFn) { stepStack.push(rerenderFn); renderBack(); }
    function goBack() {
      if (stepStack.length <= 1) return;    // no back from first screen
      stepStack.pop();                       // remove current
      const prev = stepStack.at(-1);
      if (prev) prev();                      // re-render previous
      renderBack();
    }
    function renderBack() {
      const nav = document.getElementById("nav");
      nav.innerHTML = "";
      if (stepStack.length > 1) {
        const btn = document.createElement("button");
        btn.textContent = "← Back";
        btn.className = "secondary";
        btn.onclick = goBack;
        nav.appendChild(btn);
      }
    }

    // --- entry --------------------------------------------------------------
    const userInfo = {}; // extend later (family size, ages, etc.)
    showDisclaimer();

    function showDisclaimer() {
      const app = document.getElementById("app");
      document.getElementById("nav").innerHTML = ""; // no Back on disclaimer
      app.innerHTML = `
        <h1>Peril Zone Calculator</h1>
        <div class="note small">
          <strong>Disclaimer</strong><br>
          I acknowledge that this tool is intended for entertainment purposes only and is not a definitive financial guide.
          Any guidance from this tool is a brainstorming starting point and must be verified before making big life decisions.
          Parameters and programs change frequently; many programs also have additional eligibility rules not covered here.
          Please verify all details independently.
          <br><br><em>Ohio-only for now.</em>
        </div>
        <div class="row">
          <label><input type="checkbox" id="agree"> I have read this information and agree.</label>
        </div>
        <div class="actions">
          <button id="continue" class="primary">Continue</button>
          <button id="reset" class="secondary">Reset</button>
        </div>
      `;
      nextOnce(document.getElementById("continue"), () => {
        const ok = document.getElementById("agree").checked;
        if (!ok) { alert("Please check the agreement to continue."); return showDisclaimer(); }
        // Start your wizard (defined in your separate script)
        if (typeof startFamilyInfoStep === "function") {
          startFamilyInfoStep(userInfo);
        } else {
          alert("startFamilyInfoStep() is not loaded yet.");
        }
      });
      nextOnce(document.getElementById("reset"), resetApp);
    }

    // --- Family info pre-step ---------------------------------------------------
    function startFamilyInfoStep(userInfo) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Family Setup</h2>
        <label>Family size (people living in the household):
          <input type="number" id="famSize" min="1" step="1">
        </label>
        <div class="row"></div>
        <button id="famNext" class="primary">Next</button>
      `;
      pushStep(() => startFamilyInfoStep(userInfo));
    
      document.getElementById("famNext").addEventListener("click", () => {
        const n = parseInt(document.getElementById("famSize").value, 10);
        if (!Number.isInteger(n) || n < 1) { alert("Please enter a valid family size (at least 1)."); return; }
        userInfo.familySize = n;
        userInfo.members = [];
        collectMemberInfo(userInfo, 0);
      }, { once: true });
    }
    
    function collectMemberInfo(userInfo, idx) {
      const total = userInfo.familySize || 0;
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Member ${idx + 1} of ${total}</h2>
        <div class="grid">
          <label>Age (years): <input type="number" id="age" min="0" step="1"></label>
          <label><input type="checkbox" id="pregnant"> Pregnant</label>
        </div>
        <div class="row"></div>
        <button id="memberNext" class="primary">Next</button>
      `;
      pushStep(() => collectMemberInfo(userInfo, idx));
    
      document.getElementById("memberNext").addEventListener("click", () => {
        const age = parseInt(document.getElementById("age").value, 10);
        if (!Number.isInteger(age) || age < 0) { alert("Enter a valid non-negative age."); return; }
        const pregnant = !!document.getElementById("pregnant").checked;
        userInfo.members[idx] = { age, pregnant };
    
        if (idx + 1 < total) {
          collectMemberInfo(userInfo, idx + 1);
        } else {
          askHouseholdDisability(userInfo);
        }
      }, { once: true });
    }
    
    function askHouseholdDisability(userInfo) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Disability Status</h2>
        <p>Is anyone in the household recognized by the state as having a disability?</p>
        <button id="disYes" class="primary">Yes</button>
        <button id="disNo">No</button>
      `;
      pushStep(() => askHouseholdDisability(userInfo));
    
      document.getElementById("disYes").addEventListener("click", () => {
        userInfo.hasStateRecognizedDisability = true;
        startBudgetWizard(userInfo);
      }, { once: true });
    
      document.getElementById("disNo").addEventListener("click", () => {
        userInfo.hasStateRecognizedDisability = false;
        startBudgetWizard(userInfo);
      }, { once: true });
    }

    // ====== TAX/NET HELPERS (ANNUAL) ======
    // 2025 rough standard deductions (simplified)
    const STD_DED_2025 = { single: 14600, hoh: 22050, married: 29200 };
    
    // Simplified 2025 federal brackets (trimmed for this app). Add others if you like.
    const FED_BRACKETS_2025 = {
      single: [
        { upTo: 11600, rate: 0.10 },
        { upTo: 47150, rate: 0.12 },
        { upTo: 100525, rate: 0.22 },
        { upTo: 191950, rate: 0.24 },
        { upTo: Infinity, rate: 0.32 }
      ],
      hoh: [
        { upTo: 16850, rate: 0.10 },
        { upTo: 64100, rate: 0.12 },
        { upTo: 102750, rate: 0.22 },
        { upTo: 197300, rate: 0.24 },
        { upTo: Infinity, rate: 0.32 }
      ],
      married: [
        { upTo: 23200, rate: 0.10 },
        { upTo: 94300, rate: 0.12 },
        { upTo: 201050, rate: 0.22 },
        { upTo: 383900, rate: 0.24 },
        { upTo: Infinity, rate: 0.32 }
      ]
    };
    
    // Simplified OH state withholding (progressive but coarse for UX)
    function ohioStateTax(gross) {
      if (gross <= 26000) return gross * 0.019;
      if (gross <= 115000) return gross * 0.0275;
      return gross * 0.032;
    }
    
    function federalTax(gross, filingStatus) {
      const std = STD_DED_2025[filingStatus] ?? STD_DED_2025.hoh;
      const taxable = Math.max(0, gross - std);
      const brackets = FED_BRACKETS_2025[filingStatus] ?? FED_BRACKETS_2025.hoh;
      let tax = 0, prev = 0, remaining = taxable;
    
      for (const b of brackets) {
        const band = Math.min(remaining, b.upTo - prev);
        if (band > 0) {
          tax += band * b.rate;
          remaining -= band;
          prev = b.upTo;
        }
        if (remaining <= 0) break;
      }
      return tax;
    }
    
    function calcAnnualNet(grossAnnual, { filingStatus = 'hoh', cityRate = 0.02, retirePct = 0.05 } = {}) {
      // Payroll
      const ssTax = Math.min(grossAnnual, 168600) * 0.062;   // Social Security
      const medicareTax = grossAnnual * 0.0145;              // Medicare (no surtax for now)
    
      // Income taxes
      const fed = federalTax(grossAnnual, filingStatus);
      const state = ohioStateTax(grossAnnual);
      const local = grossAnnual * Math.max(0, Math.min(0.035, cityRate)); // clamp 0–3.5%
    
      // “Typical” mandatory retirement if ≥ 30k
      const retirement = grossAnnual >= 30000 ? grossAnnual * retirePct : 0;
    
      const totalWithheld = fed + ssTax + medicareTax + state + local + retirement;
      const netAnnual = Math.max(0, grossAnnual - totalWithheld);
    
      return {
        grossAnnual, netAnnual,
        components: { fed, ssTax, medicareTax, state, local, retirement }
      };
    }


    // ========== Budget Wizard ==========
    function startBudgetWizard(userInfo) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Budget Setup</h2>
        <p>Would you like to enter your monthly budget manually or walk through each category?</p>
        <button id="manual" class="primary">I already know my monthly minimum budget</button>
        <button id="guided">Walk me through each category</button>
      `;
      // record this screen for Back
      pushStep(() => startBudgetWizard(userInfo));

      const budget = {};

      document.getElementById("manual").addEventListener("click", () => {
        renderManualBudget(userInfo, budget);
      });

      document.getElementById("guided").addEventListener("click", () => {
        startHousingStep(userInfo, budget);
      });
    }

    // Manual route
    function renderManualBudget(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Manual Monthly Budget</h2>
        <label>Enter your total minimum monthly survival-mode budget:
          $<input type="number" id="manualBudget" min="0" step="0.01">
        </label>
        <div class="row"></div>
        <button id="submitManualBudget" class="primary">Continue</button>
      `;
      pushStep(() => renderManualBudget(userInfo, budget));
    
      document.getElementById("submitManualBudget").addEventListener("click", () => {
        const bare = Number(document.getElementById("manualBudget").value) || 0;
    
        // Keep naming consistent with guided path
        budget.totalMonthlyExpenses = bare;
        budget._bareBonesMonthly = bare;
    
        // Compute frugal-but-fun add-on so later views have consistent inputs
        const funCalc = computeFrugalFun(userInfo, budget, bare);
        budget.frugalFunMonthly   = Number(funCalc.frugalFun.toFixed(2));
        budget.frugalFunRaw       = Number(funCalc.raw.toFixed(2));
        budget.frugalFunCap       = Number(funCalc.cap.toFixed(2));
        budget.frugalFunCapped    = !!funCalc.usedCap;
        budget._funBreakdown      = funCalc.components;
        budget.totalMonthlyFrugal = Number((bare + funCalc.frugalFun).toFixed(2));
    
        // Show summary
        showBudgetSummary(userInfo, budget, /*cameFromManual*/true);
      }, { once:true });
    }

    // Guided route
    
    // ========== Housing ==========
    function startHousingStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Housing Costs</h2>
        <p>Do you own or rent your home?</p>
        <button id="own">Own</button>
        <button id="rent">Rent</button>
      `;
      pushStep(() => startHousingStep(userInfo, budget));

    document.getElementById("own").addEventListener("click", () => {
      userInfo.ownsHome = true;   // set homeowner flag
      askHousingAmount(true, userInfo, budget);
    });
    document.getElementById("rent").addEventListener("click", () => {
      userInfo.ownsHome = false;  // set renter flag
      askHousingAmount(false, userInfo, budget);
    });
    }
    
    function askHousingAmount(ownsHome, userInfo, budget) {
      const app = document.getElementById("app");
      const promptText = ownsHome
        ? "How much do you pay each month in total for your mortgage, including taxes, insurance, and HOA fees?"
        : "What is your total monthly rent including rental insurance or pet fees (but not utilities unless part of the rent)?";

      app.innerHTML = `
        <h2>Monthly Housing Cost</h2>
        <p>${promptText}</p>
        $<input type="number" id="housingCost" min="0" step="0.01" />
        <div class="row"></div>
        <button id="next" class="primary">Next</button>
      `;
      pushStep(() => askHousingAmount(ownsHome, userInfo, budget));

      document.getElementById("next").addEventListener("click", () => {
        budget.monthlyHousing = Number(document.getElementById("housingCost").value) || 0;
        startUtilitiesStep(userInfo, budget);
      }, { once:true });
    }

    // ========== Utilities (Budget Wizard) ==========
    
    function startUtilitiesStep(userInfo, budget) {
      const app = document.getElementById("app");
    
      // restore prior values if user goes back
      const prior = budget.totals?.utilities || {};
      const priorPipp = budget.benefits?.pipp || {};
    
      const willingDefault = priorPipp.willingToApply ?? true;
      const waterDefault = prior.water ?? 0;
      const trashDefault = prior.trash ?? 0;
      const elecDefault  = prior.electric ?? 0;
      const gasDefault   = prior.gas ?? 0;
    
      app.innerHTML = `
        <h2>Utilities</h2>
    
        <label style="display:block;margin-bottom:.5rem;">
          <input id="pippWilling" type="checkbox" ${willingDefault ? 'checked' : ''}>
          Are you willing to apply for PIPP?
        </label>
        <p id="pippNote" class="muted" style="margin-top:-.25rem;margin-bottom:.75rem;">
          If checked, we’ll set Electric and Gas to $0 for now and calculate them in the Benefits Wizard.
          You’ll still enter Water and Trash/Sewer here.
        </p>
    
        <div class="grid">
          <label>Electricity: $
            <input type="number" id="elecCost" min="0" step="0.01" value="${elecDefault}">
          </label>
          <label>Gas: $
            <input type="number" id="gasCost" min="0" step="0.01" value="${gasDefault}">
          </label>
          <label>Water: $
            <input type="number" id="waterCost" min="0" step="0.01" value="${waterDefault}">
          </label>
          <label>Trash/Sewer: $
            <input type="number" id="trashCost" min="0" step="0.01" value="${trashDefault}">
          </label>
        </div>
    
        <div class="row"></div>
        <button id="next" class="primary">Next</button>
      `;
    
      const $willing = document.getElementById("pippWilling");
      const $elec    = document.getElementById("elecCost");
      const $gas     = document.getElementById("gasCost");
    
      // lock/unlock elec/gas when willing to apply
      function syncPippUI() {
        const willing = $willing.checked;
        if (willing) {
          $elec.value = "0";
          $gas.value  = "0";
          $elec.disabled = true;
          $gas.disabled  = true;
        } else {
          $elec.disabled = false;
          $gas.disabled  = false;
        }
      }
      $willing.addEventListener("change", syncPippUI);
      syncPippUI();
    
      pushStep(() => startUtilitiesStep(userInfo, budget));
    
      document.getElementById("next").addEventListener("click", () => {
        const willing = $willing.checked;
    
        const elec  = Number($elec.value)  || 0;
        const gas   = Number($gas.value)   || 0;
        const water = Number(document.getElementById("waterCost").value) || 0;
        const trash = Number(document.getElementById("trashCost").value) || 0;
    
        // Store PIPP willingness for Benefits Wizard
        budget.benefits = budget.benefits || {};
        budget.benefits.pipp = {
          ...(budget.benefits.pipp || {}),
          willingToApply: willing
        };
    
        // Keep raw entries (for reference + for "not willing" final path)
        budget.totals = budget.totals || {};
        budget.totals.utilities = { electric: elec, gas, water, trash };
    
        // BARE-BONES total:
        // - willing: water + trash
        // - not willing: water + trash + elec + gas
        const bareBones = willing ? (water + trash) : (water + trash + elec + gas);
        budget.totals.utilitiesBare = {
          water, trash,
          electric: willing ? 0 : elec,
          gas:      willing ? 0 : gas
        };
        budget.totals.utilitiesBareTotal = +bareBones.toFixed(2);
    
        // Legacy compatibility for anything still reading utilityCost
        budget.utilityCost = budget.totals.utilitiesBareTotal;
    
        // go to next Budget step
        startConnectivityStep(userInfo, budget);
      }, { once:true });
    }



    // ========== Connectivity ==========
    
    function startConnectivityStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Phone & Internet</h2>
        <div class="grid">
          <label>Phone: $<input type="number" id="phoneCost" min="0" step="0.01"></label>
          <label>Internet: $<input type="number" id="internetCost" min="0" step="0.01"></label>
        </div>
        <div class="row"></div>
        <button id="next" class="primary">Next</button>
      `;
      pushStep(() => startConnectivityStep(userInfo, budget));

      document.getElementById("next").addEventListener("click", () => {
        const phone = Number(document.getElementById("phoneCost").value) || 0;
        const internet = Number(document.getElementById("internetCost").value) || 0;
        budget.connectCost = phone + internet;
        startTransportationStep(userInfo, budget);
      }, { once:true });
    }

    // ========== Transportation ==========
    
    function startTransportationStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Transportation</h2>
        <p>Do you have a car?</p>
        <button id="hasCar">Yes</button>
        <button id="noCar">No</button>
      `;
      pushStep(() => startTransportationStep(userInfo, budget));

      document.getElementById("hasCar").addEventListener("click", () => {
        askCarOwnership(userInfo, budget);
      });
      document.getElementById("noCar").addEventListener("click", () => {
        askPublicTransport(userInfo, budget, false, 0);
      });
    }

    function askCarOwnership(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Car Details</h2>
        <p>Do you fully own your car (no monthly payments)?</p>
        <button id="ownsCar">Yes</button>
        <button id="leasesCar">No</button>
      `;
      pushStep(() => askCarOwnership(userInfo, budget));

      document.getElementById("ownsCar").addEventListener("click", () => {
        askCarCosts(userInfo, budget, 0);
      });
      document.getElementById("leasesCar").addEventListener("click", () => {
        askCarPayment(userInfo, budget);
      });
    }

    function askCarPayment(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Monthly Car Payment</h2>
        <label>Amount: $<input type="number" id="carPayment" min="0" step="0.01"></label>
        <div class="row"></div>
        <button id="next" class="primary">Next</button>
      `;
      pushStep(() => askCarPayment(userInfo, budget));

      document.getElementById("next").addEventListener("click", () => {
        const payment = Number(document.getElementById("carPayment").value) || 0;
        askCarCosts(userInfo, budget, payment);
      }, { once:true });
    }

    function askCarCosts(userInfo, budget, carPayment) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Car Costs</h2>
        <div class="grid">
          <label>Insurance: $<input type="number" id="carInsurance" min="0" step="0.01"></label>
          <label>Gas (Monthly): $<input type="number" id="carGas" min="0" step="0.01"></label>
          <label>Maintenance (Yearly): $<input type="number" id="carMaint" min="0" step="0.01"></label>
        </div>
        <div class="note small">
            Note: Average car maintenance, repairs and registration for cars in Ohio tend to be between $350–$1500 per year, depending on the age and condition of the car.
        </div>
        <div class="row"></div>
        <button id="next" class="primary">Next</button>
      `;
      pushStep(() => askCarCosts(userInfo, budget, carPayment));

      document.getElementById("next").addEventListener("click", () => {
        const insurance = Number(document.getElementById("carInsurance").value) || 0;
        const gas = Number(document.getElementById("carGas").value) || 0;
        const maint = Number(document.getElementById("carMaint").value) || 0;
        budget.totalTransCost = (budget.totalTransCost || 0);
        budget.totalTransCost += carPayment + insurance + gas + (maint / 12);
        askPublicTransport(userInfo, budget, true, 0);
      }, { once:true });
    }

    function askPublicTransport(userInfo, budget, hasCar, alreadyAdded) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Other Transportation</h2>
        <div class="grid">
          <label>Bus Pass (Monthly): $<input type="number" id="busPass" min="0" step="0.01"></label>
          <label>Rideshare (Monthly): $<input type="number" id="rideShare" min="0" step="0.01"></label>
        </div>
        <div class="row"></div>
        <button id="next" class="primary">Next</button>
      `;
      pushStep(() => askPublicTransport(userInfo, budget, hasCar, alreadyAdded));

      document.getElementById("next").addEventListener("click", () => {
        const bus = Number(document.getElementById("busPass").value) || 0;
        const ride = Number(document.getElementById("rideShare").value) || 0;
        budget.totalTransCost = (budget.totalTransCost || 0) + bus + ride;
        startFoodStep(userInfo, budget);
      }, { once:true });
    }

    // --- Food cost estimation (bare-bones monthly) ---
    const BASE_COSTS = {
      baby:       111, // 0–1
      toddler:    167, // 2–3
      youngchild: 183, // 4–5
      midchild:   203, // 6–8
      oldchild:   200, // 9–11
      tween:      217, // 12–13
      teenUp:     300  // 14+
    };
    
    function costByAge(ageYears) {
      if (ageYears < 1) return BASE_COSTS.baby;
      if (ageYears <= 3) return BASE_COSTS.toddler;
      if (ageYears <= 5) return BASE_COSTS.youngchild;
      if (ageYears <= 8) return BASE_COSTS.midchild;
      if (ageYears <= 11) return BASE_COSTS.oldchild;
      if (ageYears <= 13) return BASE_COSTS.tween;
      return BASE_COSTS.teenUp;
    }
    
    function estimateBareBonesFoodBudget(agesArray) {
      return agesArray.reduce((sum, yrs) => sum + costByAge(yrs), 0);
    }
    
    // ========== Food ==========
    function startFoodStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Food Budget</h2>
        <p>Enter monthly amount or let us estimate.</p>
        <button id="foodManual">Enter Manually</button>
        <button id="foodHelp">Help me estimate</button>
      `;
      pushStep(() => startFoodStep(userInfo, budget));
    
      // Manual entry path
      document.getElementById("foodManual").addEventListener("click", () => {
        app.innerHTML = `
          <h2>Monthly Food Budget</h2>
          $<input type="number" id="foodCost" min="0" step="0.01">
          <div class="row"></div>
          <button id="next" class="primary">Next</button>
        `;
        // Revisit this exact screen when using Back
    pushStep(() => document.getElementById("foodManual").click());
    
        document.getElementById("next").addEventListener("click", () => {
          budget.totalFood = Number(document.getElementById("foodCost").value) || 0;
          startHouseholdGoodsStep(userInfo, budget);
        }, { once:true });
      }, { once:true });
    
      // Helper/estimate path
    document.getElementById("foodHelp").addEventListener("click", () => {
      if (!userInfo.members || !userInfo.members.length) {
        alert("Family info missing — please restart and enter family details.");
        budget.totalFood = 0;
        startHouseholdGoodsStep(userInfo, budget);
        return;
      }
      renderFoodEstimateReview(userInfo, budget);
    }, { once:true });

    }

    function renderFoodEstimateReview(userInfo, budget) {
      const app = document.getElementById("app");
    
      // Build buckets matching your current costByAge bands
      const buckets = [
        { id: 'baby',       label: 'Baby (<1)',            per: BASE_COSTS.baby,       test: a => a < 1 },
        { id: 'toddler',    label: 'Toddler (1–3)',        per: BASE_COSTS.toddler,    test: a => a >= 1 && a <= 3 },
        { id: 'youngchild', label: 'Young child (4–5)',    per: BASE_COSTS.youngchild, test: a => a >= 4 && a <= 5 },
        { id: 'midchild',   label: 'Child (6–8)',          per: BASE_COSTS.midchild,   test: a => a >= 6 && a <= 8 },
        { id: 'oldchild',   label: 'Pre-teen (9–11)',      per: BASE_COSTS.oldchild,   test: a => a >= 9 && a <= 11 },
        { id: 'tween',      label: 'Tween (12–13)',        per: BASE_COSTS.tween,      test: a => a >= 12 && a <= 13 },
        { id: 'teenUp',     label: 'Teen/Adult (14+)',     per: BASE_COSTS.teenUp,     test: a => a >= 14 }
      ];
    
      const members = Array.isArray(userInfo.members) ? userInfo.members : [];
      const rows = buckets.map(b => ({ ...b, count: 0, subtotal: 0 }));
    
      for (const m of members) {
        const age = Number(m.age) || 0;
        const b = rows.find(r => r.test(age));
        if (b) { b.count += 1; b.subtotal += b.per; }
      }
    
      const shown = rows.filter(r => r.count > 0);
      const estimated = shown.reduce((s, r) => s + r.subtotal, 0);
    
      app.innerHTML = `
        <h2>Food Estimate — Review</h2>
        <p>Here’s how we got your <strong>bare-bones monthly food estimate</strong> based on ages in your household.</p>
    
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:6px;">Group</th>
              <th style="text-align:right; padding:6px;">Count</th>
              <th style="text-align:right; padding:6px;">$/person (mo)</th>
              <th style="text-align:right; padding:6px;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            ${shown.map(r => `
              <tr>
                <td style="padding:6px;">${r.label}</td>
                <td style="padding:6px; text-align:right;">${r.count}</td>
                <td style="padding:6px; text-align:right;">$${r.per.toFixed(0)}</td>
                <td style="padding:6px; text-align:right;">$${r.subtotal.toFixed(0)}</td>
              </tr>
            `).join('')}
            <tr>
              <td colspan="3" style="padding:6px; text-align:right;"><strong>Total estimate</strong></td>
              <td style="padding:6px; text-align:right;"><strong>$${estimated.toFixed(2)}</strong></td>
            </tr>
          </tbody>
        </table>
    
        <div class="row"></div>
        <div class="note small">
          Assumptions: “bare-bones” groceries (no dining out), age-based amounts, and no program offsets yet.
          Pregnancy isn’t added here (WIC/other savings are considered later in the Benefits Wizard).
        </div>
    
        <div class="row"></div>
        <div class="actions">
          <button id="foodAccept" class="primary">This looks good</button>
          <button id="foodOverride">Let me enter my own</button>
        </div>
      `;
      pushStep(() => renderFoodEstimateReview(userInfo, budget));
    
      document.getElementById("foodAccept").addEventListener("click", () => {
        budget.totalFood = Number(estimated.toFixed(2));
        startHouseholdGoodsStep(userInfo, budget);
      }, { once:true });
    
      document.getElementById("foodOverride").addEventListener("click", () => {
        renderFoodManual(userInfo, budget, estimated);
      }, { once:true });
    }
    
    function renderFoodManual(userInfo, budget, suggested) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Monthly Food Budget</h2>
        <label>After reviewing, enter your own monthly estimate:
          $<input type="number" id="foodCost" min="0" step="0.01" value="${(suggested || 0).toFixed(2)}">
        </label>
        <div class="row"></div>
        <div class="actions">
          <button id="foodManualNext" class="primary">Use this amount</button>
          <button id="foodManualBack" class="secondary">Back</button>
        </div>
      `;
      pushStep(() => renderFoodManual(userInfo, budget, suggested));
    
      document.getElementById("foodManualNext").addEventListener("click", () => {
        const v = Number(document.getElementById("foodCost").value);
        if (isNaN(v) || v < 0) { alert("Please enter a valid non-negative number."); return; }
        budget.totalFood = v;
        startHouseholdGoodsStep(userInfo, budget);
      }, { once:true });
    
      document.getElementById("foodManualBack").addEventListener("click", () => {
        renderFoodEstimateReview(userInfo, budget);
      }, { once:true });
    }


    // ========== Household ==========
    function startHouseholdGoodsStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Household Items Budget</h2>
        <p>Enter monthly amount or let us estimate.</p>
        <button id="goodsManual">Enter Manually</button>
        <button id="goodsHelp">Help me estimate</button>
      `;
      pushStep(() => startHouseholdGoodsStep(userInfo, budget));

      document.getElementById("goodsManual").addEventListener("click", () => {
        app.innerHTML = `
          <h2>Monthly Household Items</h2>
          $<input type="number" id="goodsCost" min="0" step="0.01">
          <div class="row"></div>
          <button id="next" class="primary">Next</button>
        `;
        pushStep(() => document.getElementById("goodsManual").click());
        document.getElementById("next").addEventListener("click", () => {
          budget.totalGoods = Number(document.getElementById("goodsCost").value) || 0;
          startChildcareStep(userInfo, budget);
        }, { once:true });
      });

        document.getElementById("goodsHelp").addEventListener("click", () => {
          if (!userInfo.members || !userInfo.members.length) {
            alert("Family info missing — please restart and enter family details.");
            budget.totalGoods = 0;
            startChildcareStep(userInfo, budget);
            return;
          }
          renderGoodsEstimateReview(userInfo, budget);
        }, { once:true });
    }

    function renderGoodsEstimateReview(userInfo, budget) {
      const app = document.getElementById("app");
    
      // Same factors you already use:
      const baseCost = 90;
      const adultFactor = 15;      // age >= 13
      const childFactor = 10;      // 4–12
      const babyFactor = 55;       // < 3 (diapers)
      const pregnancyFactor = 55;  // per pregnant person
    
      const members = Array.isArray(userInfo.members) ? userInfo.members : [];
    
      let adults = 0, children = 0, babies = 0, pregnancies = 0;
      for (const m of members) {
        const age = Number(m.age) || 0;
        if (age >= 13) adults += 1;
        else if (age >= 4 && age <= 12) children += 1;
        else if (age < 3) babies += 1;
        if (m.pregnant) pregnancies += 1;
      }
    
      const lineBase   = baseCost;
      const lineAdults = adults * adultFactor;
      const lineKids   = children * childFactor;
      const lineBabies = babies * babyFactor;
      const linePreg   = pregnancies * pregnancyFactor;
    
      const total = lineBase + lineAdults + lineKids + lineBabies + linePreg;
    
      app.innerHTML = `
        <h2>Household Items — Review</h2>
        <p>Here’s how we built your <strong>bare-bones monthly household items estimate</strong>
           (cleaners, paper goods, diapers, basic hygiene, etc.).</p>
    
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:6px;">Component</th>
              <th style="text-align:right; padding:6px;">Qty</th>
              <th style="text-align:right; padding:6px;">$/unit (mo)</th>
              <th style="text-align:right; padding:6px;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding:6px;">Base household starter</td>
              <td style="padding:6px; text-align:right;">—</td>
              <td style="padding:6px; text-align:right;">$${baseCost.toFixed(0)}</td>
              <td style="padding:6px; text-align:right;">$${lineBase.toFixed(0)}</td>
            </tr>
            ${adults ? `
              <tr>
                <td style="padding:6px;">Adults/teens (13+)</td>
                <td style="padding:6px; text-align:right;">${adults}</td>
                <td style="padding:6px; text-align:right;">$${adultFactor.toFixed(0)}</td>
                <td style="padding:6px; text-align:right;">$${lineAdults.toFixed(0)}</td>
              </tr>` : '' }
            ${children ? `
              <tr>
                <td style="padding:6px;">Children (4–12)</td>
                <td style="padding:6px; text-align:right;">${children}</td>
                <td style="padding:6px; text-align:right;">$${childFactor.toFixed(0)}</td>
                <td style="padding:6px; text-align:right;">$${lineKids.toFixed(0)}</td>
              </tr>` : '' }
            ${babies ? `
              <tr>
                <td style="padding:6px;">Babies/toddlers in diapers (<3)</td>
                <td style="padding:6px; text-align:right;">${babies}</td>
                <td style="padding:6px; text-align:right;">$${babyFactor.toFixed(0)}</td>
                <td style="padding:6px; text-align:right;">$${lineBabies.toFixed(0)}</td>
              </tr>` : '' }
            ${pregnancies ? `
              <tr>
                <td style="padding:6px;">Pregnancy adjustment</td>
                <td style="padding:6px; text-align:right;">${pregnancies}</td>
                <td style="padding:6px; text-align:right;">$${pregnancyFactor.toFixed(0)}</td>
                <td style="padding:6px; text-align:right;">$${linePreg.toFixed(0)}</td>
              </tr>` : '' }
            <tr>
              <td colspan="3" style="padding:6px; text-align:right;"><strong>Total estimate</strong></td>
              <td style="padding:6px; text-align:right;"><strong>$${total.toFixed(2)}</strong></td>
            </tr>
          </tbody>
        </table>
    
        <div class="row"></div>
        <div class="note small">
          Assumptions: basic, no-frills supplies; diapers counted for <3; pregnancy bump covers vitamins and added hygiene items.
          You can accept this estimate or enter your own after considering it.
        </div>
    
        <div class="row"></div>
        <div class="actions">
          <button id="goodsAccept" class="primary">This looks good</button>
          <button id="goodsOverride">Let me enter my own</button>
        </div>
      `;
      pushStep(() => renderGoodsEstimateReview(userInfo, budget));
    
      document.getElementById("goodsAccept").addEventListener("click", () => {
        budget.totalGoods = Number(total.toFixed(2));
        startChildcareStep(userInfo, budget);
      }, { once:true });
    
      document.getElementById("goodsOverride").addEventListener("click", () => {
        renderGoodsManual(userInfo, budget, total);
      }, { once:true });
    }
    
    function renderGoodsManual(userInfo, budget, suggested) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Monthly Household Items</h2>
        <label>After reviewing, enter your own monthly estimate:
          $<input type="number" id="goodsCost" min="0" step="0.01" value="${(suggested || 0).toFixed(2)}">
        </label>
        <div class="row"></div>
        <div class="actions">
          <button id="goodsManualNext" class="primary">Use this amount</button>
          <button id="goodsManualBack" class="secondary">Back</button>
        </div>
      `;
      pushStep(() => renderGoodsManual(userInfo, budget, suggested));
    
      document.getElementById("goodsManualNext").addEventListener("click", () => {
        const v = Number(document.getElementById("goodsCost").value);
        if (isNaN(v) || v < 0) { alert("Please enter a valid non-negative number."); return; }
        budget.totalGoods = v;
        startChildcareStep(userInfo, budget);
      }, { once:true });
    
      document.getElementById("goodsManualBack").addEventListener("click", () => {
        renderGoodsEstimateReview(userInfo, budget);
      }, { once:true });
    }

    // ========== Childcare ==========
    function startChildcareStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Childcare Costs</h2>
        <p>Do you currently have or are you willing to apply for childcare assistance?</p>
        <button id="ccYes" class="primary">Yes</button>
        <button id="ccNo">No</button>
      `;
      // allow Back to return to this question
      pushStep(() => startChildcareStep(userInfo, budget));
    
      // YES → $0 now; Benefits Wizard will decide later
      document.getElementById("ccYes").addEventListener("click", () => {
        budget.usingChildcareSubsidy = true;
        budget.childcareCost = 0;
        alert("Childcare cost will be assessed in the Benefits Wizard.");
        startTuitionStep(userInfo, budget);
      }, { once: true });
    
      // NO → ask for monthly out-of-pocket
      document.getElementById("ccNo").addEventListener("click", () => {
        budget.usingChildcareSubsidy = false;
        app.innerHTML = `
          <h2>Childcare Costs</h2>
          <label>Total monthly childcare cost:
            $<input type="number" id="childcareMonthly" min="0" step="0.01">
          </label>
          <div class="row"></div>
          <button id="ccNext" class="primary">Next</button>
        `;
        // Back from this screen should return here
        pushStep(() => document.getElementById("ccNo").click());
    
        document.getElementById("ccNext").addEventListener("click", () => {
          const val = Number(document.getElementById("childcareMonthly").value);
          if (isNaN(val) || val < 0) { alert("Please enter a valid non-negative number."); return; }
          budget.childcareCost = val;
          askChildTuition(userInfo, budget);
        }, { once: true });
      }, { once: true });
    }

    // ========== Tuition wrapper (adult first, then child) ==========
    function startTuitionStep(userInfo, budget) {
      askAdultTuition(userInfo, budget);
    }
    
    // Ask if any adult pays out-of-pocket tuition, then go to child tuition
    function askAdultTuition(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Adult Tuition</h2>
        <p>Do you (or another adult in your household) currently pay any <strong>out-of-pocket tuition</strong> for college or training?</p>
        <button id="adultTuitionYes" class="primary">Yes</button>
        <button id="adultTuitionNo">No</button>
      `;
      pushStep(() => askAdultTuition(userInfo, budget));
    
      // YES → collect yearly, store monthly, then move on to child tuition
      document.getElementById("adultTuitionYes").addEventListener("click", () => {
        app.innerHTML = `
          <h2>Adult Tuition — Yearly</h2>
          <label>$<input type="number" id="adultTuitionYear" min="0" step="0.01"></label>
          <div class="row"></div>
          <button id="adultTuitionNext" class="primary">Next</button>
        `;
        pushStep(() => document.getElementById("adultTuitionYes").click());
    
        document.getElementById("adultTuitionNext").addEventListener("click", () => {
          const y = Number(document.getElementById("adultTuitionYear").value) || 0;
          budget.adultTuition = y / 12;       // store monthly
          askChildTuition(userInfo, budget);  // continue
        }, { once:true });
      }, { once:true });
    
      // NO → set to 0 and continue
      document.getElementById("adultTuitionNo").addEventListener("click", () => {
        budget.adultTuition = 0;
        askChildTuition(userInfo, budget);
      }, { once:true });
    }


    // ========== Child Tuition ==========
    function askChildTuition(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Child Tuition</h2>
        <p>Do any of your children attend a school that <strong>charges tuition</strong>?</p>
        <button id="childTuitionYes" class="primary">Yes</button>
        <button id="childTuitionNo">No</button>
      `;
      pushStep(() => askChildTuition(userInfo, budget));
    
      // If school(s) charge tuition, ask about EdChoice next
      document.getElementById("childTuitionYes").addEventListener("click", () => {
        app.innerHTML = `
          <h2>EdChoice Scholarship</h2>
          <p>Will you be applying for the <strong>EdChoice</strong> scholarship?</p>
          <button id="edYes" class="primary">Yes</button>
          <button id="edNo">No</button>
        `;
        pushStep(() => document.getElementById("childTuitionYes").click());
    
        // Applying for EdChoice → tuition handled later by benefits wizard
        document.getElementById("edYes").addEventListener("click", () => {
          alert("We'll calculate your out-of-pocket cost during the EdChoice step in the Benefits Wizard.");
          budget.usingEdChoice = true;
          budget.kidsTuition = 0; // monthly; Benefits Wizard will calculate
          askChildSchoolFees(userInfo, budget);
        }, { once: true });

    
        // Not applying → collect yearly tuition now
        document.getElementById("edNo").addEventListener("click", () => {
          budget.usingEdChoice = false;
          app.innerHTML = `
            <h2>Total Yearly Tuition (All Children)</h2>
            <label>$<input type="number" id="kidsTuitionYear" min="0" step="0.01"></label>
            <div class="row"></div>
            <button id="nextTuition" class="primary">Next</button>
          `;
          pushStep(() => document.getElementById("edNo").click());
    
          document.getElementById("nextTuition").addEventListener("click", () => {
            const y = Number(document.getElementById("kidsTuitionYear").value) || 0;
            budget.kidsTuition = y / 12; // store monthly
            askChildSchoolFees(userInfo, budget);
          }, { once: true });
        }, { once: true });
      }, { once: true });
    
      // No tuition at children’s schools
      document.getElementById("childTuitionNo").addEventListener("click", () => {
        budget.usingEdChoice = false;
        budget.kidsTuition = 0;
        budget.kidsFees = 0;
        budget.totalTuition = (budget.adultTuition || 0);
        startClothingStep(userInfo, budget);
      }, { once: true });
    }
    
    // After tuition decision, always ask for fees/supplies not covered
    function askChildSchoolFees(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>School Fees & Supplies</h2>
        <p>Enter the <strong>total yearly</strong> cost not covered by scholarships or grants
           (fees, supplies, tech, labs, activities, etc.).</p>
        $<input type="number" id="kidsFeesYear" min="0" step="0.01">
        <div class="row"></div>
        <button id="feesNext" class="primary">Next</button>
      `;
      pushStep(() => askChildSchoolFees(userInfo, budget));
    
      document.getElementById("feesNext").addEventListener("click", () => {
        const fy = Number(document.getElementById("kidsFeesYear").value) || 0;
        budget.kidsFees = fy / 12; // monthly
        budget.totalTuition = (budget.adultTuition || 0) + (budget.kidsTuition || 0) + (budget.kidsFees || 0);
        startClothingStep(userInfo, budget);
      }, { once: true });
    }

    // --- Clothing: average monthly estimator (secondhand + new underwear/shoes) ---
    const AVG_CLOTHING = {
      baby: 225,   // 0–3
      child: 175,  // 4–12
      teen:  250,  // 13–18
      adult: 200   // 19+
    };
    
    function clothingBand(age){
      if (age <= 3) return 'baby';
      if (age <= 12) return 'child';
      if (age <= 18) return 'teen';
      return 'adult';
    }
    
    function estimateClothingMonthly(members){
      let annual = 0;
      for (const m of (members || [])) {
        const age = Number(m.age) || 0;
        annual += AVG_CLOTHING[clothingBand(age)];
      }
      return Number((annual / 12).toFixed(2));
    }

    // ========== Clothing ==========
    
    function startClothingStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Clothing Needs</h2>
        <p>Enter yearly essentials or let us estimate.</p>
        <button id="manualClothing">Enter Manually</button>
        <button id="estimateClothing">Estimate</button>
      `;
      pushStep(() => startClothingStep(userInfo, budget));

      document.getElementById("manualClothing").addEventListener("click", () => {
        app.innerHTML = `
          <h2>Yearly Clothing Costs</h2>
          <label>Estimated yearly cost: $<input type="number" id="yearlyClothes" min="0" step="0.01"></label>
          <div class="row"></div>
          <button id="next" class="primary">Next</button>
        `;
        pushStep(() => document.getElementById("manualClothing").click());
        document.getElementById("next").addEventListener("click", () => {
          const yearly = Number(document.getElementById("yearlyClothes").value) || 0;
          budget.totalClothes = yearly / 12;
          startStudentLoanStep(userInfo, budget);
        }, { once:true });
      });
      
        document.getElementById("estimateClothing").addEventListener("click", () => {
          if (!userInfo.members || !userInfo.members.length) {
            alert("Family info missing — please restart and enter family details.");
            budget.totalClothes = 0;
            startStudentLoanStep(userInfo, budget);
            return;
          }
          renderClothingEstimateReview(userInfo, budget);
        }, { once:true });
    }

    function renderClothingEstimateReview(userInfo, budget){
      const app = document.getElementById("app");
      const members = Array.isArray(userInfo.members) ? userInfo.members : [];
    
      // Count people in each age band (uses your existing clothingBand + AVG_CLOTHING)
      const counts = { baby:0, child:0, teen:0, adult:0 };
      for (const m of members) {
        const age = Number(m.age) || 0;
        counts[clothingBand(age)] += 1;
      }
    
      const sub = {
        baby:  counts.baby  * AVG_CLOTHING.baby,
        child: counts.child * AVG_CLOTHING.child,
        teen:  counts.teen  * AVG_CLOTHING.teen,
        adult: counts.adult * AVG_CLOTHING.adult
      };
      const totalAnnual  = sub.baby + sub.child + sub.teen + sub.adult;
      const totalMonthly = totalAnnual / 12;
    
      function row(label, qty, perYear, subtotal){
        if (!qty) return "";
        return `
          <tr>
            <td style="padding:6px;">${label}</td>
            <td style="padding:6px; text-align:right;">${qty}</td>
            <td style="padding:6px; text-align:right;">$${perYear.toFixed(0)}</td>
            <td style="padding:6px; text-align:right;">$${subtotal.toFixed(0)}</td>
          </tr>`;
      }
    
      app.innerHTML = `
        <h2>Clothing — Review</h2>
        <p>Here’s how we built your <strong>bare-bones annual clothing estimate</strong>
           (mostly secondhand, new underwear & off-brand shoes).</p>
    
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:6px;">Group</th>
              <th style="text-align:right; padding:6px;">Qty</th>
              <th style="text-align:right; padding:6px;">$/person (yr)</th>
              <th style="text-align:right; padding:6px;">Subtotal (yr)</th>
            </tr>
          </thead>
          <tbody>
            ${row("Babies (0–3)", counts.baby,  AVG_CLOTHING.baby,  sub.baby)}
            ${row("Children (4–12)", counts.child, AVG_CLOTHING.child, sub.child)}
            ${row("Teens (13–18)", counts.teen,  AVG_CLOTHING.teen,  sub.teen)}
            ${row("Adults (19+)", counts.adult, AVG_CLOTHING.adult, sub.adult)}
            <tr>
              <td colspan="3" style="padding:6px; text-align:right;"><strong>Total (annual)</strong></td>
              <td style="padding:6px; text-align:right;"><strong>$${totalAnnual.toFixed(2)}</strong></td>
            </tr>
            <tr>
              <td colspan="3" style="padding:6px; text-align:right;">= Monthly</td>
              <td style="padding:6px; text-align:right;"><strong>$${totalMonthly.toFixed(2)}</strong></td>
            </tr>
          </tbody>
        </table>
    
        <div class="row"></div>
        <div class="note small">
          Assumptions: “survival-mode” wardrobe refresh each year; heavy use of secondhand;
          per-person averages vary by age band.
        </div>
    
        <div class="row"></div>
        <div class="actions">
          <button id="clothesAccept" class="primary">This looks good</button>
          <button id="clothesOverride">Let me enter my own</button>
        </div>
      `;
      pushStep(() => renderClothingEstimateReview(userInfo, budget));
    
      document.getElementById("clothesAccept").addEventListener("click", () => {
        budget.totalClothes = Number((totalAnnual / 12).toFixed(2));
        startStudentLoanStep(userInfo, budget);
      }, { once:true });
    
      document.getElementById("clothesOverride").addEventListener("click", () => {
        renderClothingManual(userInfo, budget, totalAnnual);
      }, { once:true });
    }
    
    function renderClothingManual(userInfo, budget, suggestedAnnual){
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Yearly Clothing Costs</h2>
        <label>After reviewing, enter your own yearly estimate:
          $<input type="number" id="yearlyClothes" min="0" step="0.01" value="${(suggestedAnnual || 0).toFixed(2)}">
        </label>
        <div class="row"></div>
        <div class="actions">
          <button id="clothesManualNext" class="primary">Use this amount</button>
          <button id="clothesManualBack" class="secondary">Back</button>
        </div>
      `;
      pushStep(() => renderClothingManual(userInfo, budget, suggestedAnnual));
    
      document.getElementById("clothesManualNext").addEventListener("click", () => {
        const yearly = Number(document.getElementById("yearlyClothes").value);
        if (isNaN(yearly) || yearly < 0) { alert("Please enter a valid non-negative number."); return; }
        budget.totalClothes = yearly / 12;
        startStudentLoanStep(userInfo, budget);
      }, { once:true });
    
      document.getElementById("clothesManualBack").addEventListener("click", () => {
        renderClothingEstimateReview(userInfo, budget);
      }, { once:true });
    }

    // ========== Student Loan ==========
    
    function startStudentLoanStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Student Loans</h2>
        <p>Do you have student loans?</p>
        <button id="yesLoans">Yes</button>
        <button id="noLoans">No</button>
      `;
      pushStep(() => startStudentLoanStep(userInfo, budget));
    
      // YES: ask about plan type
      document.getElementById("yesLoans").addEventListener("click", () => {
        budget.studentLoans = true;
        app.innerHTML = `
          <h2>Repayment Plan</h2>
          <p>Are you on an <strong>ICR</strong> plan (or planning to apply)?</p>
          <button id="yesICR" class="primary">Yes (ICR)</button>
          <button id="noICR">No (Standard)</button>
        `;
        pushStep(() => document.getElementById("yesLoans").click());
    
        // ICR path: collect total balance; monthly set to $0 for now
        document.getElementById("yesICR").addEventListener("click", () => {
          app.innerHTML = `
            <h2>ICR / Income-Driven</h2>
            <p>Please enter your <strong>total loan balance</strong> (for reference).</p>
            <label>Total owed: $<input type="number" id="totalLoanDebt" min="0" step="0.01"></label>
            <div class="row"></div>
            <button id="nextICR" class="primary">Next</button>
          `;
          pushStep(() => document.getElementById("yesICR").click());
    
          document.getElementById("nextICR").addEventListener("click", () => {
            const total = Number(document.getElementById("totalLoanDebt").value);
            if (isNaN(total) || total < 0) { alert("Please enter a valid non-negative number."); return; }
    
            budget.usingICR = true;
            budget.totalLoanDebt = total;   // keep for benefits wizard
            budget.monthlySetPayment = 0;   // calculated later
            alert("Monthly amount will be calculated in the benefits wizard.");
            startOtherDebtStep(userInfo, budget);
          }, { once:true });
        }, { once:true });
    
        // Standard plan: collect monthly amount AND total balance
        document.getElementById("noICR").addEventListener("click", () => {
          app.innerHTML = `
            <h2>Standard Plan</h2>
            <label>Monthly payment: $<input type="number" id="monthlySetPayment" min="0" step="0.01"></label>
            <br><br>
            <label>Total owed: $<input type="number" id="totalLoanDebt" min="0" step="0.01"></label>
            <div class="row"></div>
            <button id="nextStd" class="primary">Next</button>
          `;
          pushStep(() => document.getElementById("noICR").click());
    
          document.getElementById("nextStd").addEventListener("click", () => {
            const monthly = Number(document.getElementById("monthlySetPayment").value);
            const total = Number(document.getElementById("totalLoanDebt").value);
            if (isNaN(monthly) || monthly < 0 || isNaN(total) || total < 0) {
              alert("Please enter valid non-negative numbers.");
              return;
            }
    
            budget.usingICR = false;
            budget.monthlySetPayment = monthly; // count in budget now
            budget.totalLoanDebt = total;       // keep for later modelling
            startOtherDebtStep(userInfo, budget);
          }, { once:true });
        }, { once:true });
      }, { once:true });
    
      // NO loans
      document.getElementById("noLoans").addEventListener("click", () => {
        budget.studentLoans = false;
        budget.usingICR = false;
        budget.monthlySetPayment = 0;
        budget.totalLoanDebt = 0;
        startOtherDebtStep(userInfo, budget);
      }, { once:true });
    }

    
    // ========== Other Debt ==========

    function startOtherDebtStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Other Debt Repayments</h2>
        <p>Do you have any fixed monthly debt repayments?</p>
        <button id="yesOtherDebt">Yes</button>
        <button id="noOtherDebt">No</button>
      `;
      pushStep(() => startOtherDebtStep(userInfo, budget));

      document.getElementById("yesOtherDebt").addEventListener("click", () => {
        app.innerHTML = `
          <h2>Monthly Debt Payment</h2>
          <label>Amount: $<input type="number" id="monthlyDebtPayment" min="0" step="0.01"></label>
          <div class="row"></div>
          <button id="next" class="primary">Next</button>
        `;
        pushStep(() => document.getElementById("yesOtherDebt").click());
        document.getElementById("next").addEventListener("click", () => {
          const val = Number(document.getElementById("monthlyDebtPayment").value);
          if (isNaN(val) || val < 0) { alert("Please enter a valid non-negative number."); return; }
          budget.otherDebt = true;
          budget.monthlyDebtPayment = val;
          startHealthcareStep(userInfo, budget);
        }, { once:true });
      });

      document.getElementById("noOtherDebt").addEventListener("click", () => {
        budget.otherDebt = false;
        budget.monthlyDebtPayment = 0;
        startHealthcareStep(userInfo, budget);
      }, { once:true });
    }

    // ========== Healthcare ==========
    
    function startHealthcareStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Healthcare Costs</h2>
        <p>Do you have private (job-sponsored or other) health insurance?</p>
        <button id="yesHealthIns">Yes</button>
        <button id="noHealthIns">No</button>
      `;
      pushStep(() => startHealthcareStep(userInfo, budget));
    
      // User DOES have private insurance
      document.getElementById("yesHealthIns").addEventListener("click", () => {
        // Ask Medicaid willingness first
        app.innerHTML = `
          <h2>Medicaid Option</h2>
          <p>Would you be willing to apply for Medicaid if eligible?</p>
          <button id="medWillingYes" class="primary">Yes</button>
          <button id="medWillingNo">No</button>
        `;
        pushStep(() => document.getElementById("yesHealthIns").click());
    
        // Willing to apply: zero out; benefits wizard will calculate later
        document.getElementById("medWillingYes").addEventListener("click", () => {
          budget.healthIns = true;
          budget.medicaidWilling = true;
          budget.insPremium = 0;
          budget.yearlyMedCosts = 0;
          budget.totalHealthcare = 0;
          alert("Insurance premium and medical costs will be calculated in the benefits wizard.");
          startRepairsStep(userInfo, budget);
        }, { once:true });
    
        // Not willing: collect premium + yearly OOP now and include in budget
        document.getElementById("medWillingNo").addEventListener("click", () => {
          budget.medicaidWilling = false;
          app.innerHTML = `
            <h2>Insurance and Medical Costs</h2>
            <label>Monthly premium: $<input type="number" id="insPremium" min="0" step="0.01"></label><br><br>
            <label>Yearly out-of-pocket costs: $<input type="number" id="yearlyMedCosts" min="0" step="0.01"></label><br><br>
            <button id="nextHealth" class="primary">Next</button>
          `;
          pushStep(() => document.getElementById("medWillingNo").click());
    
          document.getElementById("nextHealth").addEventListener("click", () => {
            const insPremium = Number(document.getElementById("insPremium").value);
            const yearlyMedCosts = Number(document.getElementById("yearlyMedCosts").value);
            if (isNaN(insPremium) || insPremium < 0 || isNaN(yearlyMedCosts) || yearlyMedCosts < 0) {
              alert("Please enter valid non-negative numbers.");
              return;
            }
            budget.healthIns = true;
            budget.insPremium = insPremium;
            budget.yearlyMedCosts = yearlyMedCosts;
            budget.totalHealthcare = insPremium + (yearlyMedCosts / 12);
            startRepairsStep(userInfo, budget);
          }, { once:true });
        }, { once:true });
      }, { once:true });
    
        // User does NOT have private insurance
        document.getElementById("noHealthIns").addEventListener("click", () => {
          // friendly heads-up
          if (!sessionStorage.getItem("alert_healthcare_no_once")) {
            alert("We'll calculate your healthcare costs during the Benefits Wizard since you don't have a job-sponsored or private plan.");
            sessionStorage.setItem("alert_healthcare_no_once", "1"); // show once per session
          }
        
          budget.healthIns = false;
          budget.medicaidWilling = true; // Benefits Wizard will check eligibility
          budget.insPremium = 0;
          budget.yearlyMedCosts = 0;
          budget.totalHealthcare = 0;
        
          startRepairsStep(userInfo, budget);
        }, { once:true });
    }

    // ========== Home Repair ==========
    function startRepairsStep(userInfo, budget) {
      // Skip this section entirely for renters
      if (userInfo.ownsHome !== true) {
        budget.yearlyRepairs = 0;
        budget.monthlyRepairs = 0;
        return startPetCostsStep(userInfo, budget);
      }
    
      const app = document.getElementById("app");
    
      // --- Ohio-average % of home value per year (maintenance + repairs) ---
      const OHIO_REPAIR_PCT = {
        lt10:   0.010, // <10 yrs  ≈ 1.0%
        y10_19: 0.014, // 10–19    ≈ 1.4%
        y20_39: 0.020, // 20–39    ≈ 2.0%
        y40_69: 0.025, // 40–69    ≈ 2.5%
        gte70:  0.030  // 70+      ≈ 3.0%
      };
    
      function bandFromAge(age){
        if (age < 10)  return 'lt10';
        if (age <= 19) return 'y10_19';
        if (age <= 39) return 'y20_39';
        if (age <= 69) return 'y40_69';
        return 'gte70';
      }
    
      function calcAnnualHomeRepairsOhio({ value, ageYears }){
        const band = bandFromAge(ageYears);
        const pct  = OHIO_REPAIR_PCT[band];
        const annual  = value * pct;
        const monthly = annual / 12;
        return {
          band,
          pct: Number(pct.toFixed(4)),
          annual: Number(annual.toFixed(2)),
          monthly: Number(monthly.toFixed(2))
        };
      }
    
      // Main screen (manual entry + helper)
      function renderMain() {
        app.innerHTML = `
          <h2>Household Repairs</h2>
          <p>Enter your <strong>yearly</strong> home repairs & maintenance amount (non-medical/auto/pet), or let us estimate using the Ohio 1–3% rule.</p>
          <label>Yearly repairs & maintenance: $<input type="number" id="yearlyRepairs" min="0" step="0.01"></label>
          <div class="row"></div>
          <div class="actions">
            <button id="repairsNext" class="primary">Next</button>
            <button id="repairsEstimate" class="secondary">Help me estimate</button>
          </div>
        `;
        pushStep(() => renderMain());
        appendRepairsNote();
    
        document.getElementById("repairsNext").addEventListener("click", () => {
          const valStr = document.getElementById("yearlyRepairs").value.trim();
          const valNum = Number(valStr);
          if (valStr === "" || isNaN(valNum) || valNum < 0) {
            alert("Please enter a valid non-negative number.");
            return;
          }
          budget.yearlyRepairs = valNum;
          budget.monthlyRepairs = valNum / 12;
          startPetCostsStep(userInfo, budget);
        }, { once:true });
    
        document.getElementById("repairsEstimate").addEventListener("click", () => {
          renderEstimator();
        }, { once:true });
      }
    
      // Helper screen (estimate using value + age)
      function renderEstimator() {
        app.innerHTML = `
          <h2>Estimate Home Repairs (Ohio)</h2>
          <div class="grid">
            <label>Home market value: $<input type="number" id="homeValue" min="0" step="0.01"></label>
            <label>Home age (years): <input type="number" id="homeAge" min="0" step="1"></label>
          </div>
          <div class="row"></div>
          <div class="actions">
            <button id="useEstimate" class="primary">Use Estimate</button>
            <button id="cancelEstimate" class="secondary">Back</button>
          </div>
        `;
        pushStep(() => renderEstimator());
        appendRepairsNote();
    
        document.getElementById("useEstimate").addEventListener("click", () => {
          const value = Number(document.getElementById("homeValue").value);
          const ageYears = Number(document.getElementById("homeAge").value);
          if (isNaN(value) || value < 0 || isNaN(ageYears) || ageYears < 0) {
            alert("Please enter valid non-negative numbers.");
            return;
          }
          const result = calcAnnualHomeRepairsOhio({ value, ageYears });
          renderRepairsEstimateReview(userInfo, budget, { value, ageYears, ...result });
        }, { once:true });
      }
    
    function renderRepairsEstimateReview(userInfo, budget, data){
      const app = document.getElementById("app");
      const { value, ageYears, band, pct, annual, monthly } = data;
    
      const bandLabels = {
        lt10: "< 10 years",
        y10_19: "10–19 years",
        y20_39: "20–39 years",
        y40_69: "40–69 years",
        gte70: "70+ years"
      };
    
      app.innerHTML = `
        <h2>Home Repairs — Review</h2>
        <p>We used the Ohio 1–3% rule and adjusted by home age.</p>
    
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <tbody>
            <tr>
              <td style="padding:6px;">Home market value</td>
              <td style="padding:6px; text-align:right;">$${value.toLocaleString()}</td>
            </tr>
            <tr>
              <td style="padding:6px;">Home age</td>
              <td style="padding:6px; text-align:right;">${ageYears} years</td>
            </tr>
            <tr>
              <td style="padding:6px;">Age band</td>
              <td style="padding:6px; text-align:right;">${bandLabels[band] || band}</td>
            </tr>
            <tr>
              <td style="padding:6px;">Percent applied</td>
              <td style="padding:6px; text-align:right;">${(pct * 100).toFixed(2)}%</td>
            </tr>
            <tr>
              <td style="padding:6px;">Calculation</td>
              <td style="padding:6px; text-align:right;">$${value.toLocaleString()} × ${(pct*100).toFixed(2)}% = $${annual.toFixed(2)}</td>
            </tr>
            <tr>
              <td style="padding:6px;"><strong>Total (annual)</strong></td>
              <td style="padding:6px; text-align:right;"><strong>$${annual.toFixed(2)}</strong></td>
            </tr>
            <tr>
              <td style="padding:6px;">= Monthly average</td>
              <td style="padding:6px; text-align:right;"><strong>$${monthly.toFixed(2)}</strong></td>
            </tr>
          </tbody>
        </table>
    
        <div class="row"></div>
        <div class="note small">
          This “1–3% of value” rule is an average over time; real costs arrive in spikes (roof/HVAC, etc.).
          Use your own number if you maintain reserves differently or your home has unusual needs.
        </div>
    
        <div class="row"></div>
        <div class="actions">
          <button id="repairsAccept" class="primary">This looks good</button>
          <button id="repairsOverride">Let me enter my own</button>
        </div>
      `;
      pushStep(() => renderRepairsEstimateReview(userInfo, budget, data));
    
      document.getElementById("repairsAccept").addEventListener("click", () => {
        budget.yearlyRepairs = annual;
        budget.monthlyRepairs = Number((annual / 12).toFixed(2));
        startPetCostsStep(userInfo, budget);
      }, { once:true });
    
      document.getElementById("repairsOverride").addEventListener("click", () => {
        renderRepairsManual(userInfo, budget, data);
      }, { once:true });
    }
    
    function renderRepairsManual(userInfo, budget, data){
      const app = document.getElementById("app");
      const suggestedAnnual = data?.annual || 0;
    
      app.innerHTML = `
        <h2>Yearly Home Repairs & Maintenance</h2>
        <label>After reviewing, enter your own yearly estimate:
          $<input type="number" id="yearlyRepairs" min="0" step="0.01" value="${suggestedAnnual.toFixed(2)}">
        </label>
        <div class="row"></div>
        <div class="actions">
          <button id="repairsUse" class="primary">Use this amount</button>
          <button id="repairsBack" class="secondary">Back</button>
        </div>
      `;
      pushStep(() => renderRepairsManual(userInfo, budget, data));
    
      document.getElementById("repairsUse").addEventListener("click", () => {
        const val = Number(document.getElementById("yearlyRepairs").value);
        if (isNaN(val) || val < 0) { alert("Please enter a valid non-negative number."); return; }
        budget.yearlyRepairs = val;
        budget.monthlyRepairs = val / 12;
        startPetCostsStep(userInfo, budget);
      }, { once:true });
    
      document.getElementById("repairsBack").addEventListener("click", () => {
        renderRepairsEstimateReview(userInfo, budget, data);
      }, { once:true });
    }
        
    
      function appendRepairsNote() {
        const note = document.createElement('div');
        note.className = 'note small';
        note.innerHTML = `
          <strong>Housing Repairs – The Hidden Cost of Homeownership</strong><br><br>
          Owning a home isn’t just about your mortgage, taxes, and insurance. Every system and surface in your house will eventually need repair or replacement — sometimes in expensive, unpredictable bursts.<br><br>
          <strong>Why This Matters</strong><br>
          <em>Not Optional:</em> Even with a well-built home, roofs wear out, furnaces fail, and plumbing breaks. Ignoring repairs can damage the home’s value and safety.<br><br>
          <em>Unpredictable Timing:</em> You might go 3 years with nothing major, then get hit with a $12,000 HVAC replacement or roof leak.<br><br>
          <em>The 1–3% Rule:</em> Homeowners in Ohio should plan to spend 1–3% of the home’s value per year on maintenance and repairs, depending on the home’s age.<br><br>
          <em>Aging Factor:</em> As your home ages, the average cost per year rises — especially after 30–40 years.
        `;
        app.appendChild(note);
      }
    
      // Boot the main view (for homeowners)
      renderMain();
    }

    // ========== Pet Costs ==========
    function startPetCostsStep(userInfo, budget) {
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Pet Costs</h2>
        <p>Do you own pets?</p>
        <button id="yesPets">Yes</button>
        <button id="noPets">No</button>
      `;
      pushStep(() => startPetCostsStep(userInfo, budget));
    
      // NO PETS
      document.getElementById("noPets").addEventListener("click", () => {
        budget.petOwner = false;
        budget.petCosts = 0;
        budget.monthlyPetCosts = 0;
        finishBudgetCalculation(userInfo, budget);
      }, { once:true });
    
      // YES PETS → choose manual or estimator
      document.getElementById("yesPets").addEventListener("click", () => {
        app.innerHTML = `
          <h2>Yearly Pet Expenses</h2>
          <p>Would you like help calculating your yearly pet costs?<br>
             <em>Note: Calculator currently supports dogs and cats.</em></p>
          <div class="actions">
            <button id="petManual" class="primary">Enter Manually</button>
            <button id="petEstimate" class="secondary">Help me estimate</button>
          </div>
        `;
        pushStep(() => document.getElementById("yesPets").click());
    
        // Manual entry path
        document.getElementById("petManual").addEventListener("click", () => {
          app.innerHTML = `
            <h2>Yearly Pet Expenses</h2>
            <label>Total yearly pet costs: $<input type="number" id="petCosts" min="0" step="0.01"></label>
            <div class="row"></div>
            <button id="finish" class="primary">Finish</button>
          `;
          pushStep(() => document.getElementById("petManual").click());
    
          document.getElementById("finish").addEventListener("click", () => {
            const valStr = document.getElementById("petCosts").value.trim();
            const valNum = Number(valStr);
            if (valStr === "" || isNaN(valNum) || valNum < 0) {
              alert("Please enter a valid non-negative number.");
              return;
            }
            budget.petOwner = true;
            budget.petCosts = valNum;             // yearly
            budget.monthlyPetCosts = valNum / 12; // monthly
            finishBudgetCalculation(userInfo, budget);
          }, { once:true });
        }, { once:true });
    
        // Estimator path
        document.getElementById("petEstimate").addEventListener("click", () => {
          renderPetEstimator();
        }, { once:true });
      }, { once:true });
    
      // ---- Bare-bones estimator (dogs & cats only, single average with amortization built in) ----
      function renderPetEstimator() {
        const app = document.getElementById("app");
        app.innerHTML = `
          <h2>Bare-Bones Pet Cost Estimator</h2>
          <div class="grid">
            <label>Small dogs (≤20 lb): <input type="number" id="dogSmall" min="0" step="1" value="0"></label>
            <label>Medium dogs (21–60 lb): <input type="number" id="dogMed" min="0" step="1" value="0"></label>
            <label>Large dogs (61+ lb): <input type="number" id="dogLarge" min="0" step="1" value="0"></label>
            <label>Indoor cats: <input type="number" id="cats" min="0" step="1" value="0"></label>
          </div>
    
          <div class="row"></div>
          <div class="actions">
            <button id="usePetEstimate" class="primary">Use Estimate</button>
            <button id="cancelPetEstimate" class="secondary">Back</button>
          </div>
        `;
        pushStep(() => renderPetEstimator());
    
        // Info note: what’s included/excluded
        const note = document.createElement('div');
        note.className = 'note small';
        note.innerHTML = `
          <strong>What this includes (bare-bones, not negligent):</strong>
          food, core parasite prevention, annual exam + core vaccines,
          dog license, basic hygiene (dogs: nail trims/brush; cats rely on a scratching post),
          poop bags/litter, a small emergency reserve, and a modest <em>built-in amortization</em>
          for early costs (spay/neuter, microchip, initial vaccines, basic gear) <em>and</em>
          senior screening bloodwork averaged across life stages.<br>
          <strong>Excluded:</strong> insurance, pro grooming (unless the breed truly requires it),
          premium diets/treats, daycare/boarding, training classes, apparel.
        `;
        app.appendChild(note);
    
        // Single bare-bones monthly averages (already include amortization)
        const COSTS = {
          dogSmall: 85,   // per month
          dogMed:   115,
          dogLarge: 155,
          cat:      70
        };
    
        document.getElementById("usePetEstimate").addEventListener("click", () => {
          const nSmall = Number(document.getElementById("dogSmall").value) || 0;
          const nMed   = Number(document.getElementById("dogMed").value)   || 0;
          const nLarge = Number(document.getElementById("dogLarge").value) || 0;
          const nCats  = Number(document.getElementById("cats").value)     || 0;
        
          if (nSmall < 0 || nMed < 0 || nLarge < 0 || nCats < 0) {
            alert("Please enter non-negative values.");
            return;
          }
        
          const breakdown = {
            counts: { nSmall, nMed, nLarge, nCats },
            unitMonthly: { dogSmall: COSTS.dogSmall, dogMed: COSTS.dogMed, dogLarge: COSTS.dogLarge, cat: COSTS.cat }
          };
        
          breakdown.subtotals = {
            small: nSmall * COSTS.dogSmall,
            med:   nMed   * COSTS.dogMed,
            large: nLarge * COSTS.dogLarge,
            cats:  nCats  * COSTS.cat
          };
        
          breakdown.monthly = breakdown.subtotals.small + breakdown.subtotals.med + breakdown.subtotals.large + breakdown.subtotals.cats;
          breakdown.annual  = breakdown.monthly * 12;
        
          renderPetEstimateReview(userInfo, budget, breakdown);
        }, { once:true });

    
        document.getElementById("cancelPetEstimate").addEventListener("click", () => {
          // Back to the manual/estimate choice screen
          startPetCostsStep(userInfo, budget);
        }, { once:true });
      }
      
    function renderPetEstimateReview(userInfo, budget, data){
      const app = document.getElementById("app");
      const { counts, unitMonthly, subtotals, monthly, annual } = data;
    
      app.innerHTML = `
        <h2>Pet Costs — Review</h2>
        <p>Here’s how we calculated your estimated pet costs.</p>
    
        <table style="width:100%; border-collapse:collapse; margin-top:8px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:6px;">Type</th>
              <th style="text-align:right; padding:6px;">Count</th>
              <th style="text-align:right; padding:6px;">Per-month</th>
              <th style="text-align:right; padding:6px;">Subtotal / mo</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding:6px;">Small dogs (≤20 lb)</td>
              <td style="padding:6px; text-align:right;">${counts.nSmall}</td>
              <td style="padding:6px; text-align:right;">$${unitMonthly.dogSmall.toFixed(0)}</td>
              <td style="padding:6px; text-align:right;">$${subtotals.small.toFixed(2)}</td>
            </tr>
            <tr>
              <td style="padding:6px;">Medium dogs (21–60 lb)</td>
              <td style="padding:6px; text-align:right;">${counts.nMed}</td>
              <td style="padding:6px; text-align:right;">$${unitMonthly.dogMed.toFixed(0)}</td>
              <td style="padding:6px; text-align:right;">$${subtotals.med.toFixed(2)}</td>
            </tr>
            <tr>
              <td style="padding:6px;">Large dogs (61+ lb)</td>
              <td style="padding:6px; text-align:right;">${counts.nLarge}</td>
              <td style="padding:6px; text-align:right;">$${unitMonthly.dogLarge.toFixed(0)}</td>
              <td style="padding:6px; text-align:right;">$${subtotals.large.toFixed(2)}</td>
            </tr>
            <tr>
              <td style="padding:6px;">Indoor cats</td>
              <td style="padding:6px; text-align:right;">${counts.nCats}</td>
              <td style="padding:6px; text-align:right;">$${unitMonthly.cat.toFixed(0)}</td>
              <td style="padding:6px; text-align:right;">$${subtotals.cats.toFixed(2)}</td>
            </tr>
            <tr>
              <td style="padding:6px;"><strong>Total (monthly)</strong></td>
              <td></td><td></td>
              <td style="padding:6px; text-align:right;"><strong>$${monthly.toFixed(2)}</strong></td>
            </tr>
            <tr>
              <td style="padding:6px;">= Annualized</td>
              <td></td><td></td>
              <td style="padding:6px; text-align:right;"><strong>$${annual.toFixed(2)}</strong></td>
            </tr>
          </tbody>
        </table>
    
        <div class="row"></div>
        <div class="note small">
          What’s included: food, parasite prevention, annual exam + core vaccines,
          license (dogs), basic hygiene, litter/poop bags, a small emergency reserve,
          and modest amortization for early/senior care. Excludes insurance, pro grooming (unless required),
          premium diets/treats, daycare/boarding, training classes, apparel.
        </div>
    
        <div class="row"></div>
        <div class="actions">
          <button id="petAccept" class="primary">This looks good</button>
          <button id="petOverride">Let me enter my own</button>
        </div>
      `;
      pushStep(() => renderPetEstimateReview(userInfo, budget, data));
    
      document.getElementById("petAccept").addEventListener("click", () => {
        const totalPets = counts.nSmall + counts.nMed + counts.nLarge + counts.nCats;
        budget.petOwner = totalPets > 0;
        budget.monthlyPetCosts = Number(monthly.toFixed(2));
        budget.petCosts = Number(annual.toFixed(2)); // yearly
        finishBudgetCalculation(userInfo, budget);
      }, { once:true });
    
      document.getElementById("petOverride").addEventListener("click", () => {
        renderPetManualOverride(userInfo, budget, data);
      }, { once:true });
    }
    
    function renderPetManualOverride(userInfo, budget, data){
      const app = document.getElementById("app");
      const suggestedAnnual = data?.annual || 0;
    
      app.innerHTML = `
        <h2>Yearly Pet Expenses</h2>
        <p>After reviewing the estimate, enter your own yearly total if you prefer.</p>
        <label>Total yearly pet costs:
          $<input type="number" id="petCosts" min="0" step="0.01" value="${suggestedAnnual.toFixed(2)}">
        </label>
        <div class="row"></div>
        <div class="actions">
          <button id="petUse" class="primary">Use this amount</button>
          <button id="petBack" class="secondary">Back</button>
        </div>
      `;
      pushStep(() => renderPetManualOverride(userInfo, budget, data));
    
      document.getElementById("petUse").addEventListener("click", () => {
        const valStr = document.getElementById("petCosts").value.trim();
        const valNum = Number(valStr);
        if (valStr === "" || isNaN(valNum) || valNum < 0) {
          alert("Please enter a valid non-negative number.");
          return;
        }
        budget.petOwner = valNum > 0;
        budget.petCosts = valNum;            // yearly
        budget.monthlyPetCosts = valNum / 12;
        finishBudgetCalculation(userInfo, budget);
      }, { once:true });
    
      document.getElementById("petBack").addEventListener("click", () => {
        renderPetEstimateReview(userInfo, budget, data);
      }, { once:true });
    }
      
    }

    // ========== Final Budget Calculation ==========
    
    function finishBudgetCalculation(userInfo, budget) {
    // 1) Bare-bones total 
    const bare = (budget.monthlyHousing || 0)
      + (budget.utilityCost || 0)
      + (budget.connectCost || 0)
      + (budget.totalTransCost || 0)
      + (budget.totalFood || 0)
      + (budget.totalGoods || 0)
      + (budget.childcareCost || 0)
      + (budget.totalTuition || 0)
      + (budget.totalClothes || 0)
      + (budget.monthlySetPayment || 0)
      + (budget.monthlyDebtPayment || 0)
      + (budget.totalHealthcare || 0)
      + (budget.monthlyRepairs || 0)
      + (budget.monthlyPetCosts || 0);
    
    budget.totalMonthlyExpenses = bare;           // keep old name = bare bones
    budget._bareBonesMonthly = bare;              // explicit label for UI
    
    // 2) Frugal-but-Fun add-on
    const funCalc = computeFrugalFun(userInfo, budget, bare);
    budget.frugalFunMonthly = Number(funCalc.frugalFun.toFixed(2));
    budget.frugalFunRaw = Number(funCalc.raw.toFixed(2));
    budget.frugalFunCap = Number(funCalc.cap.toFixed(2));
    budget.frugalFunCapped = !!funCalc.usedCap;   // true if cap applied
    budget._funBreakdown = funCalc.components;    // optional: for later UI
    
    // 3) Combined “Frugal but Fun” total
    budget.totalMonthlyFrugal = Number((bare + funCalc.frugalFun).toFixed(2));
    
    showBudgetSummary(userInfo, budget, /*cameFromManual*/false);

    }



    function row(label, val) {
      const amount = (Number(val) || 0).toFixed(2);
      return `
        <div>
          <strong>${label}:</strong> $${amount}
          &nbsp; <span class="edit-link" data-target="${label}">Edit</span>
        </div>
      `;
    }

    // ===== Summary with quick "Edit this" links =====
    function showBudgetSummary(userInfo, budget, cameFromManual) {
        const app = document.getElementById("app");
        const bare = Number(budget._bareBonesMonthly || budget.totalMonthlyExpenses || 0);
        const funAdd = Number(budget.frugalFunMonthly || 0);
        const frugalTotal = Number(budget.totalMonthlyFrugal || (bare + funAdd));
        
        app.innerHTML = `
          <h2>Budget Summary</h2>
        
          <div class="note" style="margin-bottom:10px;">
            <div><strong>Bare-bones total (monthly):</strong> $${bare.toFixed(2)}</div>
            <div><strong>Frugal-but-Fun add-on:</strong> $${funAdd.toFixed(2)}
              ${budget.frugalFunCapped ? '<span class="small"> (capped at '+(budget.frugalFunCap||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+')</span>' : ''}
            </div>
            <div><strong>Frugal-but-Fun total (monthly):</strong> $${frugalTotal.toFixed(2)}</div>
          </div>
        
          <div class="note small" style="margin-bottom:14px;">
            <strong>Post-Budget Note (Bare Bones Estimate)</strong><br>
            <em>
              Keep in mind: this budget leaves <strong>no</strong> room for joy, hobbies, or comfort — no space for what makes life
              <em>living</em> instead of simply <em>not dying</em>.<br><br>
              We all deserve to <strong>live</strong>, not merely survive. For families with small children, where parents are already working
              full-time just to keep afloat, anything less than this bare-bones survival budget is not just inconvenient —
              it’s a violation of human rights.
            </em>
          </div>
        
          <div class="grid">
            ${row("Housing", budget.monthlyHousing, () => startHousingStep(userInfo, budget))}
            ${row("Utilities", budget.utilityCost, () => startUtilitiesStep(userInfo, budget))}
            ${row("Phone & Internet", budget.connectCost, () => startConnectivityStep(userInfo, budget))}
            ${row("Transportation", budget.totalTransCost, () => startTransportationStep(userInfo, budget))}
            ${row("Food", budget.totalFood, () => startFoodStep(userInfo, budget))}
            ${row("Household Items", budget.totalGoods, () => startHouseholdGoodsStep(userInfo, budget))}
            ${row("Childcare", budget.childcareCost, () => startChildcareStep(userInfo, budget))}
            ${row("Tuition (adult + child)", budget.totalTuition, () => startTuitionStep(userInfo, budget))}
            ${row("Clothing (monthly)", budget.totalClothes, () => startClothingStep(userInfo, budget))}
            ${row("Student Loan (monthly)", budget.monthlySetPayment, () => startStudentLoanStep(userInfo, budget))}
            ${row("Other Debt (monthly)", budget.monthlyDebtPayment, () => startOtherDebtStep(userInfo, budget))}
            ${row("Healthcare (monthly)", budget.totalHealthcare, () => startHealthcareStep(userInfo, budget))}
            ${row("Repairs (monthly)", budget.monthlyRepairs, () => startRepairsStep(userInfo, budget))}
            ${row("Pet Costs (monthly)", budget.monthlyPetCosts, () => startPetCostsStep(userInfo, budget))}
          </div>
        
          <div class="row"></div>
          <button id="restart">Restart Budget Wizard</button>
          <button id="proceed" class="primary">Proceed</button>
        `;
    
    
          // Summary view should also be on the back stack so Back returns here
          pushStep(() => showBudgetSummary(userInfo, budget, cameFromManual));
    
          // Wire up "edit" links
        document.querySelectorAll(".edit-link").forEach((el) => {
          el.addEventListener("click", () => {
            const raw = el.getAttribute("data-target") || "";
            // normalize: drop anything in parentheses and trailing " (monthly)" etc.
            const target = raw.replace(/\s*\([^)]*\)\s*/g, "").trim();
        
            switch (target) {
              case "Housing":              startHousingStep(userInfo, budget); break;
              case "Utilities":            startUtilitiesStep(userInfo, budget); break;
              case "Phone & Internet":     startConnectivityStep(userInfo, budget); break;
              case "Transportation":       startTransportationStep(userInfo, budget); break;
              case "Food":                 startFoodStep(userInfo, budget); break;
              case "Household Items":      startHouseholdGoodsStep(userInfo, budget); break;
              case "Childcare":            startChildcareStep(userInfo, budget); break;
              case "Tuition":              startTuitionStep(userInfo, budget); break;
              case "Clothing":             startClothingStep(userInfo, budget); break;
              case "Student Loan":         startStudentLoanStep(userInfo, budget); break;
              case "Other Debt":           startOtherDebtStep(userInfo, budget); break;
              case "Healthcare":           startHealthcareStep(userInfo, budget); break;
              case "Repairs":              startRepairsStep(userInfo, budget); break;
              case "Pet Costs":            startPetCostsStep(userInfo, budget); break;
            }
          });
        });
    
        document.getElementById("restart").addEventListener("click", () => {
            // Clear the back stack and start fresh
            stepStack.length = 0;
            startBudgetWizard(userInfo);
        });
    
        document.getElementById("proceed").addEventListener("click", () => {
          startBenefitsWizard(userInfo, budget);
    });


 
 
 //BENEFITS

    // ========== Benefits Wizard: Willingness ==========
    
    function startBenefitsWizard(userInfo, budget) {
      const lockedPipp = !!(budget.benefits?.pipp?.willingToApply);
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2>Benefits Wizard: Willingness</h2>
        <p>Select programs you're willing to apply for. Items you already answered earlier are locked so they don't change your budget math.</p>
    
        <div class="note small">
          <strong>Locked from earlier answers</strong>
          <ul style="margin:8px 0 0 18px;">
            ${lockedRow("Childcare Subsidy", !!budget.usingChildcareSubsidy)}
            ${lockedRow("EdChoice Scholarship", !!budget.usingEdChoice)}
            ${lockedRow("Medicaid/Medicare (willing to apply)", !!budget.medicaidWilling)}
            ${lockedRow("Income-driven student loans (ICR)", !!budget.usingICR)}
            ${lockedRow("Home Energy (PIPP Plus)", lockedPipp)}
          </ul>
          <div class="small" style="margin-top:6px;">
            “No” means you previously chose not to apply; you’ll be able to edit that later.
          </div>
        </div>
    
        <h3 style="margin-top:16px;">Other benefits you may consider</h3>
        <label><input type="checkbox" id="b-snap"> Food Stamps / SNAP</label>
        <label><input type="checkbox" id="b-meals"> Free & Reduced School Meals</label>
        <label><input type="checkbox" id="b-wic"> Women, Infants &amp; Children (WIC)</label>
        <label><input type="checkbox" id="b-ssi"> Social Security (SSI/SSDI) – screening</label>

    
        <div class="row"></div>
        <div class="actions">
          <button id="benefitsSave" class="primary">Continue</button>
        </div>
      `;
      pushStep(() => startBenefitsWizard(userInfo, budget));
    
    document.getElementById("benefitsSave").addEventListener("click", () => {
      // Save willingness for benefits we haven't asked yet
        userInfo.benefitWillingness = {
          // New slim checklist
          snap: document.getElementById("b-snap").checked,
          meals: document.getElementById("b-meals").checked,
          wic: document.getElementById("b-wic").checked,
          socialSecurity: document.getElementById("b-ssi").checked,
        
          // Removed from this screen (do not save here):
          // housing, lifeline, disability, medicare
        
          // Preserve prior “locked” choices from earlier steps:
          childcareSubsidy: !!budget.usingChildcareSubsidy,
          edchoice:        !!budget.usingEdChoice,
          // Rename copy NOTE: once you update the earlier step’s label to “Medicaid/Medicare”,
          // this stored flag can stay as `medicaidWilling` (logic is unchanged).
          medicaid:        !!budget.medicaidWilling,
          icr:             !!budget.usingICR,
          pipp:            !!(budget.benefits?.pipp?.willingToApply),
        };


      alert("Saved! Next we’ll check benefits based on your selections.");
      // Start the flow at the first selected benefit
      goNextBenefit(null, userInfo, budget);
    }, { once: true });

    
      function lockedRow(label, val) {
        const status = val ? "Yes (locked)" : "No (locked; editable later)";
        return `<li>${label}: <strong>${status}</strong></li>`;
      }
    }

    
    
    
    // ========== Benefits Wizard ==========
    
    // ===== Benefit flow router (minimal) =====

    // Order of steps we’ll walk through
    const BENEFIT_ORDER = [
      'snap',
      'frl',        // Free/Reduced Lunch/Breakfast
      'wic',        // NEW
      'ssi',        // single screen for SSI/SSDI
      'healthcare', // Medicaid/Medicare handled in the Healthcare step
      'childcare',
      'edchoice',
      'icr',
      'pipp'
    ];

    
    // Map willingness → booleans used by router
    function willing(userInfo, budget){
      const w = userInfo.benefitWillingness || {};
      return {
        // from this screen
        snap:       !!w.snap,
        frl:        !!w.meals,
        wic:        !!w.wic,
        ssi:        !!w.socialSecurity, // covers both SSI and SSDI screening
    
        // locked/previous steps
        healthcare: !!w.medicaid,         // your Healthcare step will handle Medicaid/Medicare logic
        childcare:  !!w.childcareSubsidy,
        edchoice:   !!w.edchoice,
        icr:        !!w.icr,
        pipp:       !!w.pipp,
    
        // removed from flow:
        // medicare: false,
        // housing:  false,
        // lifeline: false,
        // ssdi:     false
      };
    }

    // ===== Routing helpers =====
    // (This sits beside your existing willing(...) and goNextBenefit(...))
    
    function shouldRunWIC(userInfo, budget){
      const optedIn = !!(willing(userInfo, budget)?.wic);
      const pregnant = !!userInfo.pregnant;
      const hasU5 = Array.isArray(userInfo.members)
        && userInfo.members.some(m => Number(m.age) >= 0 && Number(m.age) < 5);
      return optedIn || pregnant || hasU5;
    }

    
    // Call the next selected step after `currentKey`.
    // If currentKey is null → start at the first selected.
    function goNextBenefit(currentKey, userInfo, budget){
      console.log('[Benefits] next after:', currentKey, ' → willing:', willing(userInfo, budget));
    
      const wl = willing(userInfo, budget);

    
      // Start after the provided key (or at the beginning if null/unknown)
      const idx = BENEFIT_ORDER.indexOf(currentKey);
      const startIdx = (currentKey && idx >= 0) ? idx + 1 : 0;
    
      // Step map (guarded): only call if the function actually exists.
      // Handles naming mismatches (FRL/PIPP) gracefully.
        const stepMap = {
          snap:        typeof startSnapStep === 'function'             ? startSnapStep             : null,
          frl:         (typeof startFrlStep === 'function') ? startFrlStep
                     :  (typeof startFRLStep === 'function') ? startFRLStep : null,
          wic:         typeof startWICStep === 'function'              ? startWICStep              : null, // you'll add this
          ssi:         typeof startSSIStep === 'function'              ? startSSIStep              : null, // single screen for SSI/SSDI
          healthcare:  typeof startHealthcareCostStep === 'function'   ? startHealthcareCostStep   : null,
          childcare:   typeof startChildcareAssistStep === 'function'  ? startChildcareAssistStep  : null,
          edchoice:    typeof startEdChoiceBenefitStep === 'function'  ? startEdChoiceBenefitStep  : null,
          icr:         typeof startICRStep === 'function'              ? startICRStep              : null,
          pipp:        (typeof startPippStep === 'function') ? startPippStep
                     :  (typeof startPIPPStep === 'function') ? startPIPPStep : null
        };

    
      // Walk forward until we find a willing step with a callable function
      for (let i = startIdx; i < BENEFIT_ORDER.length; i++){
        const key = BENEFIT_ORDER[i];
        if (!wl[key]) continue; // user isn’t doing this one
    
        const fn = stepMap[key];
        if (typeof fn === 'function') {
          try {
            return fn(userInfo, budget);
          } catch (err) {
            console.error(`[Benefits] Step "${key}" threw:`, err);
            // fall through to try the next step
          }
        } else {
          console.warn(`[Benefits] No step function found for "${key}". Skipping.`);
        }
      }
    
      // Nothing left (or everything was skipped) → continue the flow
      try {
        // Your current next stage after benefits
        return startNetAfterTaxStep(userInfo, budget);
      } catch (err) {
        console.error('[Benefits] Fallback failed, trying final availability:', err);
        return renderFinalAvailability(userInfo, budget);
      }
    }

    // ===== Shared YEARLY samplers on the $100 salary grid =====
    function __clampNum(n){ return Number.isFinite(n) ? n : 0; }
    function __grid(budget){
      return (Array.isArray(budget._salaries) && budget._salaries.length) ? budget._salaries : [];
    }
    function sampleVec(key, annual, budget){
      const GRID = __grid(budget);
      const S = budget._series || {};
      const vec = S[key];
      if (!Array.isArray(vec) || vec.length !== GRID.length || !GRID.length) return 0;
      if (annual <= GRID[0]) return __clampNum(vec[0]);
      if (annual >= GRID[GRID.length-1]) return __clampNum(vec[vec.length-1]);
      let lo = 0, hi = GRID.length - 1;
      while (hi - lo > 1){
        const mid = (lo + hi) >> 1;
        if (GRID[mid] <= annual) lo = mid; else hi = mid;
      }
      const t = (annual - GRID[lo]) / Math.max(1, GRID[hi] - GRID[lo]);
      return __clampNum(vec[lo] + t * (vec[hi] - vec[lo]));
    }
    function sampleNetAnnual(annual, budget){
      const S = budget._series || {};
      const GRID = __grid(budget);
      if (Array.isArray(S.net_after_tax_yearly) && S.net_after_tax_yearly.length === GRID.length)
        return sampleVec('net_after_tax_yearly', annual, budget);
      if (Array.isArray(S.net_yearly) && S.net_yearly.length === GRID.length)
        return sampleVec('net_yearly', annual, budget);
      // fallback to any old coarse .points you might still have:
      const pts = (S.netIncome && Array.isArray(S.netIncome.points)) ? S.netIncome.points.slice().sort((a,b)=>a.annual-b.annual) : [];
      if (!pts.length) return 0;
      if (annual <= pts[0].annual) return __clampNum(pts[0].netAnnual);
      if (annual >= pts[pts.length-1].annual) return __clampNum(pts[pts.length-1].netAnnual);
      for (let i=1;i<pts.length;i++){
        const p0=pts[i-1], p1=pts[i];
        if (annual >= p0.annual && annual <= p1.annual){
          const t=(annual-p0.annual)/Math.max(1,p1.annual-p0.annual);
          return __clampNum(p0.netAnnual + t*(p1.netAnnual - p0.netAnnual));
        }
      }
      return 0;
    }
    function sampleEdChoiceYearly(annual, budget){
      const S = budget._series || {};
      const GRID = __grid(budget);
      if (Array.isArray(S.edchoice_yearly) && S.edchoice_yearly.length === GRID.length)
        return sampleVec('edchoice_yearly', annual, budget); // already negative if saved that way
      const curve = S.edchoice && Array.isArray(S.edchoice.curve) ? S.edchoice.curve.slice().sort((a,b)=>a.x-b.x) : null;
      if (!curve || curve.length < 2) return 0;
      if (annual <= curve[0].x) return -__clampNum(curve[0].y);
      if (annual >= curve[curve.length-1].x) return -__clampNum(curve[curve.length-1].y);
      let lo=0, hi=curve.length-1;
      while (hi - lo > 1){ const mid=(lo+hi)>>1; if (curve[mid].x <= annual) lo=mid; else hi=mid; }
      const p0=curve[lo], p1=curve[hi];
      const t = (annual - p0.x) / Math.max(1, p1.x - p0.x);
      return -( __clampNum(p0.y) + t*( __clampNum(p1.y) - __clampNum(p0.y) ) );
    }
    function availableAt(annual, budget){
      const net = sampleNetAnnual(annual, budget);
      const snap = sampleVec('snap_yearly', annual, budget);
      const frl  = sampleVec('frl_yearly',  annual, budget);
      const health = sampleVec('healthcare_yearly', annual, budget);   // negative cost
      const cc     = sampleVec('childcare_yearly',  annual, budget);   // negative cost
      const pipp   = sampleVec('pipp_yearly',       annual, budget);   // negative cost
      const idr = (budget.idrPlan === 'ICR' && Array.isArray((budget._series||{}).idr_icr_yearly))
        ? sampleVec('idr_icr_yearly', annual, budget)
        : (Array.isArray((budget._series||{}).idr_ibr_yearly) ? sampleVec('idr_ibr_yearly', annual, budget) : 0);
      const ed = sampleEdChoiceYearly(annual, budget);                 // negative cost
      return net + snap + frl + health + cc + pipp + idr + ed;
    }





//START INDIVIDUAL BENEFITS

    // ========== 1. SNAP (Ohio) – Benefit vs Income (Annual X, Monthly Y) ==========
    function startSnapStep(userInfo, budget) {
      const app = document.getElementById("app");
    
      // --- Use family info collected earlier ---
      const HH = Math.min(Math.max(Number(userInfo.familySize) || 1, 1), 7);
      const hasElderly =
        Array.isArray(userInfo.members) && userInfo.members.some(m => Number(m.age) >= 60);
      const hasDisability = !!(userInfo.hasStateRecognizedDisability || hasElderly);
    
      // ---------- Helpers ----------
      function clampH(h){ return Math.min(Math.max(h,1),7); }
      function fmt(n){ return '$' + (Math.max(0, Math.round(n))).toLocaleString(); }
      function coalesce(...vals){
        for (const v of vals){
          const n = Number(v);
          if (Number.isFinite(n) && n >= 0) return n;
        }
        return 0;
      }
    
      // --- FY2025 Ohio max allotments (monthly, HH 1..7) ---
      const ALLOT = [292, 536, 768, 975, 1158, 1390, 1536];     // monthly
      const ALLOT_Y = ALLOT.map(x => x * 12);                   // yearly
    
      // Use your 130% FPL to derive 100% (net gate) & 200% (gross gate, Ohio BBCE)
      const LIMIT_130 = [1632, 2215, 2798, 3380, 3963, 4546, 5129]; // monthly 130% FPL
      const FPL_100   = LIMIT_130.map(v => Math.round(v / 1.3));    // monthly 100% FPL (net)
      const FPL_100_Y = FPL_100.map(v => v * 12);
      const GROSS_200   = FPL_100.map(v => v * 2);                  // monthly 200% FPL (gross)
      const GROSS_200_Y = GROSS_200.map(v => v * 12);


    
      // ---------- Net-income estimator (monthly) using Wizard params ----------
      function estimateSnapNetMonthlyFromWizard({ grossMo, hh, hasElderlyDisabled, userInfo, budget }){
        const H = clampH(hh);
        const idx = H - 1;
    
        // Param pack (prefer budget.params.snap if present)
        const P = (budget && budget.params && budget.params.snap) ? budget.params.snap : {};
    
        // Standard deduction by HH size (monthly)
        const DEFAULT_STD_DED_MONTHLY = [198,198,284,362,426,491,491];
        const rawStd =
          (Array.isArray(P.STD_DEDUCTION_MONTHLY) ? P.STD_DEDUCTION_MONTHLY[idx] : undefined) ??
          (Array.isArray(budget.STD_DEDUCTION_MONTHLY) ? budget.STD_DEDUCTION_MONTHLY[idx] : undefined);

        const STD_DED = (Number.isFinite(+rawStd) && +rawStd > 0)
          ? +rawStd
          : DEFAULT_STD_DED_MONTHLY[idx];


    
        // Shelter cap (monthly) — applies only if NOT elderly/disabled
        const SHELTER_CAP = coalesce(P.SHELTER_DED_CAP_MONTHLY, P.SHELTER_CAP_MONTHLY, budget.SHELTER_DED_CAP_MONTHLY);
    
        // Medical threshold (monthly) — only excess counts for elderly/disabled
        const MEDICAL_THRESHOLD = coalesce(P.MEDICAL_THRESHOLD_MONTHLY, budget.MEDICAL_THRESHOLD_MONTHLY, 35);
    
        // Standard Utility Allowance (heating/cooling)
        // If wizard didn't pass a value, use a conservative placeholder (can be tuned by state).
        const DEFAULT_SUA_HEAT_COOL_MO = Number(P.DEFAULT_SUA_HEAT_COOL_MO ?? budget.DEFAULT_SUA_HEAT_COOL_MO ?? 0) || 450;
        let SUA_HC = coalesce(
          P.SUA_HEAT_COOL_MO,
          budget.SUA_HEAT_COOL_MO,
          budget.utilitySUAmonthly,
          budget.utilitiesSUAmonthly,
          DEFAULT_SUA_HEAT_COOL_MO
        );
        if (!Number.isFinite(SUA_HC) || SUA_HC <= 0) SUA_HC = DEFAULT_SUA_HEAT_COOL_MO;

        // Earned-income deduction (fixed)
        const earnedDed = 0.20 * grossMo;
    
        // Wizard-collected monthly costs (pull from common keys you use)
        const rentMo = coalesce(
          budget.rentMonthly, budget.monthlyRent, budget.housingRentMonthly,
          budget.mortgageMonthly, budget.monthlyMortgage
        );
        const utilMo = coalesce(
          budget.utilitiesMonthly, budget.utilityMonthly, SUA_HC // default to SUA when unknown
        );
        const depcareMo = coalesce(
          budget.childcareMonthly, budget.dependentCareMonthly, userInfo.childcareMonthly
        );
        const childSupportOutMo = coalesce(
          budget.childSupportPaidMonthly, userInfo.childSupportPaidMonthly
        );
        const medicalGrossMo = hasElderlyDisabled
          ? coalesce(budget.medicalMonthly, userInfo.medicalMonthly)
          : 0;
    
        // Deductions before shelter
        const medicalExcess = hasElderlyDisabled ? Math.max(0, medicalGrossMo - MEDICAL_THRESHOLD) : 0;
    
        let adjBeforeShelter = Math.max(0,
          grossMo - earnedDed - STD_DED - childSupportOutMo - depcareMo - medicalExcess
        );
    
        // Excess shelter = (rent + utilities) - 50% * adjBeforeShelter
        const shelterCosts = rentMo + utilMo;
        let excessShelter = Math.max(0, shelterCosts - 0.5 * adjBeforeShelter);
    
        if (!hasElderlyDisabled && SHELTER_CAP > 0) {
          excessShelter = Math.min(excessShelter, SHELTER_CAP);
        }
    
        const netMo = Math.max(0, adjBeforeShelter - excessShelter);
        return netMo;
      }
    
      // ---------- SNAP core (benefit from NET; Ohio BBCE gates) ----------
      // INPUT: incomeAnnual (gross, yearly). OUTPUT: benefitYearly + gates + reason (for UI).
      function snapBenefitYearly(h, incomeAnnual, hasElderlyDisabled) {
        const H = clampH(h);
        const allotAnnual = ALLOT_Y[H-1];
    
        const grossMo     = Math.max(0, (incomeAnnual || 0) / 12);
        const netGateMo   = FPL_100[H-1];     // 100% FPL (net screen)
        const grossGateMo = GROSS_200[H-1];   // 200% FPL (gross screen)
        const usesGrossGate = !hasElderlyDisabled; // elderly/disabled households: no gross screen
    
        // 1) Gross screen (skip if elderly/disabled)
        if (usesGrossGate && grossMo > grossGateMo) {
          return {
            benefitYearly: 0,
            eligible: false,
            reason: 'gross>200%FPL',
            limitAnnual: GROSS_200_Y[H-1],  // used by your dashed vertical line
            allotAnnual
          };
        }
    
        // 2) Net screen (always)
        const netMo = estimateSnapNetMonthlyFromWizard({
          grossMo, hh: H, hasElderlyDisabled, userInfo, budget
        });
    
        if (netMo > netGateMo) {
          return {
            benefitYearly: 0,
            eligible: false,
            reason: 'net>100%FPL',
            limitAnnual: usesGrossGate ? GROSS_200_Y[H-1] : Number.POSITIVE_INFINITY,
            allotAnnual
          };
        }
    
        // 3) Benefit from NET income
        const maxMo = allotAnnual / 12;
        const expected = 0.30 * netMo;
        const benefitMo = Math.max(0, Math.round(maxMo - expected));
        const benefitYearly = Math.min(benefitMo * 12, allotAnnual);
    
        return {
          benefitYearly,
          eligible: true,
          reason: 'ok',
          limitAnnual: usesGrossGate ? GROSS_200_Y[H-1] : Number.POSITIVE_INFINITY,
          allotAnnual
        };
      }
    
      // ---- UI ----
      app.innerHTML = `
        <h2>SNAP (Ohio) — Benefit vs Income</h2>
        <p>
          <strong>Household:</strong> ${HH}
          ${hasDisability ? ' — elderly/disabled present' : ''}
        </p>
    
        <label>Try an <strong>annual salary</strong>:
          $<input type="number" id="snapIncomeAnnual" min="0" step="1" placeholder="e.g., 52000">
        </label>
    
        <div class="row"></div>
        <div id="snapKpis">
          <div><strong>SNAP estimate (yearly):</strong> <span id="snapVal">$0</span></div>
          <div class="small" id="snapGate">Enter salary</div>
        </div>
    
        <div class="row"></div>
        <svg id="snapSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="SNAP benefit curve"></svg>
    
        <div class="row"></div>
        <div class="note small">
          Ohio rules: gross screen at <strong>200% FPL</strong> (elderly/disabled households have <em>no</em> gross screen) and
          net screen at <strong>100% FPL</strong>. Benefit = max allotment − 30% of <em>net</em>.
          This estimate uses your Budget Wizard values (standard deduction, SUA, shelter cap, childcare, child support, medical).
        </div>
        
        <div id="snapStepsTable" class="card" style="margin-top:12px;"></div>
    
        <div class="row"></div>
        <button id="snapNext" class="primary">Next</button>
      `;
      pushStep(() => startSnapStep(userInfo, budget));
      
      // ---- $10k salary step table (0 → 150k) ----
      (function renderSnapStepTable(){
        const holder = document.getElementById('snapStepsTable');
        if (!holder) return;
    
        // 0..150k inclusive in $10k steps (16 rows)
        const salaries = Array.from({ length: 16 }, (_, i) => i * 10000); // 0..150000
    
        const rows = salaries.map(sal => {
          const { benefitYearly, eligible, allotAnnual } = snapBenefitYearly(HH, sal, hasDisability);
          const y = eligible ? benefitYearly : 0;
          const clamped = Math.min(allotAnnual, Math.max(0, Math.round(y)));
          return `<tr>
            <td>$${sal.toLocaleString()}</td>
            <td class="right">$${clamped.toLocaleString()}</td>
          </tr>`;
        }).join('');
    
        holder.innerHTML = `
          <h3 style="margin:0 0 8px">SNAP quick reference (by annual salary)</h3>
          <table class="tight">
            <thead>
              <tr><th>Annual salary</th><th class="right">SNAP est. (yearly)</th></tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
          <div class="small muted" style="margin-top:6px">
            Ohio BBCE: gross ≤ 200% FPL${hasDisability ? ' (gross screen skipped for elderly/disabled HH)' : ''},
            net ≤ 100% FPL; benefit = max allotment − 30% of net.
          </div>
        `;
      })();
    
    
      // ---- Draw the curve (SVG, no extra CSS) ----
      const svg = document.getElementById("snapSvg");
      const incomeAnnualInput = document.getElementById("snapIncomeAnnual");
      const snapVal = document.getElementById("snapVal");
      const snapGate = document.getElementById("snapGate");
    
      // Fixed display range and step
      const SNAP_A_MAX = 150000;        // X axis 0..150k inclusive
      const SNAP_GRAPH_STEP = 100;      // $100 increments
    
      // For axis labels/limits (independent probe)
      const { limitAnnual: gateXAnnual, allotAnnual: maxYAnnual } = snapBenefitYearly(HH, 1, hasDisability);
    
      const W = 720, H = 260, P = 40;
      const innerW = W - P*2, innerH = H - P*2;
    
      function xPix(annual){ return P + (annual / SNAP_A_MAX) * innerW; }
      function yPix(y){ return H - P - (y / maxYAnnual) * innerH; }
    
      function buildPath() {
        let d = '';
        for (let a = 0; a <= SNAP_A_MAX; a += SNAP_GRAPH_STEP) {
          const { benefitYearly, eligible } = snapBenefitYearly(HH, a, hasDisability);
          const yAnnual = eligible ? benefitYearly : 0;
          const b = Math.min(maxYAnnual, Math.max(0, yAnnual));
          const X = xPix(a), Y = yPix(b);
          d += (a === 0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        return d;
      }
    
      function drawBase() {
        svg.innerHTML = '';
    
        // axes
        const axisX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisX.setAttribute('x1', P); axisX.setAttribute('y1', H-P);
        axisX.setAttribute('x2', W-P); axisX.setAttribute('y2', H-P);
        axisX.setAttribute('stroke','currentColor'); axisX.setAttribute('stroke-width','1');
    
        const axisY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisY.setAttribute('x1', P); axisY.setAttribute('y1', P);
        axisY.setAttribute('x2', P); axisY.setAttribute('y2', H-P);
        axisY.setAttribute('stroke','currentColor'); axisY.setAttribute('stroke-width','1');
    
        // X ticks every $20k
        for (let x = 0; x <= SNAP_A_MAX; x += 20000){
          const X = xPix(x);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', X); t.setAttribute('y1', H-P);
          t.setAttribute('x2', X); t.setAttribute('y2', H-P+5);
          t.setAttribute('stroke','currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', X-14); label.setAttribute('y', H-P+18);
          label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
          label.textContent = `$${(x/1000).toFixed(0)}k`;
          svg.append(t, label);
        }
    
        // Y ticks every $10k (or $20k if tall)
        const yStep = (maxYAnnual <= 50_000 ? 10_000 : 20_000);
        for (let y = 0; y <= maxYAnnual; y += yStep){
          const Y = yPix(y);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', P-5); t.setAttribute('y1', Y);
          t.setAttribute('x2', P);   t.setAttribute('y2', Y);
          t.setAttribute('stroke','currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', 6); label.setAttribute('y', Y-2);
          label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
          label.textContent = `$${y.toLocaleString()}`;
          svg.append(t, label);
        }
    
        // dashed eligibility limit line only if there IS a finite gross gate
        if (Number.isFinite(gateXAnnual) && gateXAnnual >= 0 && gateXAnnual <= SNAP_A_MAX) {
          const vGate = document.createElementNS('http://www.w3.org/2000/svg','line');
          const gateXClamped = Math.max(0, Math.min(SNAP_A_MAX, gateXAnnual));
          vGate.setAttribute('x1', xPix(gateXClamped)); vGate.setAttribute('y1', P);
          vGate.setAttribute('x2', xPix(gateXClamped)); vGate.setAttribute('y2', H-P);
          vGate.setAttribute('stroke','currentColor');
          vGate.setAttribute('stroke-width','1');
          vGate.setAttribute('stroke-dasharray','4 4');
          svg.appendChild(vGate);
        }

    
        // curve
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', buildPath());
        path.setAttribute('fill','none');
        path.setAttribute('stroke','currentColor');
        path.setAttribute('stroke-width','2');
    
        // marker for chosen income
        const marker = document.createElementNS('http://www.w3.org/2000/svg','circle');
        marker.setAttribute('id','snapMarker');
        marker.setAttribute('r','4');
        marker.setAttribute('fill','currentColor');
    
        // endpoint labels (Yearly)
        const yLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        yLabel.setAttribute('x', P + 4); yLabel.setAttribute('y', yPix(maxYAnnual) - 6);
        yLabel.setAttribute('font-size','10'); yLabel.setAttribute('fill','currentColor');
        yLabel.textContent = fmt(maxYAnnual);
    
        const xLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLabel.setAttribute('x', xPix(SNAP_A_MAX) - 44); xLabel.setAttribute('y', H - P + 14);
        xLabel.setAttribute('font-size','10'); xLabel.setAttribute('fill','currentColor');
        xLabel.textContent = fmt(SNAP_A_MAX);
    
        // axis titles
        const xTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        xTitle.setAttribute('x', P + innerW/2 - 36); xTitle.setAttribute('y', H - 8);
        xTitle.setAttribute('font-size','12'); xTitle.setAttribute('fill','currentColor');
        xTitle.textContent = 'Annual salary';
    
        const yTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        yTitle.setAttribute('x', 10); yTitle.setAttribute('y', P + innerH/2);
        yTitle.setAttribute('font-size','12'); yTitle.setAttribute('fill','currentColor');
        yTitle.setAttribute('transform', `rotate(-90, 10, ${P + innerH/2})`);
        yTitle.textContent = 'Yearly benefit amount';
    
        svg.append(axisX, axisY, path, marker, yLabel, xLabel, xTitle, yTitle);
      }
    
      function updateFromInput() {
        const annual = Number(incomeAnnualInput.value) || 0;
        const res = snapBenefitYearly(HH, annual, hasDisability);
        const b = Math.min(maxYAnnual, Math.max(0, Math.round(res.eligible ? res.benefitYearly : 0)));
    
        snapVal.textContent = fmt(b);
    
        const netGateAnnual = FPL_100_Y[HH-1];
        if (!annual) {
          snapGate.textContent = 'Enter salary';
        } else if (res.eligible) {
          snapGate.textContent = hasDisability
            ? `Eligible (no gross screen; net ≤ ${fmt(netGateAnnual)})`
            : `Eligible (gross ≤ ${fmt(gateXAnnual)} & net ≤ ${fmt(netGateAnnual)})`;
        } else {
          snapGate.textContent =
            res.reason === 'gross>200%FPL'
              ? `Not eligible (gross > ${fmt(gateXAnnual)})`
              : `Not eligible (net > ${fmt(netGateAnnual)})`;
        }
    
        // move marker (clamp to 0..SNAP_A_MAX)
        const marker = document.getElementById('snapMarker');
        const annualClamped = Math.min(Math.max(annual, 0), SNAP_A_MAX);
        const res2 = snapBenefitYearly(HH, annualClamped, hasDisability);
        marker.setAttribute('cx', xPix(annualClamped));
        marker.setAttribute('cy', yPix(Math.min(maxYAnnual, Math.max(0, res2.eligible ? res2.benefitYearly : 0))));
      }
    
      drawBase();
      updateFromInput();
    
      // ---- Save a YEARLY series for the final roll-up (0..150k in $100 steps) ----
      (function saveSnapSeries(){
        const salaries = [];
        for (let a = 0; a <= SNAP_A_MAX; a += SNAP_GRAPH_STEP) salaries.push(a);
    
        const snapYearly = salaries.map(a => {
          const { benefitYearly, eligible } = snapBenefitYearly(HH, a, hasDisability);
          const y = eligible ? benefitYearly : 0;
          return Math.min(maxYAnnual, Math.max(0, Math.round(y)));
        });
    
        // Enforce $0 intercept explicitly (full yearly allotment)
        snapYearly[0] = maxYAnnual;
    
        budget._salaries = salaries;                 // yearly salary grid (0..150k by $100)
        budget._series = budget._series || {};
        budget._series.snap_yearly = snapYearly;     // canonical yearly SNAP series
      })();
    
    
      // Events
      incomeAnnualInput.addEventListener('input', updateFromInput);
    
      document.getElementById("snapNext").addEventListener("click", () => {
        alert("SNAP step complete. Moving on…");
        goNextBenefit('snap', userInfo, budget);
      }, { once:true });
    }






    // ========== 2. Healthcare Costs (Ohio) – Medicaid vs Private (Annual X / Yearly Total Y) ==========
    function startHealthcareCostStep(userInfo, budget) {
      // Skip Healthcare if not selected (i.e., not willing to apply for Medicaid)
      if (!willing(userInfo, budget).healthcare) {
        return goNextBenefit('healthcare', userInfo, budget);
      }
    
      const app = document.getElementById("app");
    
      // --- Household / demographics from earlier steps ---
      const members = Array.isArray(userInfo.members) ? userInfo.members : [];
      const ages = members.map(m => Number(m.age) || 0);
      const H = Math.min(Math.max(Number(userInfo.familySize) || ages.length || 1, 1), 7);
    
      // per-person flags the Medicaid check needs
      const flags = members.map(m => ({
        pregnant: !!m.pregnant,
        disabled: false,
        childHasOtherInsurance: false
      }));
      if (userInfo.hasStateRecognizedDisability && ages.length > 0) {
        let idx = ages.findIndex(a => a >= 19);
        if (idx === -1) idx = 0;
        flags[idx].disabled = true;
      }
    
      // If we don't have members for some reason, fall back to a single adult 30yo
      if (ages.length === 0) {
        ages.push(30);
        flags.push({ pregnant:false, disabled:false, childHasOtherInsurance:false });
      }
    
      // If the user already entered a private premium earlier, we can use it as an override when needed
      const employerPremiumOverride =
        Number.isFinite(budget.insPremium) && budget.insPremium > 0 ? Number(budget.insPremium) : null;
    
      // Whether to apply Medicaid when eligible: respect earlier "willing to apply"
      const applyMedicaid = budget.medicaidWilling === true;
    
      // -------- Medicaid monthly limit tables (Ohio, 2025) --------
      // Index from 1..7 (slot 0 unused)
      const ADULT_19_64   = [ , 1735, 2345, 2954, 3564, 4173, 4783, 5393 ];
      const PARENTS       = [ , 1174, 1587, 1999, 2412, 2824, 3237, 3649 ];
      const PREGNANT      = [ , 2609, 3525, 4442, 5359, 6275, 7192, 8109 ];
      const CHILD_NOINS   = [ , 2687, 3631, 4575, 5520, 6464, 7408, 8352 ];
      const CHILD_WITHINS = [ , 2035, 2750, 3465, 4180, 4895, 5610, 6325 ];
    
      // ABD references (simplified placeholders)
      const MBIWD_250FPL_INDIV = 3261; // workers w/ disabilities
      const ABD_SIL_LTC = 2901;        // LTC/waiver income level per individual
    
      function medicaidEligibilityOH(person, HH, monthlyMAGI){
        HH = Math.min(Math.max(HH,1), 7);
    
        if (person.pregnant) {
          const lim = PREGNANT[HH];
          return { pathway:'Pregnancy', eligible: monthlyMAGI <= lim, limit: lim };
        }
    
        if (person.age < 19) {
          const lim = (person.childHasOtherInsurance ? CHILD_WITHINS : CHILD_NOINS)[HH];
          return {
            pathway: person.childHasOtherInsurance ? 'Child (w/ insurance)' : 'Child (no insurance)',
            eligible: monthlyMAGI <= lim, limit: lim
          };
        }
    
        if (person.age >= 19 && person.age <= 64) {
          const limAdult = ADULT_19_64[HH];
          if (monthlyMAGI <= limAdult) return { pathway:'Adult (19–64)', eligible:true, limit:limAdult };
          if (person.disabled) {
            return { pathway:'MBIWD (worker w/ disability)', eligible: monthlyMAGI <= MBIWD_250FPL_INDIV, limit: MBIWD_250FPL_INDIV };
          }
          return { pathway:'Adult (19–64)', eligible:false, limit:limAdult };
        }
    
        if (person.age >= 65 || person.disabled) {
          return { pathway:'ABD / LTC', eligible: monthlyMAGI <= ABD_SIL_LTC, limit: ABD_SIL_LTC };
        }
    
        return { pathway:'Unknown', eligible:false, limit:null };
      }
    
      // --- Private premium estimate (only if NO Medicaid used) ---
      function baseRate(age){
        if (age <= 18) return 180;
        if (age <= 24) return 260;
        if (age <= 34) return 320;
        if (age <= 44) return 400;
        if (age <= 54) return 520;
        return 700; // 55–64
      }
      // Family rule: charge at most 3 kids (<=18), 10% discount if >1 person
      function estimateFamilyPremium(allAges){
        const kids = allAges.filter(a => a <= 18).length;
        const adults = allAges.filter(a => a > 18);
        let sum = adults.reduce((s,a)=> s + baseRate(a), 0);
        let chargeKids = Math.min(3, kids);
        for (let i=0; i<chargeKids; i++) sum += baseRate(10); // kid rate
        if (allAges.length > 1) sum *= 0.90;
        return Math.round(sum);
      }
    
      // --- OOP heuristic (returns MONTHLY; we’ll ×12 later) ---
      function estimateOOPMonthly(annualIncome){
        if (annualIncome <= 30000) {
          return 90;
        } else if (annualIncome <= 70000) {
          const t = (annualIncome - 30000) / (70000 - 30000);
          return Math.round(90 + t * (220 - 90));
        } else if (annualIncome <= 110000) {
          const t = (annualIncome - 70000) / (110000 - 70000);
          return Math.round(220 + t * (180 - 220));
        } else {
          return 150;
        }
      }
    
      // ===== Yearly total now (premiums + OOP per year) =====
      function computeHealthcareYearlyTotal({ monthlyMAGI, annualIncome }){
        const elig = ages.map((age, i) => {
          const p = { age, ...flags[i] };
          return !!medicaidEligibilityOH(p, H, monthlyMAGI).eligible;
        });
        const anyMedicaid = elig.some(Boolean);
    
        if (applyMedicaid && anyMedicaid){
          return {
            premiumYearly: 0,
            oopYearly: 0,
            totalYearly: 0,
            mode: 'Medicaid',
            note: 'At least one member appears Medicaid-eligible; we treat HH as fully on Medicaid here.'
          };
        }
    
        // Private path
        const premiumMonthly = Number.isFinite(employerPremiumOverride) && employerPremiumOverride > 0
          ? Math.round(employerPremiumOverride)
          : estimateFamilyPremium(ages);
    
        const oopMonthly = estimateOOPMonthly(annualIncome);
    
        return {
          premiumYearly: premiumMonthly * 12,
          oopYearly: oopMonthly * 12,
          totalYearly: premiumMonthly * 12 + oopMonthly * 12,
          mode: 'Private',
          note: (Number.isFinite(employerPremiumOverride) && employerPremiumOverride > 0)
            ? 'Using your current private insurance premium (override).'
            : 'Estimated private family premium; OOP includes typical copays/deductibles.'
        };
      }
    
      // -------- UI --------
      app.innerHTML = `
        <h2>Healthcare Costs — Medicaid vs Private (Ohio)</h2>
        <p><strong>Household:</strong> ${H} &nbsp;|&nbsp; <strong>Members:</strong> ${ages.length}
          ${budget.medicaidWilling ? ' &nbsp;|&nbsp; <em>Medicaid: willing to apply</em>' : ''}</p>
    
        <label>Try an <strong>annual salary</strong>:
          $<input type="number" id="hcIncome" min="0" step="1000" placeholder="e.g., 52000">
        </label>
    
        <div class="row"></div>
        <div id="hcKpis">
          <div><strong>Yearly premium + OOP:</strong> <span id="hcPremium">$0</span></div>
          <div class="small" id="hcMode">—</div>
        </div>
    
        <div class="row"></div>
        <svg id="hcSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="Healthcare cost curve"></svg>
    
        <div class="row"></div>
        <div id="hcTableWrap"></div>
    
        <div class="row"></div>
        <div class="note small">
          Model: If anyone in the household is Medicaid-eligible <em>and</em> you chose to apply, total cost is $0.
          Otherwise, we estimate a private family premium (no ACA subsidies in this step) plus typical yearly out-of-pocket.
          OOP uses a simple heuristic that declines modestly at higher salaries to reflect access to better employer plans.
        </div>
    
        <div class="row"></div>
        <button id="hcNext" class="primary">Next</button>
      `;
      pushStep(() => startHealthcareCostStep(userInfo, budget));
    
      const incomeEl = document.getElementById('hcIncome');
      const premiumEl = document.getElementById('hcPremium');
      const modeEl = document.getElementById('hcMode');
      const svg = document.getElementById('hcSvg');
    
    
    
    // ---- Build data: curve (annual 0..150k by $100) + table (every $10k) ----
    const A_MAX = 150000;          // annual income ceiling (x-axis)
    const GRAPH_STEP = 100;        // $100 increments (0..150k inclusive)
    
    // Salary grid used for the curve
    const salaryGrid = [];
    for (let a = 0; a <= A_MAX; a += GRAPH_STEP) salaryGrid.push(a);
    
    // Curve points at $100 (YEARLY Y)
    const curvePts = [];
    let yMax = 0;
    for (const annual of salaryGrid) {
      const r = computeHealthcareYearlyTotal({ monthlyMAGI: annual / 12, annualIncome: annual });
      const yearly = r.totalYearly;
      curvePts.push({ annual, yearly });
      if (yearly > yMax) yMax = yearly;
    }
    if (yMax < 1200) yMax = 1200; // avoid tiny axis
    
    // Table at $10k increments (YEARLY Y)
    const tableRows = [];
    for (let annual = 0; annual <= A_MAX; annual += 10000) {
      const r = computeHealthcareYearlyTotal({ monthlyMAGI: annual / 12, annualIncome: annual });
      tableRows.push({ annual, yearly: r.totalYearly });
    }

    
    // ---- Save a canonical YEARLY vector for final roll-up (costs negative) ----
    budget._series = budget._series || {};
    
    // Reuse an existing global grid if present; otherwise install this $100 grid
    const grid = Array.isArray(budget._salaries) && budget._salaries.length
      ? budget._salaries
      : salaryGrid.slice();
    
    if (!budget._salaries) budget._salaries = grid;
    
    // Build healthcare_yearly aligned to the grid (negative = cost)
    const healthcare_yearly = grid.map(a => {
      const r = computeHealthcareYearlyTotal({ monthlyMAGI: a / 12, annualIncome: a });
      return -Math.round(r.totalYearly); // store costs as negative for the final sum
    });
    
    budget._series.healthcare_yearly = healthcare_yearly;
    
    // (Optional: keep human-readable metadata, not used in the roll-up math)
    budget._series_meta = budget._series_meta || {};
    budget._series_meta.healthcare = {
      grid_step: GRAPH_STEP,
      applyMedicaid,
      usedOverride: Number.isFinite(employerPremiumOverride) && employerPremiumOverride > 0,
      oopHeuristic: '12× of (90→220 monthly ramp at 30–70k, easing to 150/mo at ≥110k)'
    };

      // ---- Render SVG curve (with axis titles) ----
      const W = 720, Hpx = 260, P = 40;
      const innerW = W - P*2, innerH = Hpx - P*2;
    
      function xPix(annual){ return P + (annual / A_MAX) * innerW; }
      function yPix(yearly){ return Hpx - P - (yearly / yMax) * innerH; }
    
      function drawCurve() {
        svg.innerHTML = '';
    
        const axisX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisX.setAttribute('x1', P); axisX.setAttribute('y1', Hpx-P);
        axisX.setAttribute('x2', W-P); axisX.setAttribute('y2', Hpx-P);
        axisX.setAttribute('stroke','currentColor'); axisX.setAttribute('stroke-width','1');
    
        const axisY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisY.setAttribute('x1', P); axisY.setAttribute('y1', P);
        axisY.setAttribute('x2', P); axisY.setAttribute('y2', Hpx-P);
        axisY.setAttribute('stroke','currentColor'); axisY.setAttribute('stroke-width','1');
    
    // X ticks every $20k
    for (let x = 0; x <= SNAP_A_MAX; x += 20000){
      const X = xPix(x);
      const t = document.createElementNS('http://www.w3.org/2000/svg','line');
      t.setAttribute('x1', X); t.setAttribute('y1', H-P);
      t.setAttribute('x2', X); t.setAttribute('y2', H-P+5);
      t.setAttribute('stroke','currentColor');
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', X-14); label.setAttribute('y', H-P+18);
      label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
      label.textContent = `$${(x/1000).toFixed(0)}k`;
      svg.append(t, label);
    }
    
    // Y ticks every $10k (or $20k if tall)
    const yStep = (maxYAnnual <= 50_000 ? 10_000 : 20_000);
    for (let y = 0; y <= maxYAnnual; y += yStep){
      const Y = yPix(y);
      const t = document.createElementNS('http://www.w3.org/2000/svg','line');
      t.setAttribute('x1', P-5); t.setAttribute('y1', Y);
      t.setAttribute('x2', P);   t.setAttribute('y2', Y);
      t.setAttribute('stroke','currentColor');
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', 6); label.setAttribute('y', Y-2);
      label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
      label.textContent = `$${y.toLocaleString()}`;
      svg.append(t, label);
    }

    
        // Build path (YEARLY Y)
        let d = '';
        for (let i = 0; i < curvePts.length; i++) {
          const { annual, yearly } = curvePts[i];
          const X = xPix(annual), Y = yPix(yearly);
          d += (i === 0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', 'currentColor');
        path.setAttribute('stroke-width', '2');
    
        // Marker
        const marker = document.createElementNS('http://www.w3.org/2000/svg','circle');
        marker.setAttribute('id','hcMarker');
        marker.setAttribute('r','4');
        marker.setAttribute('fill','currentColor');
    
        // Endpoint labels
        const yLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        yLabel.setAttribute('x', P + 4); yLabel.setAttribute('y', yPix(yMax) - 6);
        yLabel.setAttribute('font-size','10'); yLabel.setAttribute('fill','currentColor');
        yLabel.textContent = '$' + Math.round(yMax).toLocaleString();
    
        const xLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLabel.setAttribute('x', xPix(A_MAX) - 44);
        xLabel.setAttribute('y', Hpx - P + 14);
        xLabel.setAttribute('font-size','10'); xLabel.setAttribute('fill','currentColor');
        xLabel.textContent = '$' + (A_MAX).toLocaleString();
    
        // Axis titles
        const xTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        xTitle.setAttribute('x', W/2); xTitle.setAttribute('y', Hpx - 6);
        xTitle.setAttribute('text-anchor','middle');
        xTitle.setAttribute('font-size','12'); xTitle.setAttribute('fill','currentColor');
        xTitle.textContent = 'Annual salary';
    
        const yTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        yTitle.setAttribute('x', 16); yTitle.setAttribute('y', Hpx/2);
        yTitle.setAttribute('text-anchor','middle');
        yTitle.setAttribute('font-size','12'); yTitle.setAttribute('fill','currentColor');
        yTitle.setAttribute('transform', `rotate(-90 16 ${Hpx/2})`);
        yTitle.textContent = 'Yearly premium + OOP';
    
        svg.append(axisX, axisY, path, marker, yLabel, xLabel, xTitle, yTitle);
      }
    
      function fmt(n){ return '$' + (Math.max(0, Math.round(n))).toLocaleString(); }
    
      function updateFromInput(){
        const annualIncome = Number(incomeEl.value) || 0;
        const r = computeHealthcareYearlyTotal({ monthlyMAGI: annualIncome/12, annualIncome });
        premiumEl.textContent = fmt(r.totalYearly);
        modeEl.textContent = r.mode === 'Medicaid'
          ? 'Using Medicaid (household-level simplification)'
          : r.note;
    
        // move marker on curve (YEARLY Y)
        const marker = document.getElementById('hcMarker');
        const annual = Math.max(0, Math.min(A_MAX, annualIncome));
        const curveCostYearly = computeHealthcareYearlyTotal({ monthlyMAGI: annual/12, annualIncome: annual }).totalYearly;
        marker.setAttribute('cx', xPix(annual));
        marker.setAttribute('cy', yPix(curveCostYearly));
      }
    
      drawCurve();
      updateFromInput();
    
      // ---- Render table (every $10,000) ----
      const wrap = document.getElementById('hcTableWrap');
      let html = `<table style="width:100%; border-collapse:collapse;">
        <thead><tr>
          <th style="text-align:left; padding:6px;">Annual income</th>
          <th style="text-align:left; padding:6px;">Yearly premium + OOP</th>
        </tr></thead><tbody>`;
      for (const row of tableRows) {
        html += `<tr>
          <td style="padding:6px;">$${row.annual.toLocaleString()}</td>
          <td style="padding:6px;">$${Math.round(row.yearly).toLocaleString()}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      wrap.innerHTML = html;
    
      // Wire input & next
      incomeEl.addEventListener('input', updateFromInput);
      document.getElementById('hcNext').addEventListener('click', () => {
        alert('Healthcare step complete. Moving on…');
        goNextBenefit('healthcare', userInfo, budget);
      }, { once:true });
    }






    // ========== 3. WIC ==========
    
    /* === [V9 WIC COUNTS CONSTANTS — BEGIN] === */
    // Mothers (retail grocery value of the food package)
    const WIC_PREGNANT_MONTHLY         = 85;   // pregnant woman (singleton)
    const WIC_BF_MOM_SINGLETON_MONTHLY = 95;   // breastfeeding mother, one baby
    const WIC_BF_MOM_TWINS_MONTHLY     = 140;  // ~1.5x package for multiples
    
    // Infants 6–11 months (small baby-food package: cereal + purees)
    const WIC_INFANT_6_11_BABYFOOD_MONTHLY = 30; // small offset (not $100)
    
    // Children 1–4 years (per child)
    const WIC_CHILD_1_4_MONTHLY = 90; // stacks per child; WIC cuts off at 5th birthday
    
    // Formula (if NOT covered by WIC → negative cost in this step)
    const WIC_FORMULA_NOT_COVERED_MONTHLY = 120;
    /* === [V9 WIC COUNTS CONSTANTS — END] === */
    
    
    /* === [WIC helpers — BEGIN] === */
    function _wicClampH(h){ return Math.min(Math.max(Number(h)||1,1),7); }
    
    // Pull gross monthly from common fields (wizard/budget/userInfo)
    function _wicGrossMonthly(userInfo, budget){
      const a12 = x => (Number.isFinite(+x) ? (+x)/12 : NaN);
      const candidates = [
        budget?.grossMonthly, budget?.incomeMonthly, budget?.salaryMonthly,
        userInfo?.grossMonthly, userInfo?.incomeMonthly,
        a12(budget?.incomeAnnual), a12(budget?.salaryAnnual),
        a12(userInfo?.incomeAnnual), a12(userInfo?.salaryAnnual)
      ];
      for (const v of candidates){
        const n = Number(v);
        if (Number.isFinite(n)) return n;
      }
      return 0;
    }
    
    // Derive HH 185% FPL monthly (reuse SNAP’s 130% list to get 100%→185%)
    const WIC_LIMIT_130 = [1632,2215,2798,3380,3963,4546,5129];      // 130% FPL, monthly (HH 1..7)
    const WIC_FPL_100   = WIC_LIMIT_130.map(v => Math.round(v / 1.3));
    const WIC_FPL_185   = WIC_FPL_100.map(v => Math.round(v * 1.85));
    
    // Income gate: gross monthly ≤ 185% FPL for HH size
    function _wicEligibleByIncome(userInfo, budget){
      const H   = _wicClampH(userInfo?.familySize);
      const lim = WIC_FPL_185[H-1];
      const gm  = Math.max(0, _wicGrossMonthly(userInfo, budget));
      // Treat missing/zero income as eligible (adjust if you prefer strictness)
      return gm > 0 ? gm <= lim : true;
    }
    
    // Count kids age 1–4 (WIC ends at 5th birthday)
    function _wicCountChildren1to4(userInfo){
      const pool = []
        .concat(Array.isArray(userInfo?.children) ? userInfo.children : [])
        .concat(Array.isArray(userInfo?.members)  ? userInfo.members  : []);
      const seen = new Set();
      let count = 0;
      for (let i=0;i<pool.length;i++){
        const a = Number(pool[i]?.age);
        const nm = (pool[i]?.name || pool[i]?.first || pool[i]?.nickname || `child${i}`).toLowerCase().trim();
        const key = `${nm}:${a}`;
        if (seen.has(key)) continue;
        seen.add(key);
        if (Number.isFinite(a) && a >= 1 && a < 5) count++;
      }
      return count;
    }
    /* === [WIC helpers — END] === */
    
    
    /* === [computeWicYearlyFromCounts — BEGIN] === */
    /**
     * Net WIC benefit (YEARLY) from household counts.
     * If willing AND income-eligible → add packages; always subtract uncovered formula.
     */
    function computeWicYearlyFromCounts(userInfo, budget) {
      const wc = (budget?.benefits?.wicCounts) || {};
      const willing  = !!wc.willingToApply;
      const eligible = _wicEligibleByIncome(userInfo, budget);
    
      const n = (x) => Math.max(0, Number.isFinite(+x) ? Math.floor(+x) : 0);
      const formulaMonthly = n(wc.numFormulaNotCovered) * WIC_FORMULA_NOT_COVERED_MONTHLY;
    
      // If not willing or not income-eligible → only subtract uncovered formula
      if (!willing || !eligible) return Math.round(12 * (0 - formulaMonthly));
    
      // Split BF moms into twins vs singleton
      const bfTwins = Math.min(n(wc.numBfMomsTwins), n(wc.numBfMoms));
      const bfSingletonMoms = Math.max(0, n(wc.numBfMoms) - bfTwins);
    
      let monthly = 0;
      monthly += n(wc.numPregnant)     * WIC_PREGNANT_MONTHLY;
      monthly += bfSingletonMoms       * WIC_BF_MOM_SINGLETON_MONTHLY;
      monthly += bfTwins               * WIC_BF_MOM_TWINS_MONTHLY;
      monthly += n(wc.numInfants6to11) * WIC_INFANT_6_11_BABYFOOD_MONTHLY;
      monthly += n(wc.numChildren1to4) * WIC_CHILD_1_4_MONTHLY;
    
      monthly -= formulaMonthly;
      return Math.round(monthly * 12);
    }
    /* === [computeWicYearlyFromCounts — END] === */
    
    
    /* === [startWICStepCounts — BEGIN] === */
    function startWICStepCounts(userInfo, budget){
      const app = document.getElementById('app');
      budget.benefits ||= {};
    
      // Pull willingness from earlier wizard if present
      const willingFromWizard =
        budget?.benefits?.willingness?.wic ??
        userInfo?.willingForWIC ??
        true;
    
      // AUTOFILL children ages 1–4
      const autoKids1to4 = _wicCountChildren1to4(userInfo);
    
      const wc = (budget.benefits.wicCounts ||= {
        numPregnant: 0,
        numBfMoms: 0,
        numBfMomsTwins: 0,
        numInfants6to11: 0,
        numChildren1to4: autoKids1to4, // autofill
        numFormulaNotCovered: 0,
        willingToApply: !!willingFromWizard
      });
    
      const nval = v => Math.max(0, Math.floor(Number(v)||0));
    
      app.innerHTML = `
        <h2>WIC (Women, Infants & Children) — Yearly Offset</h2>
        <p>Enter household counts. We model average <em>retail grocery value</em> of WIC packages. Benefits stack per eligible person. Child benefits end at the 5th birthday.</p>
    
        <div class="grid">
          <label><input id="wic_willing" type="checkbox" ${wc.willingToApply?'checked':''}>
            I’m willing to apply for WIC</label>
        </div>
    
        <div class="row"></div>
        <h3>Mothers</h3>
        <div class="grid grid-compact">
          <label>How many <strong>pregnant</strong> women?
            <input id="wic_numPregnant" type="number" min="0" step="1" value="${wc.numPregnant}">
          </label>
          <label>How many <strong>breastfeeding mothers</strong> (0–11 months postpartum)?
            <input id="wic_numBfMoms" type="number" min="0" step="1" value="${wc.numBfMoms}">
          </label>
          <label>…of those, how many are <strong>nursing twins</strong>?
            <input id="wic_numBfMomsTwins" type="number" min="0" step="1" value="${wc.numBfMomsTwins}">
          </label>
        </div>
    
        <div class="row"></div>
        <h3>Infants & Children</h3>
        <div class="grid grid-compact">
          <label>How many <strong>babies 6–11 months</strong>? (small baby-food package)
            <input id="wic_numInfants6to11" type="number" min="0" step="1" value="${wc.numInfants6to11}">
          </label>
          <label>How many <strong>children 1–4 years</strong>? (WIC ends at 5th birthday)
            <input id="wic_numChildren1to4" type="number" min="0" step="1" value="${wc.numChildren1to4}">
          </label>
        </div>
    
        <div class="row"></div>
        <h3>Formula (only if NOT covered by WIC)</h3>
        <div class="grid grid-compact">
          <label>How many infants are using formula <strong>not covered</strong> by WIC?
            <input id="wic_numFormulaNotCovered" type="number" min="0" step="1" value="${wc.numFormulaNotCovered}">
          </label>
          <div class="small muted">We subtract a typical uncovered formula cost of $${WIC_FORMULA_NOT_COVERED_MONTHLY}/month per infant.</div>
        </div>
    
        <div class="row"></div>
        <div id="wicKpis"><strong>Yearly WIC offset:</strong> <span id="wicYearly">$0</span> <span class="small muted">(~$<span id="wicMonthly">0</span>/mo)</span></div>
    
        <div class="row"></div>
        <svg id="wicSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="WIC yearly offset curve"></svg>
    
        <div class="row"></div>
        <div id="wicTableWrap"></div>
    
        <div class="row"></div>
        <div class="note small">
          Eligibility is generally ≤ <strong>185% FPL</strong> by household size (adjunctive eligibility may also qualify).
          Package values are categorical; income affects <em>eligibility</em>, not package size.
        </div>
    
        <div class="row"></div>
        <button id="wicBack">Back</button>
        <button id="wicNext" class="primary">Save & Continue</button>
      `;
      pushStep(() => startWICStepCounts(userInfo, budget));
    
      // ---- read & KPIs
      function readAndClamp(){
        wc.willingToApply       = !!document.getElementById('wic_willing').checked;
        wc.numPregnant          = nval(document.getElementById('wic_numPregnant').value);
        wc.numBfMoms            = nval(document.getElementById('wic_numBfMoms').value);
        wc.numBfMomsTwins       = Math.min(nval(document.getElementById('wic_numBfMomsTwins').value), wc.numBfMoms);
        wc.numInfants6to11      = nval(document.getElementById('wic_numInfants6to11').value);
        wc.numChildren1to4      = nval(document.getElementById('wic_numChildren1to4').value);
        wc.numFormulaNotCovered = nval(document.getElementById('wic_numFormulaNotCovered').value);
      }
      function refreshKpis(){
        const y = computeWicYearlyFromCounts(userInfo, budget);
        document.getElementById('wicYearly').textContent  = '$' + y.toLocaleString();
        document.getElementById('wicMonthly').textContent = Math.round(y/12).toLocaleString();
      }
    
      // ---- graph + table + saved vector
      const A_MAX = 150000, GRAPH_STEP = 100, TABLE_STEP = 10000;
      const svg = document.getElementById('wicSvg');
      const tableWrap = document.getElementById('wicTableWrap');
    
      function yearlyAtIncome(a){
        // probe income by temporarily supplying annual income
        const u = Object.assign({}, userInfo, { incomeAnnual: a });
        return computeWicYearlyFromCounts(u, budget);
      }
    
      let curve = [], yMax = 0;
      function rebuildCurveAndSave(){
        const grid = (Array.isArray(budget._salaries) && budget._salaries.length)
          ? budget._salaries
          : Array.from({ length: (A_MAX/GRAPH_STEP)+1 }, (_,i)=> i*GRAPH_STEP);
        if (!budget._salaries) budget._salaries = grid;
    
        const wicYearly = [];
        curve = [];
        yMax = 0;
    
        for (const a of grid){
          const y = yearlyAtIncome(a);
          curve.push({ annual:a, yearly:y });
          wicYearly.push(Math.max(0, y));
          if (y > yMax) yMax = y;
        }
        if (yMax < 200) yMax = 200;
    
        budget._series = budget._series || {};
        budget._series.wic_yearly = wicYearly;
      }
    
      function drawCurve(){
        const W = 720, H = 260, P = 40;
        const innerW = W - P*2, innerH = H - P*2;
        const xPix = a => P + (a / A_MAX) * innerW;
        const yPix = y => H - P - (y / yMax) * innerH;
    
        svg.innerHTML = '';
    
        const axX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axX.setAttribute('x1', P); axX.setAttribute('y1', H-P);
        axX.setAttribute('x2', W-P); axX.setAttribute('y2', H-P);
        axX.setAttribute('stroke','currentColor');
    
        const axY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axY.setAttribute('x1', P); axY.setAttribute('y1', P);
        axY.setAttribute('x2', P); axY.setAttribute('y2', H-P);
        axY.setAttribute('stroke','currentColor');
    
        // X ticks every $20k
        for (let x = 0; x <= A_MAX; x += 20000){
          const X = xPix(x);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', X); t.setAttribute('y1', H-P);
          t.setAttribute('x2', X); t.setAttribute('y2', H-P+5);
          t.setAttribute('stroke','currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', X-14); label.setAttribute('y', H-P+18);
          label.setAttribute('font-size','10');
          label.textContent = `$${(x/1000).toFixed(0)}k`;
          svg.append(t, label);
        }
    
        // Y ticks every $10k (or $20k if tall)
        const yStep = (yMax <= 50_000 ? 10_000 : 20_000);
        for (let y = 0; y <= yMax; y += yStep){
          const Y = yPix(y);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', P-5); t.setAttribute('y1', Y);
          t.setAttribute('x2', P);   t.setAttribute('y2', Y);
          t.setAttribute('stroke','currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', 6); label.setAttribute('y', Y-2);
          label.setAttribute('font-size','10');
          label.textContent = `$${y.toLocaleString()}`;
          svg.append(t, label);
        }
    
        // Curve
        let d = '';
        for (let i=0;i<curve.length;i++){
          const X = xPix(curve[i].annual), Y = yPix(curve[i].yearly);
          d += (i===0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','currentColor');
        path.setAttribute('stroke-width','2');
    
        // Dashed 185% FPL gate (yearly)
        const gateAnnual = WIC_FPL_185[_wicClampH(userInfo.familySize)-1] * 12;
        if (gateAnnual >= 0 && gateAnnual <= A_MAX){
          const vGate = document.createElementNS('http://www.w3.org/2000/svg','line');
          vGate.setAttribute('x1', xPix(gateAnnual)); vGate.setAttribute('y1', P);
          vGate.setAttribute('x2', xPix(gateAnnual)); vGate.setAttribute('y2', H-P);
          vGate.setAttribute('stroke','currentColor');
          vGate.setAttribute('stroke-dasharray','4 4');
          svg.appendChild(vGate);
        }
    
        svg.append(axX, axY, path);
      }
    
      function renderTable(){
        let html = `<table class="tight" style="width:100%">
          <thead><tr><th>Annual income</th><th class="right">WIC yearly est.</th></tr></thead><tbody>`;
        for (let a=0; a<=A_MAX; a+=TABLE_STEP){
          html += `<tr><td>$${a.toLocaleString()}</td><td class="right">$${yearlyAtIncome(a).toLocaleString()}</td></tr>`;
        }
        html += `</tbody></table>`;
        tableWrap.innerHTML = html;
      }
    
      function refreshAll(){
        readAndClamp();
        refreshKpis();
        rebuildCurveAndSave();
        drawCurve();
        renderTable();
      }
    
      // Wire inputs
      ['wic_willing','wic_numPregnant','wic_numBfMoms','wic_numBfMomsTwins','wic_numInfants6to11','wic_numChildren1to4','wic_numFormulaNotCovered']
        .forEach(id=>{
          const el = document.getElementById(id);
          el.addEventListener('input',  refreshAll);
          el.addEventListener('change', refreshAll);
        });
    
      // First paint
      refreshAll();
    
      // nav
      document.getElementById('wicBack').addEventListener('click', () => goPrevBenefit('wic', userInfo, budget), { once:true });
      document.getElementById('wicNext').addEventListener('click', () => {
        // Save a scalar snapshot too (used by final screen)
        const y = computeWicYearlyFromCounts(userInfo, budget);
        budget.benefits.wic = { yearlyOffset: y, monthlyApprox: Math.round(y/12) };
        goNextBenefit('wic', userInfo, budget);
      }, { once:true });
    }
    /* === [startWICStepCounts — END] === */
    
    // Router shim so "wic" can be started by the generic router:
    function startWICStep(userInfo, budget){
      return startWICStepCounts(userInfo, budget);
    }

        
        
        
    
    // ========== 4. Childcare Assistance (PFCC + Child Care Choice) ==========
    function startChildcareAssistStep(userInfo, budget){
      // respect the router's willingness flag
      if (!willing(userInfo, budget).childcare) return goNextBenefit('childcare', userInfo, budget);
    
      const app = document.getElementById('app');
    
      // prefills from family info if present
      const inferredFamilySize = Number(userInfo.familySize) || (Array.isArray(userInfo.members) ? userInfo.members.length : 4);
      const inferredKidsNeedingCare = Array.isArray(userInfo.members)
        ? userInfo.members.filter(m => Number(m.age) >= 0 && Number(m.age) <= 12).length
        : 0;
    
      app.innerHTML = `
        <h2>Child Care Assistance (PFCC + Child Care Choice)</h2>
    
        <div class="grid">
          <label>Family Size
            <input id="cc_familySize" type="number" min="1" value="${inferredFamilySize}">
          </label>
          <label>Already receiving PFCC?
            <select id="cc_currentPFCC">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
          </label>
          <label>Working/School/Training (activity requirement met)?
            <select id="cc_activityOK">
              <option value="yes" selected>Yes</option>
              <option value="no">No</option>
            </select>
          </label>
          <label>Number of Children Needing Care
            <input id="cc_kids" type="number" min="0" value="${Math.max(0, inferredKidsNeedingCare)}">
          </label>
        </div>
    
        <div id="cc_children"></div>
    
        <div class="row"></div>
        <div class="note small">
          <strong>What this shows:</strong> We sweep income and show where you’re eligible for
          <em>PFCC initial</em> (≤145% FPL, or ≤150% with special needs),
          <em>Child Care Choice</em> (146–200% FPL), and
          <em>PFCC continuation-only</em> (200–300% FPL for current recipients).
          Out-of-pocket is your Ohio copay (per rule) when eligible, or full market cost otherwise.<br>
          <em>Assumes provider accepts state rate (no over-rate fees).</em>
        </div>
    
        <div class="actions" style="margin-top:10px;">
          <button id="cc_run" class="primary">Run Child Care Sweep</button>
          <button id="cc_next" class="secondary" disabled>Next</button>
        </div>
    
        <canvas id="cc_chart" width="760" height="340" style="margin-top:12px;"></canvas>
        <div id="cc_legend" class="small" style="margin-top:6px;"></div>
        <div id="cc_table" style="margin-top:10px; overflow-x:auto;"></div>
      `;
      pushStep(() => startChildcareAssistStep(userInfo, budget));
    
      // ---- 2025 HHS FPL (annual). For size >10 add $5,440 per extra person. ----
      const FPL_2025 = [null, 15590, 21030, 26470, 31910, 37350, 42790, 48230, 53670, 59110, 64550];
      const FPL_annual = s => (s <= 10 ? FPL_2025[s] : FPL_2025[10] + (s-10)*5440);
      const FPL_monthly = s => FPL_annual(s)/12;
    
      // Ohio Admin Code 5180:2-16-05 – Appendix A multipliers by 5% FPL step
      const MULT = {
        105:0.0700,110:0.0735,115:0.0770,120:0.0805,125:0.0840,130:0.0875,
        135:0.0875,140:0.0875,145:0.0875,150:0.0875,155:0.0875,160:0.0875,
        165:0.0875,170:0.0875,175:0.0875,180:0.0875,185:0.0875,190:0.0875,
        195:0.0875,200:0.0875,205:0.0900,210:0.1000,215:0.1100,220:0.1200,
        225:0.1300,230:0.1400,235:0.1500,240:0.1600,245:0.1700,250:0.1800,
        255:0.1900,260:0.2000,265:0.2100,270:0.2200,275:0.2300,280:0.2400,
        285:0.2500,290:0.2600,295:0.2700,300:0.2700
      };
    
      // Elements
      const familySizeEl = document.getElementById('cc_familySize');
      const currentPFCCEl = document.getElementById('cc_currentPFCC');
      const activityOKEl = document.getElementById('cc_activityOK');
      const kidsEl = document.getElementById('cc_kids');
      const childrenWrap = document.getElementById('cc_children');
      const runBtn = document.getElementById('cc_run');
      const nextBtn = document.getElementById('cc_next');
      const chartEl = document.getElementById('cc_chart');
      const legendEl = document.getElementById('cc_legend');
      const tableEl = document.getElementById('cc_table');
    
      // Child rows (special needs, market cost, care type)
      function renderChildren(){
        const n = Math.max(0, Number(kidsEl.value|0));
        childrenWrap.innerHTML = '';
        if(n === 0) return;
        const frag = document.createDocumentFragment();
        for(let i=0;i<n;i++){
          const row = document.createElement('div');
          row.className = 'grid';
          row.style.marginTop = '8px';
          row.innerHTML = `
            <label>Child ${i+1}: Special Needs?
              <select id="cc_sn_${i}">
                <option value="no" selected>No</option>
                <option value="yes">Yes</option>
              </select>
            </label>
            <label>Child ${i+1}: Estimated annual market cost ($)
              <input id="cc_cost_${i}" type="number" min="0" step="100" value="12000">
            </label>
            <label>Child ${i+1}: Care type
              <select id="cc_type_${i}">
                <option value="full">Full-day</option>
                <option value="part">Part-day</option>
                <option value="basc">Before/After-school</option>
              </select>
            </label>
          `;
          frag.appendChild(row);
        }
        childrenWrap.appendChild(frag);
      }
      kidsEl.addEventListener('input', () => { renderChildren(); run(); });
        // Re-run when PFCC continuation toggle (and related inputs) change
        currentPFCCEl.addEventListener('change', run);
        activityOKEl.addEventListener('change', run);
        familySizeEl.addEventListener('input', run);
        
        // Delegate changes inside the dynamic child rows
        childrenWrap.addEventListener('input', (e) => {
          if (e?.target?.id && /^cc_(sn|cost|type)_\d+$/.test(e.target.id)) {
            run();
          }
        });
        
        //Change listener
        childrenWrap.addEventListener('change', (e) => {
            if (e?.target?.id && /^cc_(sn|cost|type)_\d+$/.test(e.target.id)) {
                run();
            }
        });

        // First paint so the chart/table reflect current selections right away
        renderChildren();
        run();
    
      function getParams(){
        const familySize = Number(familySizeEl.value);
        const currentPFCC = currentPFCCEl.value === 'yes';
        const activityOK = activityOKEl.value === 'yes';
        const n = Number(kidsEl.value|0);
        const children = [];
        let anySpecial = false;
        let totalMarket = 0;
        for(let i=0;i<n;i++){
          const sn = document.getElementById(`cc_sn_${i}`).value === 'yes';
          const cost = Number(document.getElementById(`cc_cost_${i}`).value);
          const type = document.getElementById(`cc_type_${i}`).value;
          children.push({ specialNeeds: sn, cost, type });
          if(sn) anySpecial = true;
          totalMarket += (isFinite(cost) ? cost : 0);
        }
        // Graph settings standardized to match your other steps
        const incomeMax = 150000;   // same top as other curves
        const tableStep = 10000;    // $10k steps for the table
        const graphStep = 100;      // $100 increments for the curve & saved vector
        return { familySize, currentPFCC, activityOK, children, anySpecial, totalMarket, incomeMax, tableStep, graphStep };
      }    
      // True Ohio weekly copay per 5180:2-16-05
      function weeklyCopayOhio(incomeAnnual, familySize){
        const baseA = FPL_annual(familySize);
        if(!baseA || baseA<=0) return 0;
        const pctFPL = (incomeAnnual / baseA) * 100;
        if(pctFPL <= 100) return 0; // ≤100% FPL = $0 weekly
        const step = Math.ceil(pctFPL / 5) * 5;
        const s = Math.max(105, Math.min(300, step));
        const mult = MULT[s] ?? MULT[300];
        const maxMonthlyAtStep = Math.ceil((s/100) * FPL_monthly(familySize));
        const monthlyCopay = Math.round(maxMonthlyAtStep * mult);
        return Math.round((monthlyCopay * 12) / 52);
      }
    
      function screenAtIncome(incomeAnnual, p){
        const baseA = FPL_annual(p.familySize);
        const pctFPL = baseA ? (incomeAnnual / baseA) * 100 : 9999;
        const pfccCut = p.anySpecial ? 150 : 145;
    
        const PFCC_apply    = p.activityOK && pctFPL <= pfccCut;
        const CCC_eligible  = p.activityOK && !PFCC_apply && pctFPL > 145 && pctFPL <= 200;
        const PFCC_continue = p.currentPFCC && pctFPL <= 300;
    
        let outOfPocket = p.totalMarket;
        if (PFCC_apply || CCC_eligible || PFCC_continue) {
          const wk = weeklyCopayOhio(incomeAnnual, p.familySize);
          const annualCopay = wk * 52;
          outOfPocket = Math.min(p.totalMarket, annualCopay); // cap at market cost
        }
    
        return { income: incomeAnnual, pctFPL, PFCC_apply, CCC_eligible, PFCC_continue, outOfPocket: Math.round(outOfPocket) };
      }
    
    function buildSeries(p){
      // Curve: 0..incomeMax in $100 steps (inclusive)
      const curve = [];
      for (let income = 0; income <= p.incomeMax; income += p.graphStep){
        curve.push(screenAtIncome(income, p));
      }
      // Table: fixed $10k steps (0..150k inclusive)
      const points = [];
      for (let income = 0; income <= p.incomeMax; income += p.tableStep){
        points.push(screenAtIncome(income, p));
      }
      return { curve, points };
    }

    
        function drawChart(points, p){
          const ctx = chartEl.getContext('2d');
          ctx.clearRect(0,0,chartEl.width, chartEl.height);
        
          // Colors tuned for dark backgrounds
          const AXIS_COLOR   = '#9db3c7';
          const TEXT_COLOR   = '#e6f0ff';
          const LINE_COLOR   = '#b9e2ff';
          const BAND_PFCC    = 'rgba(144, 238, 144, 0.16)';  // light green, soft
          const BAND_CCC     = 'rgba(173, 216, 230, 0.14)';  // light blue
          const BAND_CONT    = 'rgba(255, 255, 224, 0.12)';  // light yellow
        
          const pad = {l:56, r:10, t:12, b:34};
          const w = chartEl.width - pad.l - pad.r;
          const h = chartEl.height - pad.t - pad.b;
          const maxX = p.incomeMax;
          const maxY = Math.max(2000, ...points.map(pt=>pt.outOfPocket), p.totalMarket);
        
          const x2px = x => pad.l + (x/maxX)*w;
          const y2py = y => pad.t + h - (y/maxY)*h;
        
          ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
          ctx.fillStyle = TEXT_COLOR;
          ctx.strokeStyle = AXIS_COLOR;
        
          // Shaded eligibility bands
          const baseA = FPL_annual(p.familySize) || 1;
          const pfccCut = p.anySpecial ? 150 : 145;
          const xPFCC = Math.min(maxX, baseA * pfccCut/100);
          const xCCC1 = Math.min(maxX, baseA * 1.45);
          const xCCC2 = Math.min(maxX, baseA * 2.00);
          const xCONT = Math.min(maxX, baseA * 3.00);
        
          ctx.fillStyle = BAND_PFCC;
          ctx.fillRect(x2px(0), pad.t, x2px(xPFCC)-x2px(0), h);
          ctx.fillStyle = BAND_CCC;
          ctx.fillRect(x2px(xCCC1), pad.t, Math.max(0, x2px(xCCC2)-x2px(xCCC1)), h);
          ctx.fillStyle = BAND_CONT;
          ctx.fillRect(x2px(xCCC2), pad.t, Math.max(0, x2px(xCONT)-x2px(xCCC2)), h);
        
          // Axes
          ctx.strokeStyle = AXIS_COLOR;
          ctx.beginPath(); ctx.moveTo(pad.l, pad.t); ctx.lineTo(pad.l, pad.t + h); ctx.lineTo(pad.l + w, pad.t + h); ctx.stroke();
        
          // X ticks at $50k
          ctx.fillStyle = TEXT_COLOR;
          for(let x=0; x<=maxX; x+=50000){
            const px = x2px(x);
            ctx.beginPath(); ctx.moveTo(px, pad.t+h); ctx.lineTo(px, pad.t+h+5); ctx.stroke();
            ctx.fillText(`$${(x/1000).toFixed(0)}k`, px-14, pad.t+h+18);
          }
          // Y ticks
          const yStep = Math.max(2000, Math.ceil(maxY/5/1000)*1000);
          for(let y=0; y<=maxY; y+=yStep){
            const py = y2py(y);
            ctx.beginPath(); ctx.moveTo(pad.l-5, py); ctx.lineTo(pad.l, py); ctx.stroke();
            ctx.fillText(`$${y.toLocaleString()}`, 8, py+3);
          }
        
          // Cost line (YEARLY OOP)
          ctx.beginPath();
          points.forEach((pt, i)=>{
            const px = x2px(pt.income);
            const py = y2py(pt.outOfPocket);
            if(i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
          });
          ctx.lineWidth = 2;
          ctx.strokeStyle = LINE_COLOR;
          ctx.stroke();
        
          // Labels
          ctx.fillStyle = TEXT_COLOR;
          ctx.fillText('Family Child Care Out-of-Pocket (Ohio copay) vs Income', pad.l + 130, pad.t + 10);
          ctx.fillText('Income', pad.l + w/2 - 18, pad.t + h + 28);
          ctx.save(); ctx.translate(16, pad.t + h/2 + 20); ctx.rotate(-Math.PI/2);
          ctx.fillText('Out-of-Pocket ($/year)', 0, 0); ctx.restore();
        
          // Legend
          legendEl.innerHTML = `
            <div><strong>Bands:</strong>
              PFCC initial (0–${pfccCut}% FPL) | Child Care Choice (146–200%) |
              PFCC continuation-only (200–300% for current PFCC)</div>
            <div><strong>FPL (size ${p.familySize}):</strong> $${baseA.toLocaleString()} —
              ${pfccCut}%: $${Math.round(baseA*pfccCut/100).toLocaleString()},
              200%: $${Math.round(baseA*2).toLocaleString()},
              300%: $${Math.round(baseA*3).toLocaleString()}</div>
            <div class="small" style="margin-top:4px;">
              Copay computed per Ohio Admin Code 5180:2-16-05 & Appendix A; desk-aid values match.
            </div>
          `;
        }

    
      function renderTable(points){
        const rows = points.map(pt=>`
          <tr>
            <td>$${pt.income.toLocaleString()}</td>
            <td>${pt.pctFPL.toFixed(1)}%</td>
            <td>${pt.PFCC_apply ? '✔' : ''}</td>
            <td>${pt.CCC_eligible ? '✔' : ''}</td>
            <td>${pt.PFCC_continue ? '✔' : ''}</td>
            <td>$${pt.outOfPocket.toLocaleString()}</td>
          </tr>
        `).join('');
        tableEl.innerHTML = `
          <table class="striped compact">
            <thead>
              <tr>
                <th>Income</th>
                <th>% FPL</th>
                <th>PFCC (apply)</th>
                <th>Choice (146–200%)</th>
                <th>PFCC (continue)</th>
                <th>Est. Out-of-Pocket</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }
    
      function run(){
        const p = getParams();
        const { curve, points } = buildSeries(p);
        // Expose $10k points for the Net Monthly screen
        budget._series = budget._series || {};
        budget._series.childcare = { points };

    
        // draw chart using the *curve* for smoothness…
        drawChart(curve, p);
        // …but show the table at exactly $10k steps
        renderTable(points);
    
        // Save series for the “final compilation” graph
        // Save canonical YEARLY vector for final roll-up (costs negative)
        budget._series = budget._series || {};
        
        // Build/align a 0..150k by $100 grid
        const salaries = [];
        for (let a = 0; a <= p.incomeMax; a += p.graphStep) salaries.push(a);
        
        // If a global grid already exists, reuse it; otherwise set it
        const grid = Array.isArray(budget._salaries) && budget._salaries.length ? budget._salaries : salaries;
        if (!budget._salaries) budget._salaries = grid;
        
        // Out-of-pocket is a cost → store as negative yearly values
        const childcare_yearly = grid.map(a => -screenAtIncome(a, p).outOfPocket);
        
        budget._series.childcare_yearly = childcare_yearly;
        
        // (Optional metadata)
        budget._series_meta = budget._series_meta || {};
        budget._series_meta.childcare = {
          graph_step: p.graphStep,
          table_step: p.tableStep,
          familySize: p.familySize,
          currentPFCC: p.currentPFCC,
          activityOK: p.activityOK,
          kids: p.children.length,
          anySpecial: p.anySpecial,
          totalMarket: p.totalMarket
        };

    
        // allow continuing through the router
        nextBtn.disabled = false;
      }
    
      runBtn.addEventListener('click', run, { once:false });
      nextBtn.addEventListener('click', () => {
        // proceed to next selected benefit step
        goNextBenefit('childcare', userInfo, budget);
      }, { once:true });
    }

 
 
 
 
     // === EdChoice FY25 award approximation (ESTIMATES) =====================
    // Caps (FY25/26): K–8 = 6,166 ; HS = 8,408
    const EDC_CAP = { K8: 6166, HS: 8408 };
    
    // Min award floor ~10% of cap for very high incomes
    const EDC_MIN = { K8: Math.round(0.10 * EDC_CAP.K8), HS: Math.round(0.10 * EDC_CAP.HS) };
    
    // Piecewise knots: [FPL%, fraction-of-cap]. Tuned to resemble prior-year behavior.
    // You can tweak numbers if you get a better historical table.
    const EDC_PCT_KNOTS = [
      [450, 1.00],
      [500, 0.82],
      [550, 0.64],
      [600, 0.46],
      [650, 0.30],
      [700, 0.18],
      [750, 0.12],
      [785, 0.10]
    ];
    
    // Linear interpolation between knots
    function _interpPctFromKnots(pctFPL){
      const p = Math.max(0, Math.floor(pctFPL|0));
      if (p <= 450) return 1.00;
      if (p >= 785) return 0.10;
      for (let i = 0; i < EDC_PCT_KNOTS.length - 1; i++){
        const [x1, y1] = EDC_PCT_KNOTS[i];
        const [x2, y2] = EDC_PCT_KNOTS[i+1];
        if (p >= x1 && p <= x2){
          const t = (p - x1) / (x2 - x1);
          return y1 + (y2 - y1) * t;
        }
      }
      return 0.10; // safety
    }
    
    // FY25 APPROX: return per-child award (annual dollars) for a grade band
    function edcAwardFY25Approx(gradeBand, pctFPL){
      const band = (gradeBand === 'HS') ? 'HS' : 'K8';
      const f = _interpPctFromKnots(pctFPL);
      const raw = Math.round(EDC_CAP[band] * f);
      return Math.max(EDC_MIN[band], Math.min(EDC_CAP[band], raw));
    }
   
    
    // ========== 5. EdChoice (Private School Voucher) ==========
    function startEdChoiceBenefitStep(userInfo, budget){
      if (!willing(userInfo, budget).edchoice) return goNextBenefit('edchoice', userInfo, budget);
      const app = document.getElementById('app');
    
      // FY25 caps (Ohio)
      const K8_CAP = 6166;
      const HS_CAP = 8408;
    
      // 2025 HHS Poverty Guidelines (48 states/DC). >10 adds $5,440 per extra person.
      const FPL_2025 = [null, 15590, 21030, 26470, 31910, 37350, 42790, 48230, 53670, 59110, 64550];
      function fplBase(size){ return size <= 10 ? FPL_2025[size] : (FPL_2025[10] + (size - 10) * 5440); }
      function fplPercent(annualIncome, hh){ const base = fplBase(hh||1)||1; return (annualIncome / base) * 100; }
    
        function perChildAward(gradeBand, pctFPL){
          // FY25 APPROX (estimates): uses the piecewise knots you defined above
          return edcAwardFY25Approx(gradeBand, pctFPL);
        }

      // UI — note there is NO income field; we sweep it.
      app.innerHTML = `
        <h2>EdChoice Scholarship — Ohio</h2>
        <p>We’ll sweep household income from $0 to $150k and show your family’s <em>annual tuition due</em> after EdChoice, by $10,000 steps.</p>
    
        <div class="grid">
          <label>Family size
            <input id="edcFamily" type="number" min="1" step="1" value="${Number(userInfo.familySize)||4}">
          </label>
          <label>Number of private-school students
            <input id="edcKids" type="number" min="0" step="1" value="0">
          </label>
        </div>
    
        <div id="edcStudents" class="row"></div>
    
        <div class="row"></div>
        <div class="actions">
          <button id="edcRun" class="primary">Run EdChoice Sweep</button>
          <button id="edcSkip" class="secondary">Skip</button>
        </div>
    
        <div class="row"></div>
        <svg id="edcSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="EdChoice tuition due curve"></svg>
    
        <div class="row"></div>
        <div id="edcTableWrap"></div>
    
        <div class="note small">
          Caps (FY25–26): K–8 = $6,166; HS = $8,408. At ≤200% FPL, schools cannot bill tuition above the award (fees may still apply).
          <strong>Estimates:</strong> Awards above 450% FPL use a FY25-style approximation (not the official per-percent table).
          We’ll update to the exact table when available. Your actual award may vary.
        </div>


    
        <div class="row"></div>
        <button id="edcNext" class="primary">Next</button>
      `;
      pushStep(() => startEdChoiceBenefitStep(userInfo, budget));
    
      const familyEl = document.getElementById('edcFamily');
      const kidsEl   = document.getElementById('edcKids');
      const area     = document.getElementById('edcStudents');
      const svg      = document.getElementById('edcSvg');
      const tableWrap= document.getElementById('edcTableWrap');
    
      // Dynamic student rows
      function renderStudentInputs(){
        const n = Math.max(0, Number(kidsEl.value|0));
        area.innerHTML = '';
        if (!n) return;
        const frag = document.createDocumentFragment();
        for (let i = 0; i < n; i++){
          const row = document.createElement('div');
          row.className = 'grid';
          row.style.marginTop = '8px';
          row.innerHTML = `
            <label>Student ${i+1}: Grade band
              <select id="edcGrade_${i}">
                <option value="K8">K–8</option>
                <option value="HS">9–12</option>
              </select>
            </label>
            <label>Student ${i+1}: Annual tuition
              $<input id="edcTuition_${i}" type="number" min="0" step="50" value="7000">
            </label>
          `;
          frag.appendChild(row);
        }
        area.appendChild(frag);
      }
      kidsEl.addEventListener('input', renderStudentInputs);
      renderStudentInputs();
    
      // Helpers to read student list and compute at a given income
      function collectStudents(){
        const n = Number(kidsEl.value|0);
        const arr = [];
        for (let i=0; i<n; i++){
          const grade = (document.getElementById(`edcGrade_${i}`)?.value) || 'K8';
          const tuition = Number(document.getElementById(`edcTuition_${i}`)?.value) || 0;
          arr.push({ grade, tuition });
        }
        return arr;
      }
    
      function computeAtIncome({ annualIncome, familySize, students }){
        const pct = fplPercent(annualIncome, familySize);
        let totalSchoolTuition = 0;
        let totalEdChoicePays  = 0;
        let familyTuitionDue   = 0;
    
        for (const s of students){
          totalSchoolTuition += s.tuition;
          const maxAward = perChildAward(s.grade, pct);
          const edPays = Math.min(s.tuition, maxAward);
          totalEdChoicePays += edPays;
    
          if (pct <= 200){
            // ≤200% FPL → tuition gap must be waived (fees not included here)
            familyTuitionDue += 0;
          } else {
            familyTuitionDue += Math.max(0, s.tuition - edPays);
          }
        }
    
        return {
          pctFPL: pct,
          totalSchoolTuition,
          totalEdChoicePays,
          familyTuitionDue // annual
        };
      }
    
      // SVG drawing (simple axes + line)
      const W = 720, H = 260, P = 40;
      function xPix(x, maxX){ return P + (x / maxX) * (W - P*2); }
      function yPix(y, maxY){ return H - P - (y / maxY) * (H - P*2); }
      function fmt(n){ return '$' + Math.round(Math.max(0, n)).toLocaleString(); }
    
      function drawCurve(points, maxX, maxY){
        svg.innerHTML = '';
    
        // axes
        const axisX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisX.setAttribute('x1', P); axisX.setAttribute('y1', H-P);
        axisX.setAttribute('x2', W-P); axisX.setAttribute('y2', H-P);
        axisX.setAttribute('stroke','currentColor'); axisX.setAttribute('stroke-width','1');
    
        const axisY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisY.setAttribute('x1', P); axisY.setAttribute('y1', P);
        axisY.setAttribute('x2', P); axisY.setAttribute('y2', H-P);
        axisY.setAttribute('stroke','currentColor'); axisY.setAttribute('stroke-width','1');
    
    // X ticks every $20k
    for (let x = 0; x <= maxX; x += 20000){
      const X = xPix(x, maxX);
      const t = document.createElementNS('http://www.w3.org/2000/svg','line');
      t.setAttribute('x1', X); t.setAttribute('y1', H-P);
      t.setAttribute('x2', X); t.setAttribute('y2', H-P+5);
      t.setAttribute('stroke','currentColor');
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', X-14); label.setAttribute('y', H-P+18);
      label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
      label.textContent = `$${(x/1000).toFixed(0)}k`;
      svg.append(t, label);
    }
    
    // Y ticks every $10k (or $20k if tall)
    const yStep = (maxY <= 50_000 ? 10_000 : 20_000);
    for (let y = 0; y <= maxY; y += yStep){
      const Y = yPix(y, maxY);
      const t = document.createElementNS('http://www.w3.org/2000/svg','line');
      t.setAttribute('x1', P-5); t.setAttribute('y1', Y);
      t.setAttribute('x2', P);   t.setAttribute('y2', Y);
      t.setAttribute('stroke','currentColor');
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', 6); label.setAttribute('y', Y-2);
      label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
      label.textContent = `$${y.toLocaleString()}`;
      svg.append(t, label);
    }
    
    // Axis titles (add if you want them, to match other charts)
    const xTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
    xTitle.setAttribute('x', W/2); xTitle.setAttribute('y', H - 6);
    xTitle.setAttribute('text-anchor','middle');
    xTitle.setAttribute('font-size','12'); xTitle.setAttribute('fill','currentColor');
    xTitle.textContent = 'Annual income';
    
    const yTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
    yTitle.setAttribute('x', 16); yTitle.setAttribute('y', H/2);
    yTitle.setAttribute('text-anchor','middle');
    yTitle.setAttribute('font-size','12'); yTitle.setAttribute('fill','currentColor');
    yTitle.setAttribute('transform', `rotate(-90 16 ${H/2})`);
    yTitle.textContent = 'Family tuition due (annual)';
    
    svg.append(xTitle, yTitle);

        // path
        let d = '';
        for (let i=0; i<points.length; i++){
          const X = xPix(points[i].x, maxX), Y = yPix(points[i].y, maxY);
          d += (i===0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','currentColor');
        path.setAttribute('stroke-width','2');
    
        // labels
        const yLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        yLabel.setAttribute('x', P + 4); yLabel.setAttribute('y', yPix(maxY, maxY) - 6);
        yLabel.setAttribute('font-size','10'); yLabel.setAttribute('fill','currentColor');
        yLabel.textContent = fmt(maxY);
    
        const xLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLabel.setAttribute('x', xPix(maxX, maxX) - 44); xLabel.setAttribute('y', H - P + 14);
        xLabel.setAttribute('font-size','10'); xLabel.setAttribute('fill','currentColor');
        xLabel.textContent = '$' + (maxX).toLocaleString();
    
        svg.append(axisX, axisY, path, yLabel, xLabel);
      }
    
      // Table at every $10k (0..150k)
      function renderTable(rows){
        let html = `<table style="width:100%; border-collapse:collapse;">
          <thead><tr>
            <th style="text-align:left; padding:6px;">Annual income</th>
            <th style="text-align:left; padding:6px;">Family tuition due (annual)</th>
          </tr></thead><tbody>`;
        for (const r of rows){
          html += `<tr>
            <td style="padding:6px;">$${r.annual.toLocaleString()}</td>
            <td style="padding:6px;">$${Math.round(r.annualDue).toLocaleString()}</td>
          </tr>`;
        }
        html += `</tbody></table>`;
        tableWrap.innerHTML = html;
      }
    
      function runSweep(){
        const familySize = Math.max(1, Number(familyEl.value)||1);
        const students = collectStudents();
    
        const A_MAX = 150000;
        const steps = 30; // curve smoothness
        const curve = [];
        let yMax = 100;
        for (let i=0; i<=steps; i++){
          const annual = (A_MAX * i) / steps;
          const r = computeAtIncome({ annualIncome: annual, familySize, students });
          curve.push({ x: annual, y: r.familyTuitionDue });
          if (r.familyTuitionDue > yMax) yMax = r.familyTuitionDue;
        }
        const tableRows = [];
        for (let annual = 0; annual <= A_MAX; annual += 10000){
          const r = computeAtIncome({ annualIncome: annual, familySize, students });
          tableRows.push({ annual, annualDue: r.familyTuitionDue });
        }
    
        // Save for the combined “final compilation” chart
        budget._series = budget._series || {};
        budget._series.edchoice = {
          points: tableRows.slice(),
          curve:  curve.slice(),
          assumptions: {
            familySize,
            students: students.map(s => ({ grade: s.grade, tuition: s.tuition })),
            caps: { K8: K8_CAP, HS: HS_CAP },
            policy: 'FY25-style estimate: ≤200%=$0 due; ≤450%=full cap; 450–785% piecewise decline to ~10% floor'
          }
        };
    
        drawCurve(curve, A_MAX, yMax);
        renderTable(tableRows);
      }
    
      document.getElementById('edcRun').addEventListener('click', runSweep, { once:false });
    
      document.getElementById('edcSkip').addEventListener('click', () => {
        goNextBenefit('edchoice', userInfo, budget);
      }, { once:true });
    
      document.getElementById('edcNext').addEventListener('click', () => {
        // Nothing to sync into budget here (EdChoice is informational for OOP at various incomes)
        goNextBenefit('edchoice', userInfo, budget);
      }, { once:true });
    }

 
 
    
    
    // ========== 6. Income-Driven Student Loans (ICR/IBR) ==========
    function startICRStep(userInfo, budget){
      if (!willing(userInfo, budget).icr) return goNextBenefit('icr', userInfo, budget);
    
      const app = document.getElementById('app');
    
      // ------- Household + income -------
      const H = Math.min(Math.max(Number(userInfo.familySize) || 1, 1), 12);
      const defaultAGI = Math.max(0, Number(userInfo.annualIncome) || Number(userInfo.salaryAnnual) || 0);
    
      // 2024 FPL (48 states & DC). HH=1: 15060, each add'l +5380.
      function fpl(hh){
        hh = Math.min(Math.max(hh,1), 20);
        return 15060 + (hh - 1) * 5380;
      }
    
      // Payment calculators (yearly). We keep it simple & transparent.
      function payICR(agi, hh){
        const disc = Math.max(0, agi - fpl(hh));          // 100% FPL
        return 0.20 * disc;                                // 20% of discretionary income
      }
      function payIBR(agi, hh){
        const disc = Math.max(0, agi - 1.5 * fpl(hh));     // 150% FPL
        return 0.15 * disc;                                 // 15% of discretionary income
      }
    
      app.innerHTML = `
        <h2>Income-Driven Student Loans (ICR / IBR)</h2>
        <p><strong>Household size:</strong> ${H}</p>
        <div class="note small">
          Uses a simple planning model: IBR = 15% of (AGI − 150% FPL); ICR = 20% of (AGI − 100% FPL).
          (We skip the 12-year ICR amortization variant and interest subsidies to keep it clear.)
        </div>
    
        <div class="row"></div>
        <label>Enter your <strong>annual income (AGI)</strong>:
          $<input type="number" id="idrIncome" min="0" step="1000" placeholder="e.g., 52000" value="${defaultAGI || ''}">
        </label>
    
        <div class="row"></div>
        <div class="segmented">
          <button id="modeIBR" class="primary">IBR (lower rate)</button>
          <button id="modeICR">ICR</button>
        </div>
    
        <div class="row"></div>
        <div id="idrKpis">
          <div><strong>Yearly payment:</strong> <span id="idrYearly">$0</span></div>
          <div class="small muted">≈ <span id="idrMonthly">$0</span> per month</div>
        </div>
    
        <div class="row"></div>
        <svg id="idrSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="IDR payment curve"></svg>
    
        <div class="row"></div>
        <div id="idrTableWrap"></div>
    
        <div class="row"></div>
        <button id="idrNext" class="primary">Next</button>
      `;
      pushStep(() => startICRStep(userInfo, budget));
    
      const incomeEl = document.getElementById('idrIncome');
      const svg = document.getElementById('idrSvg');
      const yearlyEl = document.getElementById('idrYearly');
      const monthlyEl = document.getElementById('idrMonthly');
      const wrap = document.getElementById('idrTableWrap');
      const btnIBR = document.getElementById('modeIBR');
      const btnICR = document.getElementById('modeICR');
    
      // UI state
      let plan = 'IBR'; // default to lower rate
    
      function calcYearly(agi){
        return plan === 'IBR' ? payIBR(agi, H) : payICR(agi, H);
      }
    
    // ----- Build curve & table -----
    // Canonical ranges/steps
    const A_MAX = 150000;        // inclusive
    const GRAPH_STEP = 100;      // $100 grid for graph & saved vector
    const TABLE_STEP = 10000;    // $10k table rows
    let curvePts = [], yMax = 0;
    
    function rebuildCurve(){
      curvePts = [];
      yMax = 0;
      for (let a = 0; a <= A_MAX; a += GRAPH_STEP){
        const y = calcYearly(a);                 // YEARLY amount
        curvePts.push({ annual:a, yearly:y });
        if (y > yMax) yMax = y;
      }
      if (yMax < 1200) yMax = 1200;              // avoid tiny axis
    }
    
    function renderTable(){
      const rows = [];
      for (let a = 0; a <= A_MAX; a += TABLE_STEP){
        const y = calcYearly(a);                 // YEARLY amount
        rows.push({ annual:a, yearly:y, monthly:y/12 });
      }
    
      // store table series (still helpful for your UI)
      budget._series = budget._series || {};
      budget._series.icr = { plan, H, points: rows.slice() };
    
      let html = `<table style="width:100%; border-collapse:collapse;">
        <thead><tr>
          <th style="text-align:left; padding:6px;">Annual income</th>
          <th style="text-align:left; padding:6px;">Yearly payment</th>
          <th style="text-align:left; padding:6px;">Monthly (≈)</th>
        </tr></thead><tbody>`;
      for (const r of rows){
        html += `<tr>
          <td style="padding:6px;">$${r.annual.toLocaleString()}</td>
          <td style="padding:6px;">$${Math.round(r.yearly).toLocaleString()}</td>
          <td style="padding:6px;">$${Math.round(r.monthly).toLocaleString()}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      wrap.innerHTML = html;
    }
      
      // ----- Save canonical YEARLY vectors (0..150k by $100), negative = costs -----
    function saveCanonicalVectors(){
      // Build or reuse the global 0..150k/$100 grid used across steps
      const grid = (Array.isArray(budget._salaries) && budget._salaries.length)
        ? budget._salaries
        : Array.from({length: (A_MAX/GRAPH_STEP)+1}, (_,i) => i*GRAPH_STEP);
      if (!budget._salaries) budget._salaries = grid;
    
      // Compute BOTH plans on the same grid so the roll-up can pick later
      const vecIBR = grid.map(a => -payIBR(a, H));   // negative = outflow (cost)
      const vecICR = grid.map(a => -payICR(a, H));
    
      budget._series = budget._series || {};
      budget._series.idr_ibr_yearly = vecIBR;
      budget._series.idr_icr_yearly = vecICR;
    
      // Optional metadata (handy for debugging / displays)
      budget._series_meta = budget._series_meta || {};
      budget._series_meta.idr = {
        graph_step: GRAPH_STEP,
        table_step: TABLE_STEP,
        plan_shown: plan, // current UI mode
        household: H
      };
    }

    
      // ----- SVG curve -----
      const W = 720, Hpx = 260, P = 40;
      const innerW = W - P*2, innerH = Hpx - P*2;
      function xPix(annual){ return P + (annual / A_MAX) * innerW; }
      function yPix(yearly){ return Hpx - P - (yearly / yMax) * innerH; }
    
      function drawCurve(){
        svg.innerHTML = '';
    
        const axX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axX.setAttribute('x1', P); axX.setAttribute('y1', Hpx-P);
        axX.setAttribute('x2', W-P); axX.setAttribute('y2', Hpx-P);
        axX.setAttribute('stroke','currentColor');
    
        const axY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axY.setAttribute('x1', P); axY.setAttribute('y1', P);
        axY.setAttribute('x2', P); axY.setAttribute('y2', Hpx-P);
        axY.setAttribute('stroke','currentColor');
    
    // X ticks every $20k
    for (let x = 0; x <= A_MAX; x += 20000){
      const X = xPix(x);
      const t = document.createElementNS('http://www.w3.org/2000/svg','line');
      t.setAttribute('x1', X); t.setAttribute('y1', Hpx-P);
      t.setAttribute('x2', X); t.setAttribute('y2', Hpx-P+5);
      t.setAttribute('stroke','currentColor');
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', X-14); label.setAttribute('y', Hpx-P+18);
      label.setAttribute('font-size','10');
      label.textContent = `$${(x/1000).toFixed(0)}k`;
      svg.append(t, label);
    }
    
    // Y ticks every $10k (or $20k if tall)
    const yStep = (yMax <= 50_000 ? 10_000 : 20_000);
    for (let y = 0; y <= yMax; y += yStep){
      const Y = yPix(y);
      const t = document.createElementNS('http://www.w3.org/2000/svg','line');
      t.setAttribute('x1', P-5); t.setAttribute('y1', Y);
      t.setAttribute('x2', P);   t.setAttribute('y2', Y);
      t.setAttribute('stroke','currentColor');
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', 6); label.setAttribute('y', Y-2);
      label.setAttribute('font-size','10');
      label.textContent = `$${y.toLocaleString()}`;
      svg.append(t, label);
    }

    
    
        let d = '';
        for (let i = 0; i < curvePts.length; i++){
          const { annual, yearly } = curvePts[i];
          const X = xPix(annual), Y = yPix(yearly);
          d += (i === 0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','currentColor');
        path.setAttribute('stroke-width','2');
    
        // marker
        const marker = document.createElementNS('http://www.w3.org/2000/svg','circle');
        marker.setAttribute('id','idrMarker');
        marker.setAttribute('r','4');
        marker.setAttribute('fill','currentColor');
    
        // labels
        const yLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        yLabel.setAttribute('x', P + 4); yLabel.setAttribute('y', yPix(yMax) - 6);
        yLabel.setAttribute('font-size','10');
        yLabel.textContent = '$' + Math.round(yMax).toLocaleString();
    
        const xLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLabel.setAttribute('x', xPix(A_MAX) - 44); xLabel.setAttribute('y', Hpx - P + 14);
        xLabel.setAttribute('font-size','10');
        xLabel.textContent = '$' + A_MAX.toLocaleString();
    
        const xTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        xTitle.setAttribute('x', W/2); xTitle.setAttribute('y', Hpx - 6);
        xTitle.setAttribute('text-anchor','middle');
        xTitle.textContent = 'Annual income (AGI)';
    
        const yTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        yTitle.setAttribute('x', 16); yTitle.setAttribute('y', Hpx/2);
        yTitle.setAttribute('text-anchor','middle');
        yTitle.setAttribute('transform', `rotate(-90 16 ${Hpx/2})`);
        yTitle.textContent = 'Yearly IDR payment';
    
        svg.append(axX, axY, path, marker, yLabel, xLabel, xTitle, yTitle);
      }
    
      function fmt(n){ return '$' + (Math.max(0, Math.round(n))).toLocaleString(); }
    
      function updateFromInput(){
        const agi = Number(incomeEl.value) || 0;
        const y = calcYearly(agi);
        yearlyEl.textContent = fmt(y);
        monthlyEl.textContent = fmt(y/12);
    
        // move marker
        const marker = document.getElementById('idrMarker');
        const clamped = Math.max(0, Math.min(A_MAX, agi));
        marker.setAttribute('cx', xPix(clamped));
        marker.setAttribute('cy', yPix(calcYearly(clamped)));
      }
    
        function refreshAll(){
          rebuildCurve();   // uses $100 steps for the graph
          drawCurve();
          renderTable();    // table is $10k yearly totals
          saveCanonicalVectors(); // save both IBR/ICR YEARLY vectors on $100 grid
          updateFromInput();
          // button styles
          btnIBR.classList.toggle('primary', plan === 'IBR');
          btnICR.classList.toggle('primary', plan === 'ICR');
        }

    
      btnIBR.addEventListener('click', () => { plan = 'IBR'; refreshAll(); }, { once:false });
      btnICR.addEventListener('click', () => { plan = 'ICR'; refreshAll(); }, { once:false });
      incomeEl.addEventListener('input', updateFromInput);
    
      // first paint
      refreshAll();
    
      // Save & continue
      document.getElementById('idrNext').addEventListener('click', () => {
        const agi = Number(incomeEl.value) || 0;
        const yearly = calcYearly(agi);
        const monthly = Math.round(yearly / 12);
    
        // Persist to budget (keeps your existing naming)
        budget.usingICR = true;                // “using an IDR plan”
        budget.idrPlan = plan;                 // 'IBR' | 'ICR'
        budget.idrMonthlyPayment = monthly;    // for roll-up
        // Optional series for the final roll-up (negative = cost)
        if (!budget._series) budget._series = {};
        budget._series.icr = budget._series.icr || { plan, H, points: [] };
    
        alert(`Saved ${plan}.`);
        goNextBenefit('icr', userInfo, budget);
      }, { once:true });
    }

    
    
    // ===== 7. FRL (Free/Reduced Lunch/Breakfast) — Yearly Benefit (AUTO) =====
    function startFRLStep(userInfo, budget){
      const app = document.getElementById('app');
    
      // Build list of kids age 4–19 from BOTH children[] and members[] (dedup)
      const childLike = []
        .concat(Array.isArray(userInfo.children) ? userInfo.children : [])
        .concat(Array.isArray(userInfo.members)  ? userInfo.members  : []);
      const kidsRaw = childLike.filter(c => Number(c?.age) >= 4 && Number(c?.age) <= 19);
    
      const seen = new Set();
      const kids = [];
      for (let i = 0; i < kidsRaw.length; i++){
        const nm = (kidsRaw[i].name || kidsRaw[i].first || kidsRaw[i].nickname || '').trim();
        const key = (nm.toLowerCase() || `child${i+1}`) + '::' + Number(kidsRaw[i].age);
        if (seen.has(key)) continue;
        seen.add(key);
        kids.push({ id: kids.length, name: nm || `Child ${kids.length+1}`, age: Number(kidsRaw[i].age) });
      }
    
      // ===== FPL (HHS 2025; >10 adds $5,440 per extra person) =====
      const FPL_2025 = [null, 15590, 21030, 26470, 31910, 37350, 42790, 48230, 53670, 59110, 64550];
      const fplAnnual = s => (s <= 10 ? FPL_2025[s] : FPL_2025[10] + (s-10)*5440);
    
      // National maximum reduced-price caps (student pays at most this)
      const REDUCED_LUNCH_CAP  = 0.40;
      const REDUCED_BFAST_CAP  = 0.30;
    
      // ---- Defaults/assumptions ----
      const DEFAULTS = {
        schoolDaysPerYear: 180,     // yearly model now
        paidLunchPrice: 3.50,
        paidBreakfastPrice: 2.00,
        breakfastOffered: true,
        cepAllKidsEatFree: false,
        reducedZeroCopay: false      // NEW: when true, treat Reduced as $0 (like many OH districts)
      };
    
      // ---- UI ----
      app.innerHTML = `
        <h2>School Meals (FRL) — Yearly Offset</h2>
        <p>This step auto-determines Free/Reduced/Paid from your income & household size. CEP makes all students eat free regardless of income.</p>
    
        <div class="grid">
          <label>Local paid <strong>lunch</strong> price ($)
            <input id="frlPaidLunch" type="number" step="0.01" min="0" value="${DEFAULTS.paidLunchPrice}">
          </label>
          <label>Local paid <strong>breakfast</strong> price ($)
            <input id="frlPaidBfast" type="number" step="0.01" min="0" value="${DEFAULTS.paidBreakfastPrice}">
          </label>
        </div>
    
        <label><input id="frlBreakfastOffered" type="checkbox" ${DEFAULTS.breakfastOffered?'checked':''}>
          Breakfast is offered</label><br>
        <label><input id="frlCep" type="checkbox" ${DEFAULTS.cepAllKidsEatFree?'checked':''}>
          My child(ren)’s school uses CEP (all students eat free)</label><br>
        <label><input id="frlReducedZero" type="checkbox" ${DEFAULTS.reducedZeroCopay?'checked':''}>
          District/state currently covers <em>Reduced</em> price (i.e., reduced = $0 at checkout)</label>
    
        <div class="row"></div>
        <h3>Which children (age 4–19) attend a school participating in FRL/CEP?</h3>
        <div id="frlKids"></div>
    
        <div class="row"></div>
        <label>Try an <strong>annual household income</strong>:
          $<input id="frlIncome" type="number" min="0" step="1000" placeholder="e.g., 52000"
                  value="${Math.max(0, Number(userInfo.annualIncome) || Number(userInfo.salaryAnnual) || 0)}">
        </label>
    
        <div class="row"></div>
        <div id="frlKpis">
          <div><strong>Yearly meal savings:</strong> <span id="frlYearly">$0</span></div>
          <div class="small muted">≈ <span id="frlMonthly">$0</span> per month</div>
        </div>
    
        <div class="row"></div>
        <svg id="frlSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="FRL yearly savings curve"></svg>
    
        <div class="row"></div>
        <div id="frlTableWrap"></div>
    
        <div class="row"></div>
        <div class="note small">
          Status rules (national): <strong>Free</strong> ≤130% FPL, <strong>Reduced</strong> ≤185% FPL, otherwise Paid.
          Reduced-price maxima: lunch ≤ $0.40, breakfast ≤ $0.30. Toggle above if your district/state is currently covering Reduced (making it $0).
          Assumes ~${DEFAULTS.schoolDaysPerYear} school days/year; adjust prices if your district differs.
        </div>
    
        <div class="row"></div>
        <button id="frlNext" class="primary">Next</button>
      `;
      pushStep(() => startFRLStep(userInfo, budget));
    
      // Elements
      const kidsDiv = document.getElementById('frlKids');
      const svg = document.getElementById('frlSvg');
      const tableWrap = document.getElementById('frlTableWrap');
      const yearlyEl = document.getElementById('frlYearly');
      const monthlyEl = document.getElementById('frlMonthly');
      const incomeEl = document.getElementById('frlIncome');
    
      // Render child rows (only “offered?” checkbox per child)
      if (kids.length === 0) {
        kidsDiv.innerHTML = `<p>No children ages 4–19 found. (Tip: add them under household members.)</p>`;
      } else {
        kidsDiv.innerHTML = kids.map(k => `
          <label style="display:block;margin:.4rem 0;">
            <input type="checkbox" id="frlOffer_${k.id}" checked>
            ${k.name} (age ${k.age}) — FRL/CEP applies at school
          </label>
        `).join('');
      }
    
      // Helpers
      const n2 = v => Math.max(0, Number((+v).toFixed(2)));
      const getVal = id => document.getElementById(id).value;
      const isChecked = id => !!document.getElementById(id).checked;
    
      // Canonical ranges/steps
      const A_MAX = 150000;     // inclusive
      const GRAPH_STEP = 100;   // $100 increments for graph & saved vector
      const TABLE_STEP = 10000; // $10k rows
      const DAYS = DEFAULTS.schoolDaysPerYear;
    
      // Determine status from income & HH size (CEP overrides)
      function frlStatus(annualIncome, hh, cep, offered){
        if (!offered) return { status:'paid' };
        if (cep)       return { status:'free' };
        const base = fplAnnual(hh) || 1;
        const pct = (annualIncome / base) * 100;
        if (pct <= 130) return { status:'free' };
        if (pct <= 185) return { status:'reduced' };
        return { status:'paid' };
      }
    
      // Savings at a given income (YEARLY)
      function yearlySavingsAtIncome(annualIncome){
        const lunch = n2(getVal('frlPaidLunch'));
        const bfast = n2(getVal('frlPaidBfast'));
        const breakfast = isChecked('frlBreakfastOffered');
        const cep = isChecked('frlCep');
        const reducedZero = isChecked('frlReducedZero');
    
        let total = 0;
        for (const k of kids){
          const offered = !!document.getElementById(`frlOffer_${k.id}`)?.checked;
          const st = frlStatus(
            annualIncome,
            Number(userInfo.familySize) || kids.length || 1,
            cep,
            offered
          ).status;
    
          let perDaySave = 0;
          if (st === 'free') {
            perDaySave = lunch + (breakfast ? bfast : 0);
          } else if (st === 'reduced') {
            const redLunch = reducedZero ? 0 : Math.min(REDUCED_LUNCH_CAP, lunch);
            const redBfast = reducedZero ? 0 : Math.min(REDUCED_BFAST_CAP, bfast);
            perDaySave = (lunch - redLunch) + (breakfast ? (bfast - redBfast) : 0);
            if (perDaySave < 0) perDaySave = 0; // guard
          } else {
            perDaySave = 0; // paid
          }
    
          total += perDaySave * DAYS;
        }
        return Math.round(Math.max(0, total));
      }
    
      // Build curve & table; save canonical vector
      let curve = [], yMax = 0;
      function rebuildCurveAndSave(){
        curve = [];
        yMax = 0;
        const grid = (Array.isArray(budget._salaries) && budget._salaries.length)
          ? budget._salaries
          : Array.from({ length: (A_MAX/GRAPH_STEP)+1 }, (_,i)=> i*GRAPH_STEP);
        if (!budget._salaries) budget._salaries = grid;
    
        const frlYearly = [];
        for (let i=0; i<grid.length; i++){
          const a = grid[i];
          const y = yearlySavingsAtIncome(a);
          curve.push({ annual:a, yearly:y });
          frlYearly.push(y);           // BENEFIT → positive
          if (y > yMax) yMax = y;
        }
        if (yMax < 200) yMax = 200;
    
        budget._series = budget._series || {};
        budget._series.frl_yearly = frlYearly;
    
        budget._series_meta = budget._series_meta || {};
        budget._series_meta.frl = {
          graph_step: GRAPH_STEP,
          table_step: TABLE_STEP,
          days_per_year: DAYS,
          breakfast_offered: isChecked('frlBreakfastOffered'),
          cep: isChecked('frlCep'),
          reduced_zero: isChecked('frlReducedZero'),
          paid_prices: {
            lunch: n2(getVal('frlPaidLunch')),
            breakfast: n2(getVal('frlPaidBfast'))
          },
          kids_flagged: kids.map(k => !!document.getElementById(`frlOffer_${k.id}`)?.checked)
        };
      }
    
      // Render SVG curve (YEARLY Y)
      function drawCurve(){
        const W = 720, H = 260, P = 40;
        const innerW = W - P*2, innerH = H - P*2;
        const xPix = a => P + (a / A_MAX) * innerW;
        const yPix = y => H - P - (y / yMax) * innerH;
    
        svg.innerHTML = '';
    
        const axX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axX.setAttribute('x1', P); axX.setAttribute('y1', H-P);
        axX.setAttribute('x2', W-P); axX.setAttribute('y2', H-P);
        axX.setAttribute('stroke','currentColor');
    
        const axY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axY.setAttribute('x1', P); axY.setAttribute('y1', P);
        axY.setAttribute('x2', P); axY.setAttribute('y2', H-P);
        axY.setAttribute('stroke','currentColor');
    
    
    // X ticks every $20k
    for (let x = 0; x <= A_MAX; x += 20000){
      const X = xPix(x);
      const t = document.createElementNS('http://www.w3.org/2000/svg','line');
      t.setAttribute('x1', X); t.setAttribute('y1', H-P);
      t.setAttribute('x2', X); t.setAttribute('y2', H-P+5);
      t.setAttribute('stroke','currentColor');
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', X-14); label.setAttribute('y', H-P+18);
      label.setAttribute('font-size','10');
      label.textContent = `$${(x/1000).toFixed(0)}k`;
      svg.append(t, label);
    }
    
    // Y ticks every $10k (or $20k if tall)
    const yStep = (yMax <= 50_000 ? 10_000 : 20_000);
    for (let y = 0; y <= yMax; y += yStep){
      const Y = yPix(y);
      const t = document.createElementNS('http://www.w3.org/2000/svg','line');
      t.setAttribute('x1', P-5); t.setAttribute('y1', Y);
      t.setAttribute('x2', P);   t.setAttribute('y2', Y);
      t.setAttribute('stroke','currentColor');
      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', 6); label.setAttribute('y', Y-2);
      label.setAttribute('font-size','10');
      label.textContent = `$${y.toLocaleString()}`;
      svg.append(t, label);
    }

        let d = '';
        for (let i=0;i<curve.length;i++){
          const X = xPix(curve[i].annual), Y = yPix(curve[i].yearly);
          d += (i===0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','currentColor');
        path.setAttribute('stroke-width','2');
    
        const yLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        yLabel.setAttribute('x', P + 4); yLabel.setAttribute('y', yPix(yMax) - 6);
        yLabel.setAttribute('font-size','10');
        yLabel.textContent = '$' + Math.round(yMax).toLocaleString();
    
        const xLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLabel.setAttribute('x', xPix(A_MAX) - 44); xLabel.setAttribute('y', H - P + 14);
        xLabel.setAttribute('font-size','10');
        xLabel.textContent = '$' + A_MAX.toLocaleString();
    
        const xTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        xTitle.setAttribute('x', W/2); xTitle.setAttribute('y', H - 6);
        xTitle.setAttribute('text-anchor','middle');
        xTitle.textContent = 'Annual household income';
    
        const yTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        yTitle.setAttribute('x', 16); yTitle.setAttribute('y', H/2);
        yTitle.setAttribute('text-anchor','middle');
        yTitle.setAttribute('transform', `rotate(-90 16 ${H/2})`);
        yTitle.textContent = 'Yearly meal savings';
    
        svg.append(axX, axY, path, yLabel, xLabel, xTitle, yTitle);
      }
    
      // Render table (0..150k by $10k) with status for clarity
      function renderTable(){
        let html = `<table style="width:100%; border-collapse:collapse;">
          <thead><tr>
            <th style="text-align:left; padding:6px;">Annual income</th>
            <th style="text-align:left; padding:6px;">Status</th>
            <th style="text-align:left; padding:6px;">Yearly meal savings</th>
          </tr></thead><tbody>`;
        const cep = isChecked('frlCep');
        for (let a = 0; a <= A_MAX; a += TABLE_STEP){
          const status = frlStatus(
            a,
            Number(userInfo.familySize) || kids.length || 1,
            cep,
            true /* offered placeholder for table row label */
          ).status;
          const y = yearlySavingsAtIncome(a);
          html += `<tr>
            <td style="padding:6px;">$${a.toLocaleString()}</td>
            <td style="padding:6px;">${status}</td>
            <td style="padding:6px;">$${Math.round(y).toLocaleString()}</td>
          </tr>`;
        }
        html += `</tbody></table>`;
        tableWrap.innerHTML = html;
      }
    
      // KPI for typed income
      function updateKpis(){
        const a = Number(incomeEl.value) || 0;
        const y = yearlySavingsAtIncome(a);
        yearlyEl.textContent = '$' + Math.round(y).toLocaleString();
        monthlyEl.textContent = '$' + Math.round(y/12).toLocaleString();
      }
    
      // Orchestrate
      function refreshAll(){
        rebuildCurveAndSave();
        drawCurve();
        renderTable();
        updateKpis();
      }
    
      // Wire inputs (recalculate on change)
      ['frlPaidLunch','frlPaidBfast','frlBreakfastOffered','frlCep','frlReducedZero'].forEach(id=>{
        document.getElementById(id).addEventListener('input', refreshAll);
        document.getElementById(id).addEventListener('change', refreshAll);
      });
      kidsDiv.addEventListener('change', (e) => {
        if (e.target && e.target.id && e.target.id.startsWith('frlOffer_')) refreshAll();
      });
      incomeEl.addEventListener('input', updateKpis);
    
      // First paint
      refreshAll();
    
      // Continue
      document.getElementById('frlNext').addEventListener('click', () => {
        // Persist a snapshot for the typed income (optional)
        const a = Number(incomeEl.value) || 0;
        const y = yearlySavingsAtIncome(a);
        budget.benefits = budget.benefits || {};
        budget.benefits.frl = {
          yearlyOffset: y,
          monthlyApprox: Math.round(y/12),
          prices: {
            lunch: n2(getVal('frlPaidLunch')),
            breakfast: n2(getVal('frlPaidBfast'))
          },
          breakfastOffered: isChecked('frlBreakfastOffered'),
          cepAllKidsEatFree: isChecked('frlCep'),
          reducedZeroCopay: isChecked('frlReducedZero'),
          daysPerYear: DAYS
        };
        goNextBenefit('frl', userInfo, budget);
      }, { once:true });
    }
    
    
    // ========== 8. SSI + SSDI (Combined Step, simplified screener) ==========
    function startSSIStep(userInfo, budget){
      // respect user intent toggle
      if (!willing(userInfo, budget).ssi && !willing(userInfo, budget).ssdi) {
        return goNextBenefit('ssi', userInfo, budget);
      }
    
      const app = document.getElementById('app');
    
      // ---- 2025 constants ----
      // SSI
      const FBR_INDIV  = 967;    // $/mo
      const FBR_COUPLE = 1450;   // $/mo
      const EXCL_GENERAL = 20;   // $/mo (unearned first)
      const EXCL_EARNED  = 65;   // $/mo + half of remainder
    
      // SSDI (SGA + bend points)
      const SGA_NONBLIND = 1620; // $/mo
      const SGA_BLIND    = 2700; // $/mo
      const B1 = 1226, B2 = 7391; // 2025 bend points (AIME approx)
    
      const fmt = n => '$' + Math.round(Math.max(0, n)).toLocaleString();
    
      // sensible defaults
      const defaultAnnual      = Math.max(0, Number(userInfo.annualIncome) || Number(userInfo.salaryAnnual) || 0);
      const defaultPreAnnual   = defaultAnnual || 48000;
      const defaultHHSize      = Math.min(Math.max(Number(userInfo.familySize) || 1, 1), 10);
      const is65Plus           = Number(userInfo.age) >= 65;
    
      app.innerHTML = `
        <h2>SSI + SSDI — combined (quick model)</h2>
    
        <div class="note small" style="margin-bottom:8px;">
          Quick screener first. We’ll only use advanced details if you open them.
        </div>
    
        <div class="grid">
          <label>Disability ≥ 12 months or age 65+?
            <select id="elig_dis">
              <option value="yes" ${is65Plus?'selected':''}>Yes</option>
              <option value="unsure" ${(!is65Plus && !userInfo.isDisabled)?'selected':''}>Not sure</option>
              <option value="no">No</option>
            </select>
          </label>
          <label>Applying as
            <select id="ssi_couple">
              <option value="no" selected>Individual</option>
              <option value="yes">Couple</option>
            </select>
          </label>
          <label>Work credits for SSDI?
            <select id="ssdi_credits">
              <option value="yes" selected>Yes</option>
              <option value="unsure">Not sure</option>
              <option value="no">No</option>
            </select>
          </label>
          <label>Blind?
            <select id="ssdi_blind">
              <option value="no" selected>No</option>
              <option value="yes">Yes</option>
            </select>
          </label>
          <label>Resources under SSI limit?
            <select id="ssi_assets">
              <option value="yes" selected>Yes</option>
              <option value="unsure">Not sure</option>
              <option value="no">No</option>
            </select>
          </label>
        </div>
    
        <div class="grid" style="margin-top:8px;">
          <label>Try a <strong>current earned income (annual)</strong>
            $<input id="ss_both_annual" type="number" min="0" step="1000" value="${defaultAnnual}">
          </label>
          <label>Household size
            <input id="ssi_hh" type="number" min="1" step="1" value="${defaultHHSize}">
          </label>
        </div>
    
        <details style="margin:10px 0;">
          <summary><strong>Advanced (optional)</strong></summary>
          <div class="grid" style="margin-top:8px;">
            <label>Other unearned income (monthly, besides SSDI)
              $<input id="ssi_other_unearned" type="number" min="0" step="1" value="0">
            </label>
            <label>In-kind support (free food & shelter)?
              <select id="ssi_vtr">
                <option value="no" selected>No</option>
                <option value="yes">Yes (SSI max reduced by 1/3)</option>
              </select>
            </label>
            <label>Pre-disability annual earnings (PIA estimate)
              $<input id="ssdi_pre" type="number" min="0" step="1000" value="${defaultPreAnnual}">
            </label>
          </div>
        </details>
    
        <div class="small" id="eligNote" style="margin:6px 0 10px;">—</div>
    
        <div id="ssKpis">
          <div><strong>SSDI (monthly):</strong> <span id="kSSDI">$0</span></div>
          <div><strong>SSI (monthly, after counting SSDI):</strong> <span id="kSSI">$0</span></div>
          <div class="small muted">Total ≈ <span id="kTotMo">$0</span>/mo · <span id="kTotYr">$0</span>/yr</div>
        </div>
    
        <div class="row"></div>
        <svg id="ssSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="Total (SSI+SSDI) vs earned income"></svg>
    
        <div class="row"></div>
        <div id="ssTableWrap"></div>
    
        <div class="row"></div>
        <button id="ssNext" class="primary">Next</button>
      `;
      pushStep(() => startSSIStep(userInfo, budget));
    
      // DOM
      const disEl     = document.getElementById('elig_dis');
      const coupleEl  = document.getElementById('ssi_couple');
      const assetsEl  = document.getElementById('ssi_assets');
      const vtrEl     = document.getElementById('ssi_vtr');
      const otherUneEl= document.getElementById('ssi_other_unearned');
    
      const credEl    = document.getElementById('ssdi_credits');
      const blindEl   = document.getElementById('ssdi_blind');
      const preEl     = document.getElementById('ssdi_pre');
    
      const aEl       = document.getElementById('ss_both_annual');
      const hhEl      = document.getElementById('ssi_hh');
    
      const kSSDI     = document.getElementById('kSSDI');
      const kSSI      = document.getElementById('kSSI');
      const kTotMo    = document.getElementById('kTotMo');
      const kTotYr    = document.getElementById('kTotYr');
      const eligNote  = document.getElementById('eligNote');
    
      const svg       = document.getElementById('ssSvg');
      const tableWrap = document.getElementById('ssTableWrap');
    
      // Graph ranges / grid
      const A_MAX = 150000;
      const GRAPH_STEP = 100;
      const TABLE_STEP = 10000;
    
      // ---- SSDI helpers ----
      function estPIAFromAIME(aime){
        const a = Math.max(0, aime||0);
        const p1 = Math.min(a, B1);
        const p2 = Math.min(Math.max(a - B1, 0), B2 - B1);
        const p3 = Math.max(a - B2, 0);
        return Math.round(0.90*p1 + 0.32*p2 + 0.15*p3);
      }
      function ssdiMonthlyAt({ currentAnnual, preAnnual, blind, hasCredits }){
        if (!hasCredits) return 0;
        const aime = Math.max(0, (preAnnual||0)/12);
        const pia  = estPIAFromAIME(aime);
        const sga  = blind ? SGA_BLIND : SGA_NONBLIND;
        const currentMonthly = Math.max(0, (currentAnnual||0)/12);
        return (currentMonthly > sga) ? 0 : pia;
      }
    
      // ---- SSI helper (counts SSDI as unearned) ----
      function ssiMonthlyAt({ earnedAnnual, otherUnearnedMonthly, ssdiMonthly, couple, vtr, assetsOK }){
        if (!assetsOK) return 0;
        const FBR = couple ? FBR_COUPLE : FBR_INDIV;
        const adjFBR = vtr ? (FBR * (2/3)) : FBR;
    
        const earnedMonthly = Math.max(0, (earnedAnnual||0) / 12);
        const unearned = Math.max(0, (otherUnearnedMonthly||0)) + Math.max(0, ssdiMonthly||0);
    
        // $20 general exclusion (unearned first)
        const unearnedAfterGeneral = Math.max(0, unearned - EXCL_GENERAL);
        const leftoverGeneral = Math.max(0, EXCL_GENERAL - Math.min(EXCL_GENERAL, unearned));
    
        // Earned exclusion: $65 + leftover-from-$20, then half remainder
        const earnedAfterExcl = Math.max(0, earnedMonthly - (EXCL_EARNED + leftoverGeneral));
        const countableEarned = earnedAfterExcl / 2;
    
        const countable = unearnedAfterGeneral + countableEarned;
        return Math.max(0, Math.round(adjFBR - countable));
      }
    
      function eligSummary({ disOr65, hasCredits, assetsOK, blind, currentAnnual }){
        if (disOr65 === 'no') return 'Not eligible: disability/65+ requirement not met.';
        const sga = (blind==='yes') ? SGA_BLIND : SGA_NONBLIND;
        const sgaLine = `SGA gate: $${sga.toLocaleString()}/mo`;
        const overSGA = ((Number(currentAnnual)||0)/12) > sga;
        const ssdiline = (hasCredits==='no')
          ? 'SSDI: likely not eligible (work credits).'
          : overSGA
            ? 'SSDI: earnings appear over SGA (would block SSDI).'
            : 'SSDI: may qualify (subject to medical/work review).';
        const ssiline = (assetsOK==='no')
          ? 'SSI: resources appear over limit.'
          : 'SSI: may qualify (subject to income/resource rules).';
        return `${ssdiline} ${ssiline} ${sgaLine}.`;
      }
    
      function rebuildAndRender(){
        const disOr65   = disEl.value;                 // yes / unsure / no
        const couple    = (coupleEl.value === 'yes');
        const assetsVal = assetsEl.value;              // yes / unsure / no
        const assetsOK  = assetsVal !== 'no';          // treat unsure as maybe (we’ll flag in note)
        const vtr       = (vtrEl?.value === 'yes');
        const otherUne  = Number(otherUneEl?.value)||0;
    
        const creditVal = credEl.value;                // yes / unsure / no
        const hasCredits= creditVal !== 'no';          // treat unsure as maybe
        const blind     = (blindEl.value === 'yes') ? 'yes' : 'no';
        const preAnnual = Number(preEl?.value)||0;
    
        const currentAnnual = Number(aEl.value)||0;
    
        // If user says "No" to disability/65+, skip the whole step
        if (disOr65 === 'no') {
          kSSDI.textContent = fmt(0);
          kSSI.textContent  = fmt(0);
          kTotMo.textContent= fmt(0);
          kTotYr.textContent= fmt(0);
          eligNote.textContent = 'Not eligible (no disability/65+).';
          svg.innerHTML = '';
          tableWrap.innerHTML = '';
          // Still allow Next to proceed
          return;
        }
    
        // Build a canonical grid (0..150k in $100)
        const grid = (Array.isArray(budget._salaries) && budget._salaries.length)
          ? budget._salaries
          : Array.from({length: (A_MAX/GRAPH_STEP)+1}, (_,i)=> i*GRAPH_STEP);
        if (!budget._salaries) budget._salaries = grid;
    
        const curve = [];
        let yMax = 0;
    
        // Vectors for roll-up
        const ssdiYearly = [];
        const ssiYearly  = [];
        const totYearly  = [];
    
        for (let i=0;i<grid.length;i++){
          const a = grid[i]; // earned annual
          const mSSDI = ssdiMonthlyAt({ currentAnnual:a, preAnnual, blind:(blind==='yes'), hasCredits });
          const mSSI  = ssiMonthlyAt({ earnedAnnual:a, otherUnearnedMonthly:otherUne, ssdiMonthly:mSSDI, couple, vtr, assetsOK });
          const yTot  = (mSSDI + mSSI) * 12;
    
          curve.push({ annual:a, yearly:yTot });
          if (yTot > yMax) yMax = yTot;
    
          ssdiYearly.push(mSSDI * 12);
          ssiYearly.push(mSSI * 12);
          totYearly.push(yTot);
        }
        if (yMax < 1200) yMax = 1200;
    
        // Save series for later steps
        budget._series = budget._series || {};
        budget._series.ssdi_yearly     = ssdiYearly;  // +benefit
        budget._series.ssi_yearly      = ssiYearly;   // +benefit (already reduced by SSDI)
        budget._series.ssi_ssdi_yearly = totYearly;   // +benefit (combined)
    
        // ---- SVG (single line = Total) ----
        const W=720,H=260,P=40, innerW=W-P*2, innerH=H-P*2;
        const xPix = a => P + (a/A_MAX)*innerW;
        const yPix = y => H - P - (y/yMax)*innerH;
    
        svg.innerHTML = '';
    
        const axX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axX.setAttribute('x1',P); axX.setAttribute('y1',H-P);
        axX.setAttribute('x2',W-P); axX.setAttribute('y2',H-P);
        axX.setAttribute('stroke','currentColor');
    
        const axY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axY.setAttribute('x1',P); axY.setAttribute('y1',P);
        axY.setAttribute('x2',P); axY.setAttribute('y2',H-P);
        axY.setAttribute('stroke','currentColor');
    
        // X ticks $20k
        for(let x=0;x<=A_MAX;x+=20000){
          const X=xPix(x);
          const t=document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1',X); t.setAttribute('y1',H-P);
          t.setAttribute('x2',X); t.setAttribute('y2',H-P+5);
          t.setAttribute('stroke','currentColor');
          const lab=document.createElementNS('http://www.w3.org/2000/svg','text');
          lab.setAttribute('x',X-14); lab.setAttribute('y',H-P+18);
          lab.setAttribute('font-size','10'); lab.textContent=`$${(x/1000).toFixed(0)}k`;
          svg.append(t, lab);
        }
        // Y ticks ~5 steps
        const yStep = Math.max(2000, Math.ceil(yMax/5/1000)*1000);
        for(let y=0;y<=yMax;y+=yStep){
          const Y=yPix(y);
          const t=document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1',P-5); t.setAttribute('y1',Y);
          t.setAttribute('x2',P);   t.setAttribute('y2',Y);
          t.setAttribute('stroke','currentColor');
          const lab=document.createElementNS('http://www.w3.org/2000/svg','text');
          lab.setAttribute('x',6); lab.setAttribute('y',Y-2);
          lab.setAttribute('font-size','10'); lab.textContent=`$${y.toLocaleString()}`;
          svg.append(t, lab);
        }
    
        // path (Total)
        let d=''; for(let i=0;i<curve.length;i++){
          const X=xPix(curve[i].annual), Y=yPix(curve[i].yearly);
          d += (i===0?`M ${X} ${Y}`:` L ${X} ${Y}`);
        }
        const path=document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d',d); path.setAttribute('fill','none');
        path.setAttribute('stroke','currentColor'); path.setAttribute('stroke-width','2');
    
        // marker
        const marker=document.createElementNS('http://www.w3.org/2000/svg','circle');
        marker.setAttribute('id','ssBothMarker'); marker.setAttribute('r','4'); marker.setAttribute('fill','currentColor');
    
        // titles
        const xTitle=document.createElementNS('http://www.w3.org/2000/svg','text');
        xTitle.setAttribute('x', W/2); xTitle.setAttribute('y', H-6);
        xTitle.setAttribute('text-anchor','middle'); xTitle.textContent='Annual earned income';
    
        const yTitle=document.createElementNS('http://www.w3.org/2000/svg','text');
        yTitle.setAttribute('x', 16); yTitle.setAttribute('y', H/2);
        yTitle.setAttribute('text-anchor','middle');
        yTitle.setAttribute('transform',`rotate(-90 16 ${H/2})`);
        yTitle.textContent='SSI + SSDI (yearly)';
    
        svg.append(axX,axY,path,marker,xTitle,yTitle);
    
        // KPI + marker for typed income
        const a = Number(currentAnnual)||0;
        const mSSDI = ssdiMonthlyAt({ currentAnnual:a, preAnnual, blind:(blind==='yes'), hasCredits });
        const mSSI  = ssiMonthlyAt({ earnedAnnual:a, otherUnearnedMonthly:otherUne, ssdiMonthly:mSSDI, couple, vtr, assetsOK });
    
        kSSDI.textContent = fmt(mSSDI);
        kSSI.textContent  = fmt(mSSI);
        kTotMo.textContent= fmt(mSSDI + mSSI);
        kTotYr.textContent= fmt((mSSDI + mSSI)*12);
    
        // marker position
        const clamped = Math.max(0, Math.min(A_MAX, a));
        document.getElementById('ssBothMarker').setAttribute('cx', P + (clamped/A_MAX)*(W-P*2));
        document.getElementById('ssBothMarker').setAttribute('cy', yPix((mSSDI + mSSI)*12));
    
        // Table (every $10k): show breakdown
        let html = `<table style="width:100%;border-collapse:collapse;">
          <thead><tr>
            <th style="text-align:left;padding:6px;">Annual earned</th>
            <th style="text-align:left;padding:6px;">SSDI (mo)</th>
            <th style="text-align:left;padding:6px;">SSI (mo)</th>
            <th style="text-align:left;padding:6px;">Total (yr)</th>
          </tr></thead><tbody>`;
        for(let a=0;a<=A_MAX;a+=TABLE_STEP){
          const mD = ssdiMonthlyAt({ currentAnnual:a, preAnnual, blind:(blind==='yes'), hasCredits });
          const mS = ssiMonthlyAt({ earnedAnnual:a, otherUnearnedMonthly:otherUne, ssdiMonthly:mD, couple, vtr, assetsOK });
          html += `<tr>
            <td style="padding:6px;">$${a.toLocaleString()}</td>
            <td style="padding:6px;">${fmt(mD)}</td>
            <td style="padding:6px;">${fmt(mS)}</td>
            <td style="padding:6px;">${fmt((mD+mS)*12)}</td>
          </tr>`;
        }
        html += `</tbody></table>`;
        tableWrap.innerHTML = html;
    
        // Eligibility banner
        eligNote.textContent = eligSummary({
          disOr65, hasCredits: creditVal, assetsOK: assetsVal, blind, currentAnnual
        });
      }
    
      // live updates
      ['change','input'].forEach(evt=>{
        [disEl,coupleEl,assetsEl,vtrEl,otherUneEl,credEl,blindEl,preEl,aEl,hhEl].forEach(el=>{
          if (el) el.addEventListener(evt, rebuildAndRender);
        });
      });
    
      rebuildAndRender();
    
      document.getElementById('ssNext').addEventListener('click', () => {
        // continue the router; we also skip dedicated SSDI step below
        goNextBenefit('ssi', userInfo, budget);
      }, { once:true });
    }
    
    // (Optional) Keep router unchanged, but skip the dedicated SSDI step:
    function startSSDIStep(userInfo, budget){
      return goNextBenefit('ssdi', userInfo, budget);
    }

    
    
    
    /***** ===================== 9. PIPP (Ohio) — Benefits Wizard ===================== *****/
    
    // ---- Config: Ohio averages (2025-ish anchors) ----
    const OH_ELEC_RATE = 0.163;   // $/kWh (Ohio residential avg) — keep simple
    const OH_GAS_RATE  = 1.43;    // $/therm (Ohio residential avg)
    
    // PIPP rules (simple)
    const PIPP_RATE_ELEC = 0.05;       // 5% of monthly income
    const PIPP_RATE_GAS  = 0.05;       // 5% of monthly income
    const PIPP_MIN_PER_UTILITY = 10;   // $10 minimum per active utility
    const PIPP_ELIG_FPL_MULT = 1.75;   // 175% FPL ceiling
    
    // Bedrooms → typical square footage (proxy)
    function sqftFromBedrooms(beds){
      const b = Math.max(1, Math.min(6, Number(beds)||3));
      const map = {1:900, 2:1200, 3:1800, 4:2400, 5:2800, 6:3200};
      return map[b];
    }
    
    // Age bucket → multiplier
    function ageMult(bucket){
      // bucket keys: 'pre1980','1980_1999','2000_2009','2010_2019','2020p'
      return {
        pre1980: 1.20,
        '1980_1999': 1.10,
        '2000_2009': 1.00,
        '2010_2019': 0.95,
        '2020p': 0.90
      }[bucket] ?? 1.00;
    }
    
    // Ohio baseline consumptions (monthly averages)
    const BASE_KWH_MONTH = 800;  // kWh/mo
    const BASE_THERM_MONTH = 61; // therms/mo
    
    // 2025 HHS Poverty Guidelines (48 states/DC). >10 adds $5,440 per extra person.
    const FPL_2025 = [null, 15590, 21030, 26470, 31910, 37350, 42790, 48230, 53670, 59110, 64550];
    function getFPL(size){
      return size <= 10 ? FPL_2025[size] : (FPL_2025[10] + (size - 10) * 5440);
    }

    
    // Bedrooms-based estimator (monthly)
    function estimateElecGasMonthly({bedrooms, ageBucket, occupants, primaryHeat}){
      const sqft = sqftFromBedrooms(bedrooms);
      const sizeFactor = Math.pow(sqft / 1800, 0.8);
      const aMult = ageMult(ageBucket);
      const occElec = 1 + Math.max(0, (Number(occupants||1) - 2)) * 0.04; // +4%/extra person
      const heatAdj = (primaryHeat === 'electric') ? 1.03 : 1.00;
    
      const kWh = Math.max(400, BASE_KWH_MONTH * sizeFactor * aMult * occElec * heatAdj);
      const elecCost = kWh * OH_ELEC_RATE;
    
      let therms = 0, gasCost = 0;
      if (primaryHeat === 'gas'){
        const occAdd = Math.max(0, (Number(occupants||1) - 2)) * 1.5; // hot water/cooking bump
        therms = Math.max(5, BASE_THERM_MONTH * sizeFactor * aMult + occAdd);
        gasCost = therms * OH_GAS_RATE;
      }
    
      return {
        sqft, kWh: Math.round(kWh), therms: Math.round(therms),
        elecMonthly: +elecCost.toFixed(2),
        gasMonthly: +gasCost.toFixed(2),
        totalMonthly: +(elecCost + gasCost).toFixed(2)
      };
    }
    
    // ===== UI step =====
    function startPIPPStep(userInfo, budget){
      // Respect the router's willingness flag
      if (!willing(userInfo, budget).pipp) {
        return goNextBenefit('pipp', userInfo, budget);
      }
    
      const app = document.getElementById('app');
    
      // Basics
      const hhSize = Number(userInfo.familySize || userInfo.householdSize || 1);
      const grossAnnual = Number.isFinite(userInfo.grossAnnualIncome) ? Number(userInfo.grossAnnualIncome)
                          : (Number.isFinite(userInfo.grossMonthlyIncome) ? Number(userInfo.grossMonthlyIncome) * 12 : 0);
      const fplEligible = grossAnnual <= (PIPP_ELIG_FPL_MULT * getFPL(hhSize));
    
      const defaults = {
        bedrooms:  userInfo.housing?.bedrooms ?? 3,
        ageBucket: userInfo.housing?.ageBucket ?? '2000_2009',
        occupants: userInfo.occupants ?? hhSize,
        primaryHeat: userInfo.utilities?.primaryHeat ?? 'gas' // 'gas' | 'electric'
      };
    
      app.innerHTML = `
        <h2>PIPP (Percentage of Income Payment Plan)</h2>
        <p>If you’re income-eligible, your electric/gas payment is capped by income. Otherwise we’ll estimate typical costs using bedrooms, age of home, and occupants.</p>
    
        <div class="grid" style="margin-top:.75rem;">
          <label>Bedrooms
            <select id="pippBeds">
              ${[1,2,3,4,5,6].map(n => `<option value="${n}" ${n===defaults.bedrooms?'selected':''}>${n}${n===6?'+':''}</option>`).join('')}
            </select>
          </label>
          <label>Year built
            <select id="pippAge">
              <option value="pre1980">Before 1980</option>
              <option value="1980_1999">1980–1999</option>
              <option value="2000_2009">2000–2009</option>
              <option value="2010_2019">2010–2019</option>
              <option value="2020p">2020+</option>
            </select>
          </label>
          <label>Occupants
            <input id="pippOcc" type="number" min="1" value="${defaults.occupants}">
          </label>
          <label>Primary heat
            <select id="pippHeat">
              <option value="gas" ${defaults.primaryHeat==='gas'?'selected':''}>Gas</option>
              <option value="electric" ${defaults.primaryHeat==='electric'?'selected':''}>Electric</option>
            </select>
          </label>
        </div>
    
        <button id="pippCalc" class="primary">Calculate</button>
    
        <div class="row"></div>
        <label>Try an <strong>annual salary</strong>:
          $<input type="number" id="pippTryIncome" min="0" step="1000" placeholder="e.g., 48000" value="${grossAnnual || ''}">
        </label>
    
        <div class="row"></div>
        <div id="pippKpis">
          <div><strong>Yearly electric+gas payment:</strong> <span id="pippKpiYearly">$0</span></div>
          <div class="small" id="pippMode">—</div>
        </div>
    
        <div class="row"></div>
        <svg id="pippSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="PIPP cost curve"></svg>
    
        <div class="row"></div>
        <div id="pippTableWrap"></div>
    
        <div id="pippOut" style="margin-top:.75rem;"></div>
        <button id="pippNext" class="primary" style="display:none;">Next</button>
      `;
    
      // set default for age bucket after render
      document.getElementById('pippAge').value = defaults.ageBucket;
    
    function computeMonthlyAt(annualIncome, params){
      const fpl = getFPL(hhSize);
      const eligible = annualIncome <= (PIPP_ELIG_FPL_MULT * fpl);
      const est = estimateElecGasMonthly(params); // monthly baseline from bedrooms/age/occupants
    
      if (eligible){
        const hasElec = true;
        const hasGas  = (params.primaryHeat === 'gas'); // treat gas as second utility
        const monthlyMAGI = annualIncome / 12;
    
        let cap = 0;
        if (hasElec && hasGas) {
          // both utilities → 5% + 5% (=10%) with $10/utility floor
          cap = Math.max(2 * PIPP_MIN_PER_UTILITY, monthlyMAGI * (PIPP_RATE_ELEC + PIPP_RATE_GAS));
        } else if (hasElec) {
          // electric-only → 10% or $10
          cap = Math.max(PIPP_MIN_PER_UTILITY, monthlyMAGI * 0.10);
        } else if (hasGas) {
          // gas-only → 5% or $10
          cap = Math.max(PIPP_MIN_PER_UTILITY, monthlyMAGI * PIPP_RATE_GAS);
        }
    
        // Hard ceiling: PIPP cap may not exceed the estimator amount
        cap = Math.min(cap, est.totalMonthly);
    
        return { monthly: Math.ceil(cap), eligible: true, est };
      }
    
      // Not eligible → estimator governs
      return { monthly: est.totalMonthly, eligible: false, est };
    }

    
      // ----- state & DOM refs -----
      const PIPP_A_MAX = 150000;        // inclusive X-axis
      const PIPP_GRAPH_STEP = 100;      // $100 increments for the graph & saved vector
      const PIPP_TABLE_STEP = 10000;    // $10k rows for the table
      const svg = document.getElementById('pippSvg');
      const kpiYearly = document.getElementById('pippKpiYearly');
      const modeEl = document.getElementById('pippMode');
      const tableWrap = document.getElementById('pippTableWrap');
      const tryIncomeEl = document.getElementById('pippTryIncome');
    
      const W = 720, Hpx = 260, P = 40;
      const innerW = W - P*2, innerH = Hpx - P*2;
    
      function xPix(annual){ return P + (annual / PIPP_A_MAX) * innerW; }
      function yPix(yearly, yMax){ return Hpx - P - (yearly / yMax) * innerH; }
      function fmt(n){ return '$' + (Math.max(0, Math.round(n))).toLocaleString(); }
    
      let lastParams = null;
      let yMax = 0;
    
        function buildSeries(params){
          const curve = [];
          const table = [];
          yMax = 0;
        
          // Graph: 0..150k in $100 steps, YEARLY amounts
          for (let a = 0; a <= PIPP_A_MAX; a += PIPP_GRAPH_STEP){
            const r = computeMonthlyAt(a, params);
            const y = (Number(r.monthly)||0) * 12;
            curve.push({ annual:a, yearly:y, eligible:r.eligible });
            if (y > yMax) yMax = y;
          }
        
          // Table: 0..150k in $10k steps, YEARLY totals
          for (let a = 0; a <= PIPP_A_MAX; a += PIPP_TABLE_STEP){
            const r = computeMonthlyAt(a, params);
            table.push({ annual:a, yearly:(Number(r.monthly)||0)*12, eligible:r.eligible });
          }
        
          if (yMax < 1200) yMax = 1200;
        
          // keep your existing series for UI
          budget._series = budget._series || {};
          budget._series.pipp = { points: table.slice(), curve: curve.slice() };
        
          return { table, curve };
        }

        function saveCanonicalVector(params){
          // Reuse global grid if present; else set it to 0..150k by $100
          const grid = (Array.isArray(budget._salaries) && budget._salaries.length)
            ? budget._salaries
            : Array.from({length: (PIPP_A_MAX / PIPP_GRAPH_STEP) + 1}, (_, i) => i * PIPP_GRAPH_STEP);
          if (!budget._salaries) budget._salaries = grid;
        
          // PIPP payment is a COST: store negative yearly values
          const vec = grid.map(a => {
            const r = computeMonthlyAt(a, params);
            return -Math.round((Number(r.monthly)||0) * 12);
          });
        
          budget._series = budget._series || {};
          budget._series.pipp_yearly = vec;
        
          // Optional metadata
          budget._series_meta = budget._series_meta || {};
          budget._series_meta.pipp = {
            graph_step: PIPP_GRAPH_STEP,
            table_step: PIPP_TABLE_STEP,
            fpl_multiplier: PIPP_ELIG_FPL_MULT,
            rates: { elec: OH_ELEC_RATE, gas: OH_GAS_RATE }
          };
        }

    
      function drawCurve(curve){
        svg.innerHTML = '';
        // axes
        const axX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axX.setAttribute('x1', P); axX.setAttribute('y1', Hpx-P);
        axX.setAttribute('x2', W-P); axX.setAttribute('y2', Hpx-P);
        axX.setAttribute('stroke','currentColor');
    
        const axY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axY.setAttribute('x1', P); axY.setAttribute('y1', P);
        axY.setAttribute('x2', P); axY.setAttribute('y2', Hpx-P);
        axY.setAttribute('stroke','currentColor');
    
        let d = '';
        for (let i = 0; i < curve.length; i++){
          const { annual, yearly } = curve[i];
          const X = xPix(annual), Y = yPix(yearly, yMax);
          d += (i === 0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','currentColor');
        path.setAttribute('stroke-width','2');
    
        // marker
        const marker = document.createElementNS('http://www.w3.org/2000/svg','circle');
        marker.setAttribute('id','pippMarker');
        marker.setAttribute('r','4');
        marker.setAttribute('fill','currentColor');
    
        // labels
        const yLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        yLabel.setAttribute('x', P + 4); yLabel.setAttribute('y', yPix(yMax, yMax) - 6);
        yLabel.setAttribute('font-size','10');
        yLabel.textContent = fmt(yMax);
    
        const xLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLabel.setAttribute('x', xPix(PIPP_A_MAX) - 44); xLabel.setAttribute('y', Hpx - P + 14);
        xLabel.setAttribute('font-size','10');
        xLabel.textContent = '$' + PIPP_A_MAX.toLocaleString();
    
        const xTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        xTitle.setAttribute('x', W/2); xTitle.setAttribute('y', Hpx - 6);
        xTitle.setAttribute('text-anchor','middle');
        xTitle.textContent = 'Annual salary';
    
        const yTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        yTitle.setAttribute('x', 16); yTitle.setAttribute('y', Hpx/2);
        yTitle.setAttribute('text-anchor','middle');
        yTitle.setAttribute('transform', `rotate(-90 16 ${Hpx/2})`);
        yTitle.textContent = 'Yearly electric + gas payment';
    
        svg.append(axX, axY, path, marker, yLabel, xLabel, xTitle, yTitle);
      }
    
      function renderTable(table){
        let html = `<table style="width:100%; border-collapse:collapse;">
          <thead><tr>
            <th style="text-align:left; padding:6px;">Annual income</th>
            <th style="text-align:left; padding:6px;">Yearly payment</th>
            <th style="text-align:left; padding:6px;">Mode</th>
          </tr></thead><tbody>`;
        for (const r of table){
          html += `<tr>
            <td style="padding:6px;">$${r.annual.toLocaleString()}</td>
            <td style="padding:6px;">$${Math.round(r.yearly).toLocaleString()}</td>
            <td style="padding:6px;">${r.eligible ? 'PIPP cap' : 'Estimator'}</td>
          </tr>`;
        }
        html += `</tbody></table>`;
        tableWrap.innerHTML = html;
      }
    
      function updateKpiAndMarker(){
        if (!lastParams) return;
        const a = Math.max(0, Math.min(PIPP_A_MAX, Number(tryIncomeEl.value) || 0));
        const r = computeMonthlyAt(a, lastParams);
        const yearly = (Number(r.monthly)||0) * 12;
        kpiYearly.textContent = fmt(yearly);
        modeEl.textContent = r.eligible ? 'Using PIPP income cap' : 'Using bedrooms-based estimator';
    
        const marker = document.getElementById('pippMarker');
        if (marker){
          marker.setAttribute('cx', xPix(a));
          marker.setAttribute('cy', yPix(yearly, yMax));
        }
      }
    
      function calcAndRender(){
        const params = {
          bedrooms:   Number(document.getElementById('pippBeds').value),
          ageBucket:  document.getElementById('pippAge').value,
          occupants:  Number(document.getElementById('pippOcc').value || hhSize),
          primaryHeat:document.getElementById('pippHeat').value
        };
        lastParams = params;
    
        // Calculate based on the user's current income first (for the summary)
        const here = computeMonthlyAt(grossAnnual, params);
        const monthly = here.monthly;
        const eligibleNow = here.eligible;
    
        // Persist detail
        budget.benefits = budget.benefits || {};
        budget.benefits.pipp = {
          willingToApply: true,
          fplEligible: fplEligible,
          eligible: eligibleNow,
          bedrooms: params.bedrooms,
          ageBucket: params.ageBucket,
          occupants: params.occupants,
          primaryHeat: params.primaryHeat,
          ohioRates: { elecPerKWh: OH_ELEC_RATE, gasPerTherm: OH_GAS_RATE },
          estimator: estimateElecGasMonthly(params),
          monthlyPayment: +monthly,
          ruleNote: eligibleNow
            ? 'Eligible for PIPP: 5% per utility (10% if both) with $10 min/utility.'
            : 'Over 175% FPL — using bedrooms-based Ohio estimator for typical monthly elec+gas.',
          source: eligibleNow ? 'pipp-cap' : 'estimator'
        };
    
        // Build series, curve & table (yearly)
        const { table, curve } = buildSeries(params);
        drawCurve(curve);
        renderTable(table);
        updateKpiAndMarker();
        saveCanonicalVector(params);
    
        // small textual summary
        const out = document.getElementById('pippOut');
        out.innerHTML = eligibleNow
          ? `<p><strong>PIPP eligible at your current income.</strong> Capped electric+gas: <strong>$${Math.round(monthly)}/mo</strong>.</p>`
          : `<p><strong>Not FPL-eligible for PIPP at your current income.</strong> Estimated electric+gas: <strong>$${Number(monthly).toFixed(2)}/mo</strong>.</p>`;
    
        document.getElementById('pippNext').style.display = 'inline-block';
      }
    
      document.getElementById('pippCalc').addEventListener('click', calcAndRender, { once:false });
      tryIncomeEl.addEventListener('input', updateKpiAndMarker);
    
      // allow back nav
      pushStep(() => startPIPPStep(userInfo, budget));
      document.getElementById('pippNext').addEventListener('click',
        () => goNextBenefit('pipp', userInfo, budget),
        { once:true }
      );
    }






//Final Analyses

    // ========== Final Sweep: Money Available to Pay Your Budget ==========
    function renderFinalAvailability(userInfo, budget) {
      const app = document.getElementById('app');
      app.innerHTML = `
        <h2>Take-home vs Costs & Benefits — Final Availability</h2>
        <svg id="availSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="Availability curve"></svg>
        <div class="row"></div>
        <div id="availTable"></div>
      `;
    
      // Keep back-nav behavior
      if (typeof pushStep === 'function') {
        pushStep(() => renderFinalAvailability(userInfo, budget));
      }
    
      // ---------- Local helpers (self-contained) ----------
      function clamp(n){ return Number.isFinite(n) ? n : 0; }
    
      // Canonical grid: reuse the global $100 grid if present; else install it (0..150k)
      const A_MAX = 150000;
      const STEP  = 100;
      const GRID = (Array.isArray(budget._salaries) && budget._salaries.length)
        ? budget._salaries
        : Array.from({ length: (A_MAX / STEP) + 1 }, (_, i) => i * STEP);
      if (!budget._salaries) budget._salaries = GRID;
    
      const S = budget._series || {};
    
      // Interpolate a yearly vector that's aligned to GRID (linear between grid ticks)
      function sampleVec(key, annual){
        const vec = S[key];
        if (!Array.isArray(vec) || vec.length !== GRID.length) return 0;
        if (annual <= GRID[0]) return clamp(vec[0]);
        if (annual >= GRID[GRID.length-1]) return clamp(vec[vec.length-1]);
        // binary search for bracket
        let lo = 0, hi = GRID.length - 1;
        while (hi - lo > 1){
          const mid = (lo + hi) >> 1;
          if (GRID[mid] <= annual) lo = mid; else hi = mid;
        }
        const t = (annual - GRID[lo]) / Math.max(1, GRID[hi] - GRID[lo]);
        return clamp(vec[lo] + t * (vec[hi] - vec[lo]));
      }
    
      // Net income sampler: prefer YEARLY vectors; fallback to any old coarse .points if present
      function sampleNetAnnual(annual){
        if (Array.isArray(S.net_after_tax_yearly) && S.net_after_tax_yearly.length === GRID.length)
          return sampleVec('net_after_tax_yearly', annual);
        if (Array.isArray(S.net_yearly) && S.net_yearly.length === GRID.length)
          return sampleVec('net_yearly', annual);
    
        // Fallback: coarse points with {annual, netAnnual}
        const pts = (S.netIncome && Array.isArray(S.netIncome.points))
          ? S.netIncome.points.slice().sort((a,b)=>a.annual-b.annual) : [];
        if (!pts.length) return 0;
        if (annual <= pts[0].annual) return clamp(pts[0].netAnnual);
        if (annual >= pts[pts.length-1].annual) return clamp(pts[pts.length-1].netAnnual);
        let lo = 0, hi = pts.length - 1;
        while (hi - lo > 1){
          const mid = (lo + hi) >> 1;
          if (pts[mid].annual <= annual) lo = mid; else hi = mid;
        }
        const p0 = pts[lo], p1 = pts[hi];
        const t = (annual - p0.annual) / Math.max(1, p1.annual - p0.annual);
        return clamp(p0.netAnnual + t * (p1.netAnnual - p0.netAnnual));
      }
    
      // EdChoice sampler: use saved yearly vector if present; else sample its curve (y is tuition due)
      function sampleEdChoiceYearly(annual){
        if (Array.isArray(S.edchoice_yearly) && S.edchoice_yearly.length === GRID.length)
          return sampleVec('edchoice_yearly', annual); // already negative (cost) if saved that way
    
        const curve = (S.edchoice && Array.isArray(S.edchoice.curve)) ? S.edchoice.curve.slice().sort((a,b)=>a.x-b.x) : null;
        if (!curve || curve.length < 2) return 0;
        if (annual <= curve[0].x) return -clamp(curve[0].y);
        if (annual >= curve[curve.length-1].x) return -clamp(curve[curve.length-1].y);
        let lo = 0, hi = curve.length - 1;
        while (hi - lo > 1){
          const mid = (lo + hi) >> 1;
          if (curve[mid].x <= annual) lo = mid; else hi = mid;
        }
        const p0 = curve[lo], p1 = curve[hi];
        const t = (annual - p0.x) / Math.max(1, p1.x - p0.x);
        return -( clamp(p0.y) + t * (clamp(p1.y) - clamp(p0.y)) ); // negative = cost
      }
    
      // Unified availability: YEARLY net + benefits (positive) − costs (negative vectors already stored negative)
      function availableAt(annual){
        const net   = sampleNetAnnual(annual);
        const snap  = sampleVec('snap_yearly', annual);
        const frl   = sampleVec('frl_yearly',  annual);
    
        const health = sampleVec('healthcare_yearly', annual);   // negative
        const cc     = sampleVec('childcare_yearly',  annual);   // negative
        const pipp   = sampleVec('pipp_yearly',       annual);   // negative
    
        const idr = (budget.idrPlan === 'ICR' && Array.isArray(S.idr_icr_yearly))
          ? sampleVec('idr_icr_yearly', annual)
          : (Array.isArray(S.idr_ibr_yearly) ? sampleVec('idr_ibr_yearly', annual) : 0); // negative
    
        const ed = sampleEdChoiceYearly(annual);                 // negative

        const ssi_ssdi = Array.isArray(S.ssi_ssdi_yearly)
          ? sampleVec('ssi_ssdi_yearly', annual)
          : (sampleVec('ssdi_yearly', annual) + sampleVec('ssi_yearly', annual));
        
        return net + snap + frl + ssi_ssdi + health + cc + pipp + idr + ed;

      }
    
      // ---------- C2: Fix frugal label math ----------
      const bareBonesMonthly = Number(budget.totalMonthlyExpenses) || 0;
    
      // prefer an absolute frugal total if you have one, else bare + add-on
      const frugalAbsolute = Number(budget.totalMonthlyFrugal);
      const frugalAddon    = Number(budget.frugalFunMonthlyAddon ?? budget.frugalFunMonthly ?? 0);
    
      const frugalFunMonthly = Number.isFinite(frugalAbsolute) && frugalAbsolute > 0
        ? frugalAbsolute
        : bareBonesMonthly + Math.max(0, frugalAddon);
    
      const BARE_ANNUAL = Math.round(bareBonesMonthly * 12);
      const FUN_ANNUAL  = Math.round(frugalFunMonthly * 12);
    
      // ---------- C3: Build smooth curve on the $100 grid ----------
      const curve = [];
      let yMax = Math.max(BARE_ANNUAL, FUN_ANNUAL, 100);
      for (let a = 0; a <= A_MAX; a += STEP){
        const y = availableAt(a);       // YEARLY available
        curve.push({ x:a, y });
        if (y > yMax) yMax = y;
      }
    
      // ---------- Draw curve (SVG) ----------
      (function drawCurve(){
        const svg = document.getElementById('availSvg');
        const W = 720, H = 260, P = 40;
        const innerW = W - P*2, innerH = H - P*2;
        const xPix = a => P + (a / A_MAX) * innerW;
        const yPix = y => H - P - (y / yMax) * innerH;
    
        svg.innerHTML = '';
    
        const axX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axX.setAttribute('x1', P); axX.setAttribute('y1', H-P);
        axX.setAttribute('x2', W-P); axX.setAttribute('y2', H-P);
        axX.setAttribute('stroke','currentColor');
    
        const axY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axY.setAttribute('x1', P); axY.setAttribute('y1', P);
        axY.setAttribute('x2', P); axY.setAttribute('y2', H-P);
        axY.setAttribute('stroke','currentColor');
    
        let d = '';
        for (let i = 0; i < curve.length; i++){
          const X = xPix(curve[i].x), Y = yPix(curve[i].y);
          d += (i === 0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', 'currentColor');
        path.setAttribute('stroke-width', '2');
    
        const yLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        yLabel.setAttribute('x', P + 4); yLabel.setAttribute('y', yPix(yMax) - 6);
        yLabel.setAttribute('font-size','10');
        yLabel.setAttribute('fill','currentColor');
        yLabel.textContent = '$' + Math.round(yMax).toLocaleString();
    
        const xLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLabel.setAttribute('x', xPix(A_MAX) - 44); xLabel.setAttribute('y', H - P + 14);
        xLabel.setAttribute('font-size','10');
        xLabel.setAttribute('fill','currentColor');
        xLabel.textContent = '$' + A_MAX.toLocaleString();
    
        // Horizontal guide lines: Bare / Frugal
        function addHLine(label, yVal, dy){
          const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
          ln.setAttribute('x1', P); ln.setAttribute('y1', yPix(yVal));
          ln.setAttribute('x2', W-P); ln.setAttribute('y2', yPix(yVal));
          ln.setAttribute('stroke','currentColor');
          ln.setAttribute('stroke-dasharray','4 4');
        
          const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
          tx.setAttribute('x', P + 6);
          tx.setAttribute('y', yPix(yVal) + (dy ?? -4)); // <-- offset control
          tx.setAttribute('font-size','10');
          tx.setAttribute('fill','currentColor');
          tx.textContent = `${label} $${yVal.toLocaleString()}`;
        
          svg.append(ln, tx);
        }

        // X ticks every $20k
        for (let x = 0; x <= A_MAX; x += 20000) {
          const X = xPix(x);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', X); t.setAttribute('y1', H-P);
          t.setAttribute('x2', X); t.setAttribute('y2', H-P+5);
          t.setAttribute('stroke', 'currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', X - 14); label.setAttribute('y', H - P + 18);
          label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
          label.textContent = `$${(x/1000).toFixed(0)}k`;
          svg.append(t, label);
        }
        
        // Y ticks every $10k (or $20k if tall)
        const yStep = (yMax <= 50_000 ? 10_000 : 20_000);
        for (let y = 0; y <= yMax; y += yStep) {
          const Y = yPix(y);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', P-5); t.setAttribute('y1', Y);
          t.setAttribute('x2', P);   t.setAttribute('y2', Y);
          t.setAttribute('stroke', 'currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', 6); label.setAttribute('y', Y - 2);
          label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
          label.textContent = `$${y.toLocaleString()}`;
          svg.append(t, label);
        }


    
        svg.append(axX, axY, path, yLabel, xLabel);
        addHLine('Bare annual',   BARE_ANNUAL,  +14); // put label BELOW its line
        addHLine('Frugal annual', FUN_ANNUAL,   -6);  // put label ABOVE its line
      })();
    
      // ---------- C4: Table rows from YEARLY samplers (every $10k) ----------
      (function renderTable(){
        const rows = [];
        for (let a = 0; a <= A_MAX; a += 10000) {
          const net = Math.round(sampleNetAnnual(a));
    
          const addSNAP      = Math.round(Math.max(0,  sampleVec('snap_yearly', a)));
          const addFRL       = Math.round(Math.max(0,  sampleVec('frl_yearly',  a)));
          const addWIC = Math.round(Math.max(0, sampleVec('wic_yearly', a)));
    
          const subHealth    = Math.round(Math.max(0, -sampleVec('healthcare_yearly', a)));
          const subChildcare = Math.round(Math.max(0, -sampleVec('childcare_yearly',  a)));
          const subUtilities = Math.round(Math.max(0, -sampleVec('pipp_yearly',       a)));
          const subIDR       = Math.round(Math.max(0, -(budget.idrPlan === 'ICR'
                                    ? sampleVec('idr_icr_yearly', a)
                                    : sampleVec('idr_ibr_yearly', a))));
          const subEdChoice  = Math.round(Math.max(0, -sampleEdChoiceYearly(a)));
          
          const addSSI = Math.round(Math.max(0,
              Array.isArray(S.ssi_ssdi_yearly)
                ? sampleVec('ssi_ssdi_yearly', a)
                : (sampleVec('ssdi_yearly', a) + sampleVec('ssi_yearly', a))
            ));

    
        const available = net + addSNAP + addFRL + addSSI + addWIC
                  - subChildcare - subEdChoice - subIDR - subHealth - subUtilities;

    
          rows.push({ annual:a, net, addSNAP, addFRL, addSSI, addWIC, subChildcare, subEdChoice,
                      subICR:subIDR, subHealth, subUtilities, available });
        }
    
        let html = `<table class="tight">
          <thead>
            <tr>
              <th>Annual</th><th class="right">Net</th>
              <th class="right">+SNAP</th><th class="right">+FRL</th><th class="right">+SSI/SSDI</th>+WIC</th>
              <th class="right">−Childcare</th><th class="right">−EdChoice</th><th class="right">−IDR</th>
              <th class="right">−Health</th><th class="right">−Utilities</th>
              <th class="right">= Available</th>
            </tr>
          </thead><tbody>`;
        for (const r of rows){
          html += `<tr>
            <td>$${r.annual.toLocaleString()}</td>
            <td class="right">$${r.net.toLocaleString()}</td>
            <td class="right">$${r.addSNAP.toLocaleString()}</td>
            <td class="right">$${r.addFRL.toLocaleString()}</td>
            <td class="right">$${r.addSSI.toLocaleString()}</td>
            <td class="right">$${r.addWIC.toLocaleString()}</td>
            <td class="right">$${r.subChildcare.toLocaleString()}</td>
            <td class="right">$${r.subEdChoice.toLocaleString()}</td>
            <td class="right">$${r.subICR.toLocaleString()}</td>
            <td class="right">$${r.subHealth.toLocaleString()}</td>
            <td class="right">$${r.subUtilities.toLocaleString()}</td>
            <td class="right"><strong>$${r.available.toLocaleString()}</strong></td>
          </tr>`;
        }
        html += `</tbody></table>`;
        document.getElementById('availTable').innerHTML = html;
      })();
    }





    // ========== Net Income After Taxes & Standard Deductions (Annual) ==========
    function startNetAfterTaxStep(userInfo, budget) {
      const app = document.getElementById('app');
      const A_MAX = 150000;
      const TABLE_STEP = 10000;
      const GRAPH_STEP = 100;
    
      const guessStatus = userInfo.filingStatus || 'hoh'; // default Head of Household feels right for many users here
      const guessCity = Number.isFinite(userInfo.cityTaxRate) ? userInfo.cityTaxRate : 0.02;
      const guessRetire = Number.isFinite(userInfo.retirePct) ? userInfo.retirePct : 0.05;
    
      app.innerHTML = `
        <h2>Net Income after Taxes & Standard Paycheck Deductions</h2>
        <p>This shows your estimated <strong>annual net pay</strong> after typical withholdings:</p>
        <ul class="small">
          <li>Federal income tax (using standard deduction & filing status)</li>
          <li>Social Security (6.2%) and Medicare (1.45%)</li>
          <li>Ohio state tax (simplified brackets)</li>
          <li>Local/city tax (you can adjust the rate)</li>
          <li>“Typical” mandatory retirement if salary ≥ $30,000 (default 5%, editable)</li>
        </ul>
    
        <div class="grid" style="gap:8px; margin:8px 0 12px;">
          <label>Filing status:
            <select id="taxFiling">
              <option value="single" ${guessStatus==='single'?'selected':''}>Single</option>
              <option value="hoh" ${guessStatus==='hoh'?'selected':''}>Head of Household</option>
              <option value="married" ${guessStatus==='married'?'selected':''}>Married Filing Jointly</option>
            </select>
          </label>
          <label>City tax rate (%):
            <input type="number" id="taxCityRate" min="0" max="3.5" step="0.1" value="${(guessCity*100).toFixed(1)}">
          </label>
          <label>Retirement withholding (% if ≥ $30k):
            <input type="number" id="taxRetirePct" min="0" max="15" step="0.5" value="${(guessRetire*100).toFixed(1)}">
          </label>
        </div>
    
        <label>Try an <strong>annual salary</strong>:
          $<input type="number" id="taxAnnual" min="0" step="1000" placeholder="e.g., 52000">
        </label>
    
        <div class="row"></div>
        <div id="taxKpis">
          <div><strong>Net annual pay:</strong> <span id="taxNet">$0</span></div>
          <div class="small" id="taxBreakdown">—</div>
        </div>
    
        <div class="row"></div>
        <svg id="taxSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="Net income curve"></svg>
    
        <div class="row"></div>
        <div id="taxTableWrap"></div>
    
        <div class="row"></div>
        <div class="note small">
          This is a best-effort estimate for planning. Actual withholdings vary by employer payroll setup and W-4 specifics.
        </div>
    
        <div class="row"></div>
        <button id="taxNext" class="primary">Continue to Final Peril Zone</button>
      `;
      pushStep(() => startNetAfterTaxStep(userInfo, budget));
    
      // Save user choices back to userInfo for later steps
      const filingEl = document.getElementById('taxFiling');
      const cityEl = document.getElementById('taxCityRate');
      const retireEl = document.getElementById('taxRetirePct');
      const annualEl = document.getElementById('taxAnnual');
      const netEl = document.getElementById('taxNet');
      const bdEl = document.getElementById('taxBreakdown');
      const svg = document.getElementById('taxSvg');
      const wrap = document.getElementById('taxTableWrap');
    
      function fmt(n){ return '$' + Math.max(0, Math.round(n)).toLocaleString(); }
      function pctStr(x){ return (x*100).toFixed(1) + '%'; }
    
      // Build curve (0..A_MAX) and table (every 10k)
      function currentOpts(){
        const filingStatus = filingEl.value || 'hoh';
        const cityRate = Math.max(0, Math.min(0.035, (Number(cityEl.value)||0)/100));
        const retirePct = Math.max(0, Math.min(0.15, (Number(retireEl.value)||0)/100));
        return { filingStatus, cityRate, retirePct };
      }
    
      let yMax = 100;
      const steps = 30;
      const curve = [];
    
    function rebuildCurveAndTable() {
      curve.length = 0;
      yMax = 100;
    
      const opts = currentOpts();
    
      // ---- Build fine-grained curve (0..A_MAX by $100) ----
      for (let a = 0; a <= A_MAX; a += GRAPH_STEP) {
        const r = calcAnnualNet(a, opts);
        curve.push({ x: a, y: Math.round(r.netAnnual) });
        if (r.netAnnual > yMax) yMax = r.netAnnual;
      }
      if (yMax < 100) yMax = 100;
    
      // ---- Build table rows (0..A_MAX by $10k) ----
      const rows = [];
      const series = [];
      for (let a = 0; a <= A_MAX; a += TABLE_STEP) {
        const r = calcAnnualNet(a, opts);
        rows.push({
          annual: a, net: r.netAnnual,
          fed: r.components.fed, ss: r.components.ssTax, med: r.components.medicareTax,
          state: r.components.state, local: r.components.local, retire: r.components.retirement
        });
        series.push({
          annual: a,
          netAnnual: r.netAnnual,
          ...r.components
        });
      }
    
      // ---- Save legacy $10k points for the UI/table (unchanged) ----
      budget._series = budget._series || {};
      budget._series.netIncome = {
        points: series,
        assumptions: { ...opts }
      };
    
      // ---- Save canonical YEARLY vector on a $100 grid (positive = income) ----
      const salaries = Array.from({ length: (A_MAX / GRAPH_STEP) + 1 }, (_, i) => i * GRAPH_STEP);
      const net_yearly = salaries.map(a => Math.round(calcAnnualNet(a, opts).netAnnual));
    
      if (!Array.isArray(budget._salaries) || budget._salaries.length === 0) {
        budget._salaries = salaries;
      }
      budget._series.net_yearly = net_yearly;
      budget._series.net_after_tax_yearly = Array.isArray(net_yearly) ? net_yearly.slice() : [];
    
      // (Optional) metadata
      budget._series_meta = budget._series_meta || {};
      budget._series_meta.net = {
        graph_step: GRAPH_STEP,
        table_step: TABLE_STEP,
        filing_status: opts.filingStatus,
        city_rate: opts.cityRate,
        retire_pct: opts.retirePct
      };
    
      renderTable(rows);
      draw();
    }

    
      // SVG draw
      const W = 720, H = 260, P = 40;
      const innerW = W - P*2, innerH = H - P*2;
      const xPix = x => P + (x / A_MAX) * innerW;
      const yPix = y => H - P - (y / yMax) * innerH;
    
      function draw(){
        svg.innerHTML = '';
    
        const axisX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisX.setAttribute('x1', P); axisX.setAttribute('y1', H-P);
        axisX.setAttribute('x2', W-P); axisX.setAttribute('y2', H-P);
        axisX.setAttribute('stroke','currentColor');
    
        const axisY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisY.setAttribute('x1', P); axisY.setAttribute('y1', P);
        axisY.setAttribute('x2', P); axisY.setAttribute('y2', H-P);
        axisY.setAttribute('stroke','currentColor');
    
        let d = '';
        for (let i=0;i<curve.length;i++){
          const X = xPix(curve[i].x), Y = yPix(curve[i].y);
          d += (i===0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','currentColor');
        path.setAttribute('stroke-width','2');


        // X ticks every $20k
        for (let x = 0; x <= A_MAX; x += 20000) {
          const X = xPix(x);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', X); t.setAttribute('y1', H-P);
          t.setAttribute('x2', X); t.setAttribute('y2', H-P+5);
          t.setAttribute('stroke', 'currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', X - 14); label.setAttribute('y', H - P + 18);
          label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
          label.textContent = `$${(x/1000).toFixed(0)}k`;
          svg.append(t, label);
        }
        
        // Y ticks every $10k (or $20k if tall)
        const yStep = (yMax <= 50_000 ? 10_000 : 20_000);
        for (let y = 0; y <= yMax; y += yStep) {
          const Y = yPix(y);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', P-5); t.setAttribute('y1', Y);
          t.setAttribute('x2', P);   t.setAttribute('y2', Y);
          t.setAttribute('stroke', 'currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', 6); label.setAttribute('y', Y - 2);
          label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
          label.textContent = `$${y.toLocaleString()}`;
          svg.append(t, label);
        }
            
        const marker = document.createElementNS('http://www.w3.org/2000/svg','circle');
        marker.setAttribute('id','taxMarker');
        marker.setAttribute('r','4'); marker.setAttribute('fill','currentColor');
    
        // endpoint labels
        const yLab = document.createElementNS('http://www.w3.org/2000/svg','text');
        yLab.setAttribute('x', P+4); yLab.setAttribute('y', yPix(yMax)-6);
        yLab.setAttribute('font-size','10'); yLab.setAttribute('fill','currentColor');
        yLab.textContent = '$' + Math.round(yMax).toLocaleString();
    
        const xLab = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLab.setAttribute('x', xPix(A_MAX)-44); xLab.setAttribute('y', H-P+14);
        xLab.setAttribute('font-size','10'); xLab.setAttribute('fill','currentColor');
        xLab.textContent = '$' + A_MAX.toLocaleString();
    
        // Axis titles
        const xTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        xTitle.setAttribute('x', W/2); xTitle.setAttribute('y', H-6);
        xTitle.setAttribute('text-anchor','middle');
        xTitle.setAttribute('font-size','12'); xTitle.setAttribute('fill','currentColor');
        xTitle.textContent = 'Annual salary (gross)';
    
        const yTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        yTitle.setAttribute('x', 16); yTitle.setAttribute('y', H/2);
        yTitle.setAttribute('text-anchor','middle');
        yTitle.setAttribute('font-size','12'); yTitle.setAttribute('fill','currentColor');
        yTitle.setAttribute('transform', `rotate(-90 16 ${H/2})`);
        yTitle.textContent = 'Net annual pay (after withholdings)';
    
        svg.append(axisX, axisY, path, marker, yLab, xLab, xTitle, yTitle);
        moveMarker(Number(annualEl.value)||0);
      }
    
      function moveMarker(annual){
        const marker = document.getElementById('taxMarker');
        const a = Math.max(0, Math.min(A_MAX, annual));
        const r = calcAnnualNet(a, currentOpts());
        marker.setAttribute('cx', xPix(a));
        marker.setAttribute('cy', yPix(r.netAnnual));
    
        netEl.textContent = fmt(r.netAnnual);
        bdEl.innerHTML = `
          <span>Fed: ${fmt(r.components.fed)}</span> &nbsp;|&nbsp;
          <span>SS: ${fmt(r.components.ssTax)}</span> &nbsp;|&nbsp;
          <span>Medicare: ${fmt(r.components.medicareTax)}</span> &nbsp;|&nbsp;
          <span>State: ${fmt(r.components.state)}</span> &nbsp;|&nbsp;
          <span>City: ${fmt(r.components.local)}</span> &nbsp;|&nbsp;
          <span>Retire: ${fmt(r.components.retirement)}</span>
        `;
      }
    
      function renderTable(rows){
        let html = `<table style="width:100%; border-collapse:collapse;">
          <thead><tr>
            <th style="text-align:left; padding:6px;">Annual salary</th>
            <th style="text-align:left; padding:6px;">Federal</th>
            <th style="text-align:left; padding:6px;">Social Sec</th>
            <th style="text-align:left; padding:6px;">Medicare</th>
            <th style="text-align:left; padding:6px;">State</th>
            <th style="text-align:left; padding:6px;">City</th>
            <th style="text-align:left; padding:6px;">Retirement</th>
            <th style="text-align:left; padding:6px;">Net annual</th>
          </tr></thead><tbody>`;
        for (const r of rows){
          html += `<tr>
            <td style="padding:6px;">$${r.annual.toLocaleString()}</td>
            <td style="padding:6px;">$${Math.round(r.fed).toLocaleString()}</td>
            <td style="padding:6px;">$${Math.round(r.ss).toLocaleString()}</td>
            <td style="padding:6px;">$${Math.round(r.med).toLocaleString()}</td>
            <td style="padding:6px;">$${Math.round(r.state).toLocaleString()}</td>
            <td style="padding:6px;">$${Math.round(r.local).toLocaleString()}</td>
            <td style="padding:6px;">$${Math.round(r.retire).toLocaleString()}</td>
            <td style="padding:6px;"><strong>$${Math.round(r.net).toLocaleString()}</strong></td>
          </tr>`;
        }
        html += `</tbody></table>`;
        wrap.innerHTML = html;
      }
    
      // initial build
      rebuildCurveAndTable();
      moveMarker(0);
    
      // live reactions
      [filingEl, cityEl, retireEl].forEach(el => {
        el.addEventListener('input', () => {
          // persist to userInfo so later steps inherit
          userInfo.filingStatus = filingEl.value;
          userInfo.cityTaxRate = Math.max(0, Math.min(0.035, (Number(cityEl.value)||0)/100));
          userInfo.retirePct = Math.max(0, Math.min(0.15, (Number(retireEl.value)||0)/100));
          rebuildCurveAndTable();
          moveMarker(Number(annualEl.value)||0);
        });
      });
      annualEl.addEventListener('input', () => moveMarker(Number(annualEl.value)||0));
    
      document.getElementById('taxNext').addEventListener('click', () => {
        // proceed to your existing final roll-up
        startPerilZoneStep(userInfo, budget);
      }, { once:true });
    }





    // ========== Peril Zone Calculation (Annual) ==========
    // y-axis: Net Income Available for Bare Bones Budget Costs (annual)
    // Overlays: Bare-Bones Budget Amount (annual) & Frugal-Fun Budget Amount (annual)
    function startPerilZoneStep(userInfo, budget) {
        
        function fmtPos(n){  return '$' + Math.max(0, Math.round(n)).toLocaleString(); }
        function fmtAny(n){  const v = Math.round(n); return (v<0?'-':'') + '$' + Math.abs(v).toLocaleString(); }
        function fmtSigned(n){ const v = Math.round(n); return (v>0?'+':v<0?'-':'') + '$' + Math.abs(v).toLocaleString(); }

      const app = document.getElementById('app');
      const A_MAX = 150000;
      const TABLE_STEP = 10000;
    
      // 1) Pull NET series from earlier step
      const netPts = budget._series?.netIncome?.points || [];
      if (!netPts.length) {
        alert("I need your Net Income series first. Running taxes step…");
        return startNetAfterTaxStep(userInfo, budget);
      }
    
      // 2) Get annual thresholds
      //    Bare bones = what the user computed earlier.
      //    Frugal-fun = your computed add-on; fallback if not set.
        const bareBonesMonthly = Number(budget.totalMonthlyExpenses) || 0;
        
        // prefer an absolute frugal total if you have one, else bare + add-on
        const frugalAbsolute = Number(budget.totalMonthlyFrugal);
        const frugalAddon    = Number(budget.frugalFunMonthlyAddon ?? budget.frugalFunMonthly ?? 0);
        
        const frugalFunMonthly = Number.isFinite(frugalAbsolute) && frugalAbsolute > 0
          ? frugalAbsolute
          : bareBonesMonthly + Math.max(0, frugalAddon);
        
        const BARE_ANNUAL = Math.round(bareBonesMonthly * 12);
        const FUN_ANNUAL  = Math.round(frugalFunMonthly * 12);

    
    // ---- canonical samplers that use the $100 grid you saved ----
    const S = budget._series || {};
    const GRID =
      Array.isArray(budget._salaries) && budget._salaries.length
        ? budget._salaries
        : (Array.isArray(S.gross_yearly) ? S.gross_yearly
           : []); // falls back to gross_yearly if you didn't persist _salaries
    
    function clampNum(n){ return Number.isFinite(n) ? n : 0; }
    
    function sampleVec(key, annual) {
      const vec = S[key];
      if (!Array.isArray(vec) || vec.length !== GRID.length) return 0;
      if (!GRID.length) return 0;
    
      if (annual <= GRID[0]) return clampNum(vec[0]);
      if (annual >= GRID[GRID.length-1]) return clampNum(vec[vec.length-1]);
    
      // binary search
      let lo = 0, hi = GRID.length - 1;
      while (hi - lo > 1){
        const mid = (lo + hi) >> 1;
        if (GRID[mid] <= annual) lo = mid; else hi = mid;
      }
      const x0 = GRID[lo], x1 = GRID[hi];
      const y0 = clampNum(vec[lo]), y1 = clampNum(vec[hi]);
      const t = (annual - x0) / Math.max(1, x1 - x0);
      return y0 + t * (y1 - y0);
    }
    
    function sampleNetAnnual(annual){
      // prefer yearly vectors you save on the $100 grid
      if (Array.isArray(S.net_after_tax_yearly) && S.net_after_tax_yearly.length === GRID.length)
        return sampleVec('net_after_tax_yearly', annual);
      if (Array.isArray(S.net_yearly) && S.net_yearly.length === GRID.length)
        return sampleVec('net_yearly', annual);
    
      // fallback: old coarse .points table if present
      const pts = (S.netIncome && Array.isArray(S.netIncome.points))
        ? S.netIncome.points.slice().sort((a,b)=>a.annual-b.annual)
        : [];
      if (!pts.length) return 0;
      if (annual <= pts[0].annual) return clampNum(pts[0].netAnnual);
      if (annual >= pts[pts.length-1].annual) return clampNum(pts[pts.length-1].netAnnual);
      for (let i=1;i<pts.length;i++){
        const p0=pts[i-1], p1=pts[i];
        if (annual >= p0.annual && annual <= p1.annual){
          const t = (annual - p0.annual) / Math.max(1, p1.annual - p0.annual);
          return clampNum(p0.netAnnual + t*(p1.netAnnual - p0.netAnnual));
        }
      }
      return 0;
    }
    
    // education choice: vector if present; otherwise interpolate curve and treat as negative (cost)
    function sampleEdChoiceYearly(annual){
      if (Array.isArray(S.edchoice_yearly) && S.edchoice_yearly.length === GRID.length)
        return sampleVec('edchoice_yearly', annual); // already negative in your vector
    
      const curve = S.edchoice && Array.isArray(S.edchoice.curve)
        ? S.edchoice.curve.slice().sort((a,b)=>a.x-b.x)
        : null;
      if (!curve || curve.length < 2) return 0;
    
      if (annual <= curve[0].x) return -clampNum(curve[0].y);
      if (annual >= curve[curve.length-1].x) return -clampNum(curve[curve.length-1].y);
    
      let lo=0, hi=curve.length-1;
      while (hi - lo > 1){
        const mid=(lo+hi)>>1;
        if (curve[mid].x <= annual) lo=mid; else hi=mid;
      }
      const p0=curve[lo], p1=curve[hi];
      const t = (annual - p0.x) / Math.max(1, p1.x - p0.x);
      return -(clampNum(p0.y) + t*(clampNum(p1.y) - clampNum(p0.y)));
    }
    
    function availableAt(annual){
      const net = sampleNetAnnual(annual);
    
      const snap   =  sampleVec('snap_yearly',       annual); // +
      const frl    =  sampleVec('frl_yearly',        annual); // +
    
      const health =  sampleVec('healthcare_yearly', annual); // −
      const cc     =  sampleVec('childcare_yearly',  annual); // −
      const pipp   =  sampleVec('pipp_yearly',       annual); // −
    
      const idr = (budget.idrPlan === 'ICR' && Array.isArray(S.idr_icr_yearly))
        ? sampleVec('idr_icr_yearly', annual)
        : (Array.isArray(S.idr_ibr_yearly) ? sampleVec('idr_ibr_yearly', annual) : 0); // −
    
      const ed = sampleEdChoiceYearly(annual); // −
    
        const ssi_ssdi = Array.isArray(S.ssi_ssdi_yearly)
          ? sampleVec('ssi_ssdi_yearly', annual)
          : (sampleVec('ssdi_yearly', annual) + sampleVec('ssi_yearly', annual));
        
        const wic = sampleVec('wic_yearly', annual); // positive benefit
        return net + snap + frl + ssi_ssdi + wic + health + cc + pipp + idr + ed;
    }

    // compute final remaining available at a given annual salary
      app.innerHTML = `
        <h2>Peril Zone — Net Income Available vs Survival Thresholds</h2>

        <p>The curve shows your <strong>net income available (annual)</strong> at each salary —
           that is, net after tax <em>plus</em> benefits (e.g., SNAP/SSI/SSDI) <em>minus</em> modeled costs
           (healthcare, childcare, IDR, utilities, EdChoice). The horizontal lines show your
           <strong>Bare-Bones</strong> and <strong>Frugal-but-Fun</strong> annual budgets.</p>

        <div class="note small" style="margin:8px 0 12px;">
          Y-axis: <em>Net Income Available for Bare Bones Budget Costs (annual)</em>
        </div>
    
        <label>Try an <strong>annual salary</strong>:
          $<input type="number" id="pzIncome" min="0" step="1000" placeholder="e.g., 52000">
        </label>
    
        <div class="row"></div>
        <div id="pzKpis">
          <div><strong>Net income available (annual):</strong> <span id="pzNet">$0</span></div>
          <div class="small" id="pzBreak">—</div>
        </div>

    
        <div class="row"></div>
        <svg id="pzSvg" viewBox="0 0 720 300" width="100%" height="300" aria-label="Peril Zone"></svg>
    
        <div class="row"></div>
        <div id="pzTableWrap"></div>
    
        <div class="row"></div>
        <button id="pzNext" class="primary">Continue</button>
      `;
      pushStep(() => startPerilZoneStep(userInfo, budget));
    
      const svg  = document.getElementById('pzSvg');
      const inp  = document.getElementById('pzIncome');
      const netEl= document.getElementById('pzNet');
      const brEl = document.getElementById('pzBreak');
      const wrap = document.getElementById('pzTableWrap');

      function sampleNet(annual){
        // linear interpolate from saved netIncome series
        const pts = netPts.slice().sort((a,b)=>a.annual-b.annual);
        if (annual <= pts[0].annual) return pts[0].netAnnual;
        if (annual >= pts[pts.length-1].annual) return pts[pts.length-1].netAnnual;
        for (let i=1;i<pts.length;i++){
          const x0=pts[i-1].annual, y0=pts[i-1].netAnnual;
          const x1=pts[i].annual,   y1=pts[i].netAnnual;
          if (annual >= x0 && annual <= x1){
            const t = (annual - x0) / (x1 - x0 || 1);
            return y0 + t*(y1 - y0); 
          }
        }
        return 0;
      }
    
    // Build curve (0..A_MAX) from final remaining amounts
    const steps = 30;
    const curve = [];
    let yMax = Math.max(BARE_ANNUAL, FUN_ANNUAL, 100);
    
    for (let i=0;i<=steps;i++){
      const annual = (A_MAX * i) / steps;
      const y = availableAt(annual);
      curve.push({ x: annual, y });
      if (y > yMax) yMax = y;
    }

    
      // Table (every $10k): Gross | Net | Surplus/Deficit vs lines
      const rows = [];
      for (let a = 0; a <= A_MAX; a += TABLE_STEP) {
        const row = netPts.find(p => p.annual === a) || { annual:a, netAnnual: sampleNet(a) };
        const net = row.netAnnual || 0;
        rows.push({
          annual: a,
          net,
          vsBare: net - BARE_ANNUAL,
          vsFun:  net - FUN_ANNUAL
        });
      }
    
      // --- draw SVG ---
      const W = 720, H = 300, P = 40;
      const innerW = W - P*2, innerH = H - P*2;
      const xPix = x => P + (x / A_MAX) * innerW;
      const yPix = y => H - P - (y / yMax) * innerH;
    
    
    // Formatter used by lineLabel() in this scope
    function fmt(n){ return '$' + Math.max(0, Math.round(n)).toLocaleString(); }

      function draw(){
        svg.innerHTML = '';
    
        // axes
        const axisX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisX.setAttribute('x1', P); axisX.setAttribute('y1', H-P);
        axisX.setAttribute('x2', W-P); axisX.setAttribute('y2', H-P);
        axisX.setAttribute('stroke','currentColor');
    
        const axisY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisY.setAttribute('x1', P); axisY.setAttribute('y1', P);
        axisY.setAttribute('x2', P); axisY.setAttribute('y2', H-P);
        axisY.setAttribute('stroke','currentColor');
    
        // curve
        let d = '';
        for (let i=0;i<curve.length;i++){
          const X = xPix(curve[i].x), Y = yPix(curve[i].y);
          d += (i===0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','currentColor');
        path.setAttribute('stroke-width','2');
        
        // X ticks every $20k
        for (let x = 0; x <= A_MAX; x += 20000) {
          const X = xPix(x);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', X); t.setAttribute('y1', H-P);
          t.setAttribute('x2', X); t.setAttribute('y2', H-P+5);
          t.setAttribute('stroke', 'currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', X - 14); label.setAttribute('y', H - P + 18);
          label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
          label.textContent = `$${(x/1000).toFixed(0)}k`;
          svg.append(t, label);
        }
        
        // Y ticks every $10k (or $20k if tall)
        const yStep = (yMax <= 50_000 ? 10_000 : 20_000);
        for (let y = 0; y <= yMax; y += yStep) {
          const Y = yPix(y);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', P-5); t.setAttribute('y1', Y);
          t.setAttribute('x2', P);   t.setAttribute('y2', Y);
          t.setAttribute('stroke', 'currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', 6); label.setAttribute('y', Y - 2);
          label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
          label.textContent = `$${y.toLocaleString()}`;
          svg.append(t, label);
        }

    
        // marker
        const marker = document.createElementNS('http://www.w3.org/2000/svg','circle');
        marker.setAttribute('id','pzMarker');
        marker.setAttribute('r','4'); marker.setAttribute('fill','currentColor');
    
        // horizontal lines: bare bones & frugal-fun
        function hLine(val){
          const line = document.createElementNS('http://www.w3.org/2000/svg','line');
          line.setAttribute('x1', P); line.setAttribute('x2', W-P);
          line.setAttribute('y1', yPix(val)); line.setAttribute('y2', yPix(val));
          line.setAttribute('stroke','currentColor');
          line.setAttribute('stroke-dasharray','6 6');
          line.setAttribute('opacity','0.7');
          return line;
        }
        const lineBare = hLine(BARE_ANNUAL);
        const lineFun  = hLine(FUN_ANNUAL);
    
        // labels for lines
        function lineLabel(val, text, dy){
          const t = document.createElementNS('http://www.w3.org/2000/svg','text');
          t.setAttribute('x', W - P - 6);
          t.setAttribute('y', yPix(val) + (dy||-6));
          t.setAttribute('text-anchor','end');
          t.setAttribute('font-size','11');
          t.setAttribute('fill','currentColor');
          t.textContent = `${text}: ${fmt(val)}`;
          return t;
        }
        const labBare = lineLabel(BARE_ANNUAL, 'Bare-Bones Budget', 12);
        const labFun  = lineLabel(FUN_ANNUAL,  'Frugal-Fun Budget', -6);
    
        // end labels
        const yLab = document.createElementNS('http://www.w3.org/2000/svg','text');
        yLab.setAttribute('x', P+4); yLab.setAttribute('y', yPix(yMax)-6);
        yLab.setAttribute('font-size','10'); yLab.setAttribute('fill','currentColor');
        yLab.textContent = '$' + Math.round(yMax).toLocaleString();
    
        const xLab = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLab.setAttribute('x', xPix(A_MAX)-44); xLab.setAttribute('y', H-P+14);
        xLab.setAttribute('font-size','10'); xLab.setAttribute('fill','currentColor');
        xLab.textContent = '$' + A_MAX.toLocaleString();
    
        // axis titles
        const xTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        xTitle.setAttribute('x', W/2); xTitle.setAttribute('y', H-6);
        xTitle.setAttribute('text-anchor','middle');
        xTitle.setAttribute('font-size','12'); xTitle.setAttribute('fill','currentColor');
        xTitle.textContent = 'Annual salary (gross)';
    
        const yTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        yTitle.setAttribute('x', 16); yTitle.setAttribute('y', H/2);
        yTitle.setAttribute('text-anchor','middle');
        yTitle.setAttribute('font-size','12'); yTitle.setAttribute('fill','currentColor');
        yTitle.setAttribute('transform', `rotate(-90 16 ${H/2})`);
        yTitle.textContent = 'Remaining income available to pay your budget (annual)';
    
        svg.append(axisX, axisY, path, lineBare, lineFun, labBare, labFun, marker, yLab, xLab, xTitle, yTitle);
      }
    
    function moveMarker(a){
      const marker = document.getElementById('pzMarker');
      const annual = Math.max(0, Math.min(A_MAX, a));
      const avail = availableAt(annual);
    
      marker.setAttribute('cx', xPix(annual));
      marker.setAttribute('cy', yPix(avail));
      netEl.textContent = fmtAny(avail);            // allow negatives here

        const diffBare = avail - BARE_ANNUAL;
        const diffFun  = avail - FUN_ANNUAL;
        brEl.textContent =
          `vs Bare-Bones: ${fmtSigned(diffBare)} | vs Frugal-Fun: ${fmtSigned(diffFun)}`;

    }

    
    function renderTable(){
      const rows = [];
      for (let a = 0; a <= A_MAX; a += TABLE_STEP) {
        const net = Math.round(sampleNetAnnual(a)); // uses your sampler above
    
        // Benefits (positive)
        const addSNAP = Math.round(Math.max(0,  sampleVec('snap_yearly', a)));
        const addFRL  = Math.round(Math.max(0,  sampleVec('frl_yearly',  a)));
        const addWIC = Math.round(Math.max(0, sampleVec('wic_yearly', a)));
        const addSSI = Math.round(Math.max(0,
          Array.isArray(S.ssi_ssdi_yearly)
            ? sampleVec('ssi_ssdi_yearly', a)
            : (sampleVec('ssdi_yearly', a) + sampleVec('ssi_yearly', a))
        ));

    
        // Costs (show as positive numbers)
        const subChildcare = Math.round(Math.max(0, -sampleVec('childcare_yearly',  a)));
        const subEdChoice  = Math.round(Math.max(0, -sampleEdChoiceYearly(a)));
        const subICR       = Math.round(Math.max(0, -(budget.idrPlan === 'ICR'
                                ? sampleVec('idr_icr_yearly', a)
                                : sampleVec('idr_ibr_yearly', a))));
        const subHealth    = Math.round(Math.max(0, -sampleVec('healthcare_yearly', a)));
        const subUtilities = Math.round(Math.max(0, -sampleVec('pipp_yearly',       a)));
    
        const available = net + addSNAP + addFRL + addSSI + addWIC
                          - subChildcare - subEdChoice - subICR - subHealth - subUtilities;
    
        rows.push({ annual:a, net, addSNAP, addFRL, addSSI, addWIC,
                    subChildcare, subEdChoice, subICR, subHealth, subUtilities, available });
      }
    
      let html = `<table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:6px;">Annual Salary</th>
            <th style="text-align:left; padding:6px;">Post-Tax and Deduction Annual Salary</th>
            <th style="text-align:left; padding:6px;">Add: SNAP</th>
            <th style="text-align:left; padding:6px;">Add: FRL</th>
            <th style="text-align:left; padding:6px;">Add: SSI/SSDI</th>
            <th style="text-align:left; padding:6px;">Add: WIC</th>
            <th style="text-align:left; padding:6px;">Subtract: Childcare</th>
            <th style="text-align:left; padding:6px;">Subtract: EdChoice</th>
            <th style="text-align:left; padding:6px;">Subtract: IDR</th>
            <th style="text-align:left; padding:6px;">Subtract: Healthcare</th>
            <th style="text-align:left; padding:6px;">Subtract: Utilities</th>
            <th style="text-align:left; padding:6px;">Remaining Income Available to Pay Budget</th>
          </tr>
        </thead>

        <tbody>`;
      for (const r of rows){
        html += `<tr>
          <td style="padding:6px;">$${r.annual.toLocaleString()}</td>
          <td style="padding:6px;">$${r.net.toLocaleString()}</td>
          <td style="padding:6px;">$${r.addSNAP.toLocaleString()}</td>
          <td style="padding:6px;">$${r.addFRL.toLocaleString()}</td>
          <td style="padding:6px;">$${r.addSSI.toLocaleString()}</td>
          <td style="padding:6px;">$${r.addWIC.toLocaleString()}</td>
          <td style="padding:6px;">$${r.subChildcare.toLocaleString()}</td>
          <td style="padding:6px;">$${r.subEdChoice.toLocaleString()}</td>
          <td style="padding:6px;">$${r.subICR.toLocaleString()}</td>
          <td style="padding:6px;">$${r.subHealth.toLocaleString()}</td>
          <td style="padding:6px;">$${r.subUtilities.toLocaleString()}</td>
          <td style="padding:6px;"><strong>$${r.available.toLocaleString()}</strong></td>
        </tr>`;
      }
      html += `</tbody></table>`;
      wrap.innerHTML = html;
    }

    
      // draw & table
      draw();
      renderTable();
      moveMarker(0);
    
      // interactions
      inp.addEventListener('input', () => moveMarker(Number(inp.value)||0));
    
      document.getElementById('pzNext').addEventListener('click', () => {
        // If you still want to show the “All modeled components (HC/CC/Ed/SNAP)” roll-up after this,
        // call it here. Otherwise you can finish here.
        // startFinalNetImpactStep(userInfo, budget);
        alert('Peril Zone view complete.');
      }, { once:true });
    }


    // ========== Final Roll-up: Net Monthly Out-of-Pocket vs Annual Salary ==========
    function startFinalNetImpactStep(userInfo, budget){
      const app = document.getElementById("app");
      const A_MAX = 150000;
      const TABLE_STEP = 10000;
    
      app.innerHTML = `
        <h2>Net Monthly Impact — All Modeled Categories</h2>
        <p>This combines Healthcare, Childcare, EdChoice, Utilities (PIPP), Student loans (IDR), and benefits (SNAP/FRL/SSI/SSDI/WIC) into one curve.</p>
    
        <div class="note small" style="margin-bottom:8px;">
          Toggle components:
          <label style="margin-left:10px;"><input type="checkbox" id="inc-health" checked> Healthcare</label>
          <label style="margin-left:10px;"><input type="checkbox" id="inc-cc" checked> Childcare</label>
          <label style="margin-left:10px;"><input type="checkbox" id="inc-ed" checked> EdChoice</label>
          <label style="margin-left:10px;"><input type="checkbox" id="inc-utils" checked> Utilities (PIPP)</label>
          <label style="margin-left:10px;"><input type="checkbox" id="inc-idr" checked> Student loans (IDR)</label>
          <label style="margin-left:10px;"><input type="checkbox" id="inc-snap" checked> SNAP (subtracts)</label>
          <label style="margin-left:10px;"><input type="checkbox" id="inc-frl" checked> FRL (subtracts)</label>
          <label style="margin-left:10px;"><input type="checkbox" id="inc-ssi" checked> SSI/SSDI (subtracts)</label>
          <label style="margin-left:10px;"><input type="checkbox" id="inc-wic" checked> WIC (subtracts)</label>
          <label style="margin-left:10px; opacity:.5;"><input type="checkbox" id="inc-tax" disabled> Taxes (coming soon)</label>
        </div>

    
        <label>Try an <strong>annual salary</strong>:
          $<input type="number" id="finalIncome" min="0" step="1000" placeholder="e.g., 52000">
        </label>
    
        <div class="row"></div>
        <div id="finalKpis">
          <div><strong>Net monthly (selected components):</strong> <span id="finalNet">$0</span></div>
          <div class="small" id="finalNote">—</div>
        </div>
    
        <div class="row"></div>
        <svg id="finalSvg" viewBox="0 0 720 260" width="100%" height="260" aria-label="Net monthly impact curve"></svg>
    
        <div class="row"></div>
        <div id="finalTableWrap"></div>
    
        <div class="row"></div>
        <button id="finalDone" class="primary">Done</button>
      `;
      pushStep(() => startFinalNetImpactStep(userInfo, budget));
    
      const svg = document.getElementById('finalSvg');
      const incomeEl = document.getElementById('finalIncome');
      const netEl = document.getElementById('finalNet');
      const noteEl = document.getElementById('finalNote');
      const wrap = document.getElementById('finalTableWrap');
    
        const chk = {
          hc:   document.getElementById('inc-health'),
          cc:   document.getElementById('inc-cc'),
          ed:   document.getElementById('inc-ed'),
          utils:document.getElementById('inc-utils'),
          idr:  document.getElementById('inc-idr'),
          snap: document.getElementById('inc-snap'),
          frl:  document.getElementById('inc-frl'),
          ssi:  document.getElementById('inc-ssi'),
          wic:  document.getElementById('inc-wic'),
          tax:  document.getElementById('inc-tax') // disabled for now
        };

      // >>> ADD THIS BLOCK (canonical $100-grid sampler) <<<
      const S = budget._series || {};
      const GRID = (Array.isArray(budget._salaries) && budget._salaries.length) ? budget._salaries : [];
      function clamp(n){ return Number.isFinite(n) ? n : 0; }
      function sampleVec(key, annual){
        const vec = S[key];
        if (!Array.isArray(vec) || vec.length !== GRID.length || !GRID.length) return 0;
        if (annual <= GRID[0]) return clamp(vec[0]);
        if (annual >= GRID[GRID.length-1]) return clamp(vec[vec.length-1]);
        let lo=0, hi=GRID.length-1;
        while (hi-lo>1){ const mid=(lo+hi)>>1; (GRID[mid] <= annual) ? (lo=mid) : (hi=mid); }
        const t = (annual - GRID[lo]) / Math.max(1, GRID[hi]-GRID[lo]);
        return clamp(vec[lo] + t*(vec[hi]-vec[lo]));
      }    
      // ------- helpers to sample series at any annual income -------
      function linearSample(points, xKey, yKey, x){
        if (!Array.isArray(points) || points.length === 0) return 0;
        const pts = points.slice().sort((a,b)=> (a[xKey]-b[xKey]));
        if (x <= pts[0][xKey]) return Number(pts[0][yKey]) || 0;
        if (x >= pts[pts.length-1][xKey]) return Number(pts[pts.length-1][yKey]) || 0;
        for (let i=1;i<pts.length;i++){
          const x0 = pts[i-1][xKey], y0 = Number(pts[i-1][yKey])||0;
          const x1 = pts[i][xKey],   y1 = Number(pts[i][yKey])||0;
          if (x >= x0 && x <= x1){
            const t = (x - x0) / (x1 - x0 || 1);
            return y0 + t*(y1 - y0);
          }
        }
        return 0;
      }
    
        function monthlyHealthcare(annual){
          if (Array.isArray(S.healthcare_yearly)) return Math.max(0, -sampleVec('healthcare_yearly', annual)) / 12;
          const s = budget._series?.healthcare?.points || []; // monthly legacy
          return linearSample(s, 'annual', 'monthly', annual);
        }
        
        function monthlyEdChoice(annual){
          if (Array.isArray(S.edchoice_yearly)) return Math.max(0, -sampleVec('edchoice_yearly', annual)) / 12;
          const s = budget._series?.edchoice?.points || [];
          const annualDue = linearSample(s, 'annual', 'annualDue', annual);
          return (annualDue||0)/12;
        }
        
          function monthlyChildcare(annual){
            const s = budget._series?.childcare?.points || [];
            // childcare points use 'income' key and annual out-of-pocket in 'outOfPocket'
            const annualOOP = linearSample(s, 'income', 'outOfPocket', annual);
            return (annualOOP||0)/12;
          }

 
        // (also improve SNAP to use yearly vector if present)
        function monthlySNAP(annual){
          if (Array.isArray(S.snap_yearly)) return Math.max(0, sampleVec('snap_yearly', annual)) / 12;
          const s = budget._series?.snap?.points || [];
          return Math.max(0, linearSample(s, 'annual', 'monthlyBenefit', annual));
        }

         // Utilities (PIPP) — cost; prefer yearly vector (stored negative), else 0
        function monthlyUtilities(annual){
          if (Array.isArray(S.pipp_yearly)) return Math.max(0, -sampleVec('pipp_yearly', annual)) / 12;
          const s = budget._series?.pipp?.points || []; // if you ever add monthly points, support them here
          return 0; // (no legacy format in your current code)
        }
        
        // Student loans (IDR) — cost; prefer chosen plan vector (stored negative)
        function monthlyIDR(annual){
          const key = (budget.idrPlan === 'ICR' && Array.isArray(S.idr_icr_yearly)) ? 'idr_icr_yearly'
                    : (Array.isArray(S.idr_ibr_yearly) ? 'idr_ibr_yearly' : null);
          return key ? Math.max(0, -sampleVec(key, annual)) / 12 : 0;
        }
        
        // FRL — benefit; prefer yearly vector (positive), else legacy points (monthlyBenefit)
        function monthlyFRL(annual){
          if (Array.isArray(S.frl_yearly)) return Math.max(0, sampleVec('frl_yearly', annual)) / 12;
          const s = budget._series?.frl?.points || [];
          const m = linearSample(s, 'annual', 'monthlyBenefit', annual);
          return Math.max(0, m);
        }
        
        // SSI/SSDI — benefit; prefer combined yearly vector (positive), else sum the two
        function monthlySSI(annual){
          if (Array.isArray(S.ssi_ssdi_yearly)) return Math.max(0, sampleVec('ssi_ssdi_yearly', annual)) / 12;
          const ssdi = Array.isArray(S.ssdi_yearly) ? sampleVec('ssdi_yearly', annual) : 0;
          const ssi  = Array.isArray(S.ssi_yearly)  ? sampleVec('ssi_yearly',  annual) : 0;
          return Math.max(0, (ssdi + ssi)) / 12;
        }
        
        // WIC — benefit; prefer yearly vector (positive), else legacy points (monthlyBenefit)
        function monthlyWIC(annual){
          if (Array.isArray(S.wic_yearly)) return Math.max(0, sampleVec('wic_yearly', annual)) / 12;
          const s = budget._series?.wic?.points || [];
          const m = linearSample(s, 'annual', 'monthlyBenefit', annual);
          return Math.max(0, m);
        }
        
    
      // (placeholder) Taxes — return 0 for now, wire later
      function monthlyTaxesNet(annual){
        // TODO: replace with FICA + federal + state – credits, etc.
        return 0;
      }
    
        function computeNet(annual){
          const parts = {
            hc:    chk.hc.checked    ? monthlyHealthcare(annual) : 0,
            cc:    chk.cc.checked    ? monthlyChildcare(annual)  : 0,
            ed:    chk.ed.checked    ? monthlyEdChoice(annual)   : 0,
            utils: chk.utils.checked ? monthlyUtilities(annual)  : 0,
            idr:   chk.idr.checked   ? monthlyIDR(annual)        : 0,
            snap:  chk.snap.checked  ? monthlySNAP(annual)       : 0,
            frl:   chk.frl.checked   ? monthlyFRL(annual)        : 0,
            ssi:   chk.ssi.checked   ? monthlySSI(annual)        : 0,
            wic:   chk.wic.checked   ? monthlyWIC(annual)        : 0,
            tax:   chk.tax.checked   ? monthlyTaxesNet(annual)   : 0
          };
          // Net OOP (can't be negative): costs − benefits
          const costs    = parts.hc + parts.cc + parts.ed + parts.utils + parts.idr + parts.tax;
          const benefits = parts.snap + parts.frl + parts.ssi + parts.wic;
          const net = Math.max(0, costs - benefits);
          return { net, parts };
        }

      // ------- build curve + table -------
      const steps = 30;
      const curve = [];
      let yMax = 100;
    
      for (let i=0;i<=steps;i++){
        const annual = (A_MAX * i) / steps;
        const { net } = computeNet(annual);
        curve.push({ x: annual, y: net });
        if (net > yMax) yMax = net;
      }
      if (yMax < 100) yMax = 100;
    
      const tableRows = [];
      for (let annual=0; annual<=A_MAX; annual+=TABLE_STEP){
        const { net, parts } = computeNet(annual);
        tableRows.push({ annual, net, ...parts });
      }
    
      // ------- draw SVG with axis titles -------
      const W = 720, H = 260, P = 40;
      const innerW = W - P*2, innerH = H - P*2;
      const xPix = x => P + (x / A_MAX) * innerW;
      const yPix = y => H - P - (y / yMax) * innerH;
    
      function draw(){
        svg.innerHTML = '';
    
        const axisX = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisX.setAttribute('x1', P); axisX.setAttribute('y1', H-P);
        axisX.setAttribute('x2', W-P); axisX.setAttribute('y2', H-P);
        axisX.setAttribute('stroke','currentColor');
    
        const axisY = document.createElementNS('http://www.w3.org/2000/svg','line');
        axisY.setAttribute('x1', P); axisY.setAttribute('y1', P);
        axisY.setAttribute('x2', P); axisY.setAttribute('y2', H-P);
        axisY.setAttribute('stroke','currentColor');
    
        let d = '';
        for (let i=0;i<curve.length;i++){
          const X = xPix(curve[i].x), Y = yPix(curve[i].y);
          d += (i===0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`);
        }
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','currentColor');
        path.setAttribute('stroke-width','2');

        // X ticks every $20k
        for (let x = 0; x <= A_MAX; x += 20000) {
          const X = xPix(x);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', X); t.setAttribute('y1', H-P);
          t.setAttribute('x2', X); t.setAttribute('y2', H-P+5);
          t.setAttribute('stroke', 'currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', X - 14); label.setAttribute('y', H - P + 18);
          label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
          label.textContent = `$${(x/1000).toFixed(0)}k`;
          svg.append(t, label);
        }
        
        // Y ticks every $10k (or $20k if tall)
        const yStep = (yMax <= 50_000 ? 10_000 : 20_000);
        for (let y = 0; y <= yMax; y += yStep) {
          const Y = yPix(y);
          const t = document.createElementNS('http://www.w3.org/2000/svg','line');
          t.setAttribute('x1', P-5); t.setAttribute('y1', Y);
          t.setAttribute('x2', P);   t.setAttribute('y2', Y);
          t.setAttribute('stroke', 'currentColor');
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', 6); label.setAttribute('y', Y - 2);
          label.setAttribute('font-size','10'); label.setAttribute('fill','currentColor');
          label.textContent = `$${y.toLocaleString()}`;
          svg.append(t, label);
        }

    
        const marker = document.createElementNS('http://www.w3.org/2000/svg','circle');
        marker.setAttribute('id','finalMarker');
        marker.setAttribute('r','4'); marker.setAttribute('fill','currentColor');
    
        // axis endpoint labels
        const yLab = document.createElementNS('http://www.w3.org/2000/svg','text');
        yLab.setAttribute('x', P+4); yLab.setAttribute('y', yPix(yMax)-6);
        yLab.setAttribute('font-size','10'); yLab.setAttribute('fill','currentColor');
        yLab.textContent = '$' + Math.round(yMax).toLocaleString();
    
        const xLab = document.createElementNS('http://www.w3.org/2000/svg','text');
        xLab.setAttribute('x', xPix(A_MAX)-44); xLab.setAttribute('y', H-P+14);
        xLab.setAttribute('font-size','10'); xLab.setAttribute('fill','currentColor');
        xLab.textContent = '$' + A_MAX.toLocaleString();
    
        // axis titles
        const xTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        xTitle.setAttribute('x', W/2); xTitle.setAttribute('y', H-6);
        xTitle.setAttribute('text-anchor','middle');
        xTitle.setAttribute('font-size','12'); xTitle.setAttribute('fill','currentColor');
        xTitle.textContent = 'Annual salary';
    
        const yTitle = document.createElementNS('http://www.w3.org/2000/svg','text');
        yTitle.setAttribute('x', 16); yTitle.setAttribute('y', H/2);
        yTitle.setAttribute('text-anchor','middle');
        yTitle.setAttribute('font-size','12'); yTitle.setAttribute('fill','currentColor');
        yTitle.setAttribute('transform', `rotate(-90 16 ${H/2})`);
        yTitle.textContent = 'Net monthly out-of-pocket (modeled)';
    
        svg.append(axisX, axisY, path, marker, yLab, xLab, xTitle, yTitle);
      }
    
      function fmt(n){ return '$' + Math.max(0, Math.round(n)).toLocaleString(); }
    

        function partsLine(p){
          const items = [];
          if (chk.hc?.checked)    items.push(`HC: ${fmt(p.hc)}`);
          if (chk.cc?.checked)    items.push(`CC: ${fmt(p.cc)}`);
          if (chk.ed?.checked)    items.push(`Ed: ${fmt(p.ed)}`);
          if (chk.utils?.checked) items.push(`Utils: ${fmt(p.utils)}`);
          if (chk.idr?.checked)   items.push(`Loans: ${fmt(p.idr)}`);
          if (chk.snap?.checked)  items.push(`SNAP: -${fmt(p.snap)}`);     // benefit => shown with “-”
          if (chk.frl?.checked)   items.push(`FRL: -${fmt(p.frl)}`);       // benefit
          if (chk.ssi?.checked)   items.push(`SSI/SSDI: -${fmt(p.ssi)}`);  // benefit
          if (chk.wic?.checked)   items.push(`WIC: -${fmt(p.wic)}`);       // benefit
          if (chk.tax?.checked)   items.push(`Tax: ${fmt(p.tax)}`);
          return items.length ? `Breakdown — ${items.join(' | ')}` : '—';
        }
      function moveMarker(annual){
        const marker = document.getElementById('finalMarker');
        const a = Math.max(0, Math.min(A_MAX, annual));
        const { net, parts } = computeNet(a);
        marker.setAttribute('cx', xPix(a));
        marker.setAttribute('cy', yPix(net));
        netEl.textContent = fmt(net);
        noteEl.textContent = partsLine(parts);
      }
    
      function renderTable(rows){
        let html = `<table style="width:100%; border-collapse:collapse;">
          <thead><tr>
            <th style="text-align:left; padding:6px;">Annual income</th>
            <th style="text-align:left; padding:6px;">Healthcare (mo)</th>
            <th style="text-align:left; padding:6px;">Childcare (mo)</th>
            <th style="text-align:left; padding:6px;">EdChoice (mo)</th>
            <th style="text-align:left; padding:6px;">Utilities (mo)</th>
            <th style="text-align:left; padding:6px;">Student loans (mo)</th>
            <th style="text-align:left; padding:6px;">SNAP (mo)</th>
            <th style="text-align:left; padding:6px;">FRL (mo)</th>
            <th style="text-align:left; padding:6px;">SSI/SSDI (mo)</th>
            <th style="text-align:left; padding:6px;">WIC (mo)</th>
            <th style="text-align:left; padding:6px;">Net monthly</th>
          </tr></thead><tbody>`;
            for (const r of rows){
              html += `<tr>
                <td style="padding:6px;">$${r.annual.toLocaleString()}</td>
                <td style="padding:6px;">$${Math.round(r.hc).toLocaleString()}</td>
                <td style="padding:6px;">$${Math.round(r.cc).toLocaleString()}</td>
                <td style="padding:6px;">$${Math.round(r.ed).toLocaleString()}</td>
                <td style="padding:6px;">$${Math.round(r.utils).toLocaleString()}</td>
                <td style="padding:6px;">$${Math.round(r.idr).toLocaleString()}</td>
                <td style="padding:6px;">$${Math.round(r.snap).toLocaleString()}</td>
                <td style="padding:6px;">$${Math.round(r.frl).toLocaleString()}</td>
                <td style="padding:6px;">$${Math.round(r.ssi).toLocaleString()}</td>
                <td style="padding:6px;">$${Math.round(r.wic).toLocaleString()}</td>
                <td style="padding:6px;"><strong>$${Math.round(r.net).toLocaleString()}</strong></td>
              </tr>`;
            }

        html += `</tbody></table>`;
        wrap.innerHTML = html;
      }
    
      draw();
      moveMarker(0);
      renderTable(tableRows);
    
      // live updates
      incomeEl.addEventListener('input', () => moveMarker(Number(incomeEl.value)||0));
      [chk.hc, chk.cc, chk.ed, chk.utils, chk.idr, chk.snap, chk.frl, chk.ssi, chk.wic, chk.tax].forEach(c=>{
        c.addEventListener('change', () => {
          // rebuild curve and table with new toggles
          for (let i=0;i<=steps;i++){
            const annual = (A_MAX * i) / steps;
            const { net } = computeNet(annual);
            curve[i].y = net;
          }
          // rescan ymax
          yMax = Math.max(100, ...curve.map(p=>p.y));
          draw();
          moveMarker(Number(incomeEl.value)||0);
    
          // rebuild table
          for (let i=0, a=0; a<=A_MAX; a+=TABLE_STEP, i++){
            const r = computeNet(a);
            tableRows[i] = { annual:a, net:r.net, ...r.parts };
          }
          renderTable(tableRows);
        });
      });
    
      document.getElementById('finalDone').addEventListener('click', () => {
        alert('Roll-up complete.');
      }, { once:true });
    }







    // Helper to render each row with an Edit link
    function row(label, val, editFn) {
        const amount = (Number(val) || 0).toFixed(2);
        const id = `edit-${label}`;
        // register a one-off listener after insert by using a data attribute we catch above
        return `
            <div>
                <strong>${label}:</strong> $${amount}
                &nbsp; <span class="edit-link" data-target="${label}">Edit</span>
            </div>
        `;
      }
    }

    // Boot
    console.log("init")
    //startApp();
  </script>
</body>
</html> 
